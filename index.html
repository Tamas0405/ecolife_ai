<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>EcoLife AI ‚Äì 2D t√©rk√©p, radar, okos figyelmeztet√©s</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root {
      --bg: linear-gradient(120deg,#e9ffe7 0%,#cbf3d2 100%);
      --fg: #21321b;
      --panel: #fff;
    }
    body {background:var(--bg);font-family:'Montserrat',sans-serif;margin:0;color:var(--fg);min-height:100vh;transition:.4s;}
    .container {max-width:560px;margin:10px auto 0 auto;padding:10px 0 16px 0;background:var(--panel);
      border-radius:22px;box-shadow:0 8px 32px rgba(48,89,64,0.17);}
    h1 {text-align:center;font-size:2.1rem;color:#247a36;margin:6px 0 16px 0;}
    .ai-suggestion {background:#e3ffe7;border-left:5px solid #58d172;padding:18px 14px 18px 24px;
      border-radius:16px;font-size:1.14rem;margin-bottom:18px;display:flex;align-items:center;gap:10px;
      box-shadow:0 2px 8px rgba(85,180,120,0.08);}
    .ai-suggestion svg {flex-shrink:0;width:26px;height:26px;}
    .section-title {font-size:1.09rem;color:#28853b;margin:20px 0 11px 8px;font-weight:700;}
    .eco-cards {display:flex;gap:12px;flex-wrap:wrap;margin-bottom:9px;}
    .eco-card {flex:1 1 142px;background:linear-gradient(115deg,#e8f5e9 60%,#d2ffef 100%);
      border-radius:14px;box-shadow:0 2px 8px rgba(63,155,120,0.09);padding:13px 9px 9px 13px;
      display:flex;flex-direction:column;align-items:flex-start;min-width:116px;max-width:210px;margin-bottom:7px;}
    .eco-card strong {font-size:1.06rem;color:#246c38;}
    .eco-card small,.eco-card span {color:#557b61;font-size:.97rem;}
    .eco-icon {font-size:1.11rem;margin-right:7px;}
    .badges {display:flex;gap:7px;flex-wrap:wrap;margin-top:7px;}
    .badge {background:#ebffe8;border-radius:8px;padding:3px 7px;font-size:.97em;}
    .badge.pm10 {background:#f5ffe1;}
    .badge.no2 {background:#f7f3ff;}
    .badge.o3 {background:#e2f6ff;}
    .badge.co {background:#fff4e2;}
    .challenge-row {display:flex;align-items:center;justify-content:space-between;gap:7px;}
    .challenge-desc {font-size:1.02rem;color:#187441;font-weight:500;}
    .challenge-btn {background:#52c77b;color:#fff;border:none;border-radius:10px;padding:7px 15px;
      font-size:.99rem;font-weight:600;cursor:pointer;transition:background .2s;}
    .challenge-btn:hover {background:#329758;}
    .map-header {display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
    .map-btn {background:#d9f5dd;border:none;color:#187a4c;font-weight:700;
      border-radius:9px;padding:5px 16px;font-size:1.08em;margin-right:8px;cursor:pointer;}
    .map-btn.selected {background:#33ba72;color:#fff;}
    .street-btn {background:#f5ffe2;color:#187a4c;border-radius:10px;font-weight:600;
      padding:4px 16px;font-size:1em;margin-right:2px;cursor:pointer;}
    .street-btn:hover {background:#e4ffe3;}
    .darkmode-btn {background:#253e28;color:#d5ffd6;padding:4px 12px;border:none;border-radius:9px;cursor:pointer;float:right;}
    .map-box {width:100%;height:220px;min-height:155px;max-height:350px;position:relative;
      border-radius:15px;overflow:hidden;box-shadow:0 2px 12px #d6e6d9;}
    #leafletmap {width:100%;height:100%;border-radius:15px;}
    .poi-legend {margin:8px 0 0 0;font-size:1.05em;display:flex;flex-wrap:wrap;gap:12px;justify-content:left;}
    .poi-icon {margin-right:2px;font-size:1.18em;}
    .footer {text-align:center;color:#aad2bb;margin:21px 0 7px 0;font-size:.97rem;}
    .forecast-panel {display:flex;gap:12px;margin:10px 0 0 6px;}
    .forecast-day {background:#e7fbf6;padding:9px 12px;border-radius:13px;box-shadow:0 1px 6px #b6e6d5;
      text-align:center;min-width:72px;}
    .forecast-day .day {font-weight:700;color:#167c44;}
    .forecast-day .icon {font-size:1.5em;}
    .forecast-day .temp {font-size:1.11em;}
    .modal-bg {position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(48,48,48,0.18);display:none;align-items:center;justify-content:center;}
    .modal-card {background:#fff;border-radius:22px;box-shadow:0 4px 32px #b2c0b3;padding:26px 18px;max-width:340px;text-align:center;}
    .modal-card h3 {margin:0 0 7px 0;color:#c0132e;font-size:1.21em;}
    .modal-card .modal-msg {font-size:1.06em;margin-bottom:12px;}
    .modal-card .modal-ok {margin-top:9px;padding:8px 28px;border:none;background:#248645;color:#fff;font-size:1.04em;border-radius:12px;cursor:pointer;}
    body.dark {
      --bg: linear-gradient(120deg,#222c24 0%,#1e2730 100%);
      --fg: #e3ffe7;
      --panel: #203628;
    }
    body.dark .eco-card, body.dark .forecast-day, body.dark .modal-card {background:#223929!important;color:#a5ffd9;}
    body.dark h1 {color:#82fcab;}
    body.dark .ai-suggestion {background:#19361d;color:#88ffaa;}
    body.dark .footer {color:#427759;}
    body.dark .map-btn, body.dark .street-btn, body.dark .darkmode-btn {background:#2d4936!important;color:#b1ffde;}
    @media (max-width:700px){.container{max-width:100vw;} .eco-cards{flex-direction:column;}
      .map-box{height:190px;min-height:124px;}}
    @media (max-width:430px){.container{padding:1px;} .eco-card{min-width:90px;} h1{font-size:1.25em;}}
  </style>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <div class="container">
    <button class="darkmode-btn" id="darkmodeBtn" title="S√∂t√©t m√≥d v√°lt√°s üåô">üåô</button>
    <h1>üå± EcoLife AI</h1>
    <div id="ai-suggestion" class="ai-suggestion">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 16v-4M12 8h.01" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span><strong>AI aj√°nlatod t√∂lt≈ëdik‚Ä¶</strong></span>
    </div>
    <div id="last-refresh" style="text-align:right;color:#28853b;font-size:.98em;margin-bottom:6px;"></div>

    <div class="section-title">üå§ √âl≈ë √ñko-adatok</div>
    <div class="eco-cards">
      <div class="eco-card"><span class="eco-icon">üèôÔ∏è</span><strong>Hely:</strong>
        <small id="city">Bet√∂lt√©s‚Ä¶</small></div>
      <div class="eco-card"><span class="eco-icon">üå°Ô∏è</span><strong>H≈ëm√©rs√©klet:</strong>
        <small id="weather">Bet√∂lt√©s‚Ä¶</small></div>
      <div class="eco-card"><span class="eco-icon">üåû</span><strong>UV-index:</strong>
        <small id="uv">Bet√∂lt√©s‚Ä¶</small></div>
      <div class="eco-card"><span class="eco-icon">üå¨Ô∏è</span><strong>Leveg≈ëmin≈ës√©g:</strong>
        <small id="air-quality">Bet√∂lt√©s‚Ä¶</small>
        <div class="badges" id="air-components"></div></div>
      <div class="eco-card"><span class="eco-icon">üå´Ô∏è</span><strong>L√°t√°si viszony, p√°ratartalom, sz√©l:</strong>
        <small id="atm-panel">Bet√∂lt√©s‚Ä¶</small></div>
      <div class="eco-card"><span class="eco-icon">üå∏</span><strong>Pollen el≈ërejelz√©s:</strong>
        <small id="pollen-panel">Bet√∂lt√©s‚Ä¶</small></div>
      <div class="eco-card" id="weather-warning-card"><span class="eco-icon">‚õàÔ∏è</span>
        <strong>Vesz√©lyjelz√©s:</strong>
        <div id="weather-warning-details"><small>Bet√∂lt√©s‚Ä¶</small></div></div>
      <div class="eco-card"><span class="eco-icon">üèÜ</span>
        <strong>Heti √∂ko-kih√≠v√°sod:</strong>
        <div class="challenge-row">
          <span class="challenge-desc">Bring√°zz legal√°bb 10 km-t!</span>
          <button class="challenge-btn" onclick="completeChallenge()">Teljes√≠tettem</button>
        </div>
        <small id="challenge-status">0 teljes√≠t√©s</small>
      </div>
    </div>
    <div class="section-title">üó∫Ô∏è √âl≈ë 2D t√©rk√©p & POI / Utcak√©p</div>
    <div class="map-header">
      <button id="btn2d" class="map-btn selected">2D t√©rk√©p</button>
      <button id="btnstreet" class="street-btn"><span style="font-size:1.2em;">üì∑</span> Utcak√©p</button>
    </div>
    <div class="map-box"><div id="leafletmap"></div></div>
    <div id="traffic-info" style="text-align:center; margin:10px 0; color:#1e6b1a; font-size:1.08em;"></div>
    <div class="poi-legend" id="poi-legend"></div>
    <div class="forecast-panel" id="forecast-panel"></div>
    <div class="section-title">üìÖ Kiemelt esem√©nyek, rendezv√©nyek a k√∂zelben</div>
    <div id="event-list"></div>
    <!-- Statikus OMSZ radar GIF + csak 1 gomb! -->
    <div id="omsz-radar" style="margin:18px 0 0 0;text-align:center;">
  <img src="https://www.met.hu/idojaras/radar/radar_animation.gif"
       alt="OMSZ radar"
       style="max-width:98%;border-radius:16px;box-shadow:0 2px 18px #8888;">
  <br>
  <span style="font-size:.98em;color:#237a36;">
    OMSZ hivatalos radar (statikus k√©p, 15p friss√≠t√©s)
  </span>
  <div style="margin-top:12px;">
    <button onclick="window.open('https://www.met.hu/idojaras/aktualis_idojaras/radar/', '_blank', 'width=950,height=750')"
      style="background:#e8ffeb;color:#247a36;padding:7px 19px;border-radius:9px;border:none;cursor:pointer;font-size:1.06em;">
      OMSZ Radar (val√≥sidej≈±, teljes oldal)
    </button>
  </div>
</div>

    <div class="footer">
      &copy; 2025 EcoLife AI | <span style="color:#7bbd97">Mobil-optimaliz√°lt, radar+esem√©nyek, el≈ërejelz√©s, s√∂t√©t m√≥d</span>
    </div>
    <!-- Okosfigyelmeztet√©s MODAL -->
    <div class="modal-bg" id="alertModal">
      <div class="modal-card">
        <h3 id="modalTitle">Figyelem!</h3>
        <div class="modal-msg" id="modalMsg">Valamilyen vesz√©ly!</div>
        <button class="modal-ok" onclick="document.getElementById('alertModal').style.display='none'">OK</button>
      </div>
    </div>
  </div>
<script>
// --- BKK Budapest buszmeg√°ll√≥ √©l≈ë j√°rat inf√≥ lek√©r√©se ---
async function showBkkBusArrivals(stopId, marker) {
  try {
    const res = await fetch(`https://futar.bkk.hu/api/query/v1/ws/stop-arrivals?stopId=${stopId}`);
    const data = await res.json();
    if (!data.data || !data.data.arrivals.length) {
      marker.bindPopup("<b>Nincs el√©rhet≈ë j√°rat inform√°ci√≥.</b>").openPopup();
      return;
    }
    let info = data.data.arrivals.map(arr =>
      `<b>${arr.routeShortName}</b> ‚Üí ${arr.headsign} (${Math.round((arr.departureTimestamp*1000 - Date.now())/60000)} perc m√∫lva)`
    ).join('<br>');
    marker.bindPopup(`<b>√âl≈ë j√°ratok:</b><br>${info}`).openPopup();
  } catch (e) {
    marker.bindPopup("<b>Nem siker√ºlt lek√©rni az √©l≈ë j√°ratokat.</b>").openPopup();
  }
}

// --- M√ºnchen MVV √©l≈ë indul√°sok: meg√°ll√≥ n√©vr≈ël keres, √∂sszes t√∂megk√∂zleked√©si j√°ratot, sz√≠nes ikonnal ---
async function showMunichStopDepartures(stopName, marker) {
  try {
    // 1. Meg√°ll√≥ keres√©se a n√©v alapj√°n (legt√∂bb OSM POI-ban van name)
    const res = await fetch(`https://api.mvv.app/api/locate?query=${encodeURIComponent(stopName)}`);
    const locations = await res.json();
    if (!locations.length) {
      marker.bindPopup(`<b>Nincs ilyen meg√°ll√≥ az MVV rendszer√©ben!</b>`).openPopup();
      return;
    }
    let stopId = locations[0].id;

    // 2. √âl≈ë indul√°sok lek√©r√©se
    const depRes = await fetch(`https://api.mvv.app/api/departure?station=${stopId}`);
    const depData = await depRes.json();
    if (!depData.departures || !depData.departures.length) {
      marker.bindPopup("<b>Nincs indul√°s az elk√∂vetkez≈ë 30 percben!</b>").openPopup();
      return;
    }

    // 3. T√≠pus szerinti ikonok (busz, tram, metro, S-Bahn, vas√∫t, stb.)
    function getTransportIcon(type, label) {
      if (/^U\d+/.test(label))   return "üöá"; // metr√≥
      if (/^S\d+/.test(label))   return "üöà"; // S-Bahn (el≈ëv√°rosi vonat)
      if (/^(RB|RE|IC|EC|ICE)/.test(label)) return "üöÑ"; // region√°lis v. gyorsvas√∫t
      if (/^(N?\d{1,3})$/.test(label)) return "üöå"; // busz (N=√©jszakai, pl. N40)
      if (/^(T|Tram|\d{1,2})/.test(label)) return "üöã"; // villamos
      return "üöç"; // egy√©b
    }

    let html = depData.departures.slice(0,14).map(dep =>
      `<span style="font-size:1.3em">${getTransportIcon(dep.product, dep.label)}</span> 
      <b>${dep.label}</b> ‚Üí <span style="color:#1a8fba">${dep.destination}</span>
      <span style="color:#5c9d33;">(${dep.departureTimeMinutes} perc m√∫lva)</span>`
    ).join('<br>');

    marker.bindPopup(
      `<div style="min-width:210px">
        <b>√âl≈ë indul√°sok (${stopName}):</b><br>
        ${html}
        <br><a href="https://efa.mvv-muenchen.de/index.html#trip@enquiry" target="_blank" style="font-size:.93em;color:#2486cc;">MVV Fahrplanauskunft</a>
      </div>`
    ).openPopup();

  } catch (e) {
    marker.bindPopup("<b>Nem siker√ºlt lek√©rni az √©l≈ë menetrendet.</b>").openPopup();
  }
}


     // --- √ötinform.hu nyilv√°nos RSS olvas√°sa ---
    async function getUtinform() {
  try {
    const proxy = "https://api.allorigins.win/get?url=";
    const url = "https://www.utinform.hu/rss/utinformhirek.rss";
    const res = await fetch(proxy + encodeURIComponent(url));
    const data = await res.json();
    const parser = new window.DOMParser();
    const xml = parser.parseFromString(data.contents, "text/xml");
    const items = xml.querySelectorAll("item");
    let msgList = [];
    items.forEach(item => {
      const title = item.querySelector("title")?.textContent || "";
      const desc = item.querySelector("description")?.textContent || "";
      msgList.push(`<b>${title}:</b> ${desc}`);
    });
    return msgList.length ? msgList.slice(0, 2).join('<hr>') : "Nincs jelent≈ës esem√©ny az orsz√°gos f≈ëutakon.";
  } catch (e) {
    return "Az √∫tinform adatai most nem √©rhet≈ëk el.";
  }
}

const OPENWEATHER_API_KEY = "6a8514078d38de2a2c4e4e1642fede5c";
const poiTypes = [
  {icon:"üöå", key:"bus", val:"yes", label:"Buszmeg√°ll√≥"},
  {icon:"üöã", key:"tram", val:"yes", label:"Villamosmeg√°ll√≥"},
  {icon:"üöá", key:"subway", val:"yes", label:"Metr√≥√°llom√°s"},
  {icon:"üöâ", key:"train", val:"yes", label:"Vas√∫t√°llom√°s"},
  {icon:"üöè", key:"public_transport", val:"platform", label:"K√∂z√∂ss√©gi meg√°ll√≥"},
  {icon:"üõí", key:"shop", val:"supermarket", label:"√âlelmiszer"},
  {icon:"üè™", key:"shop", val:"electronics", label:"M≈±szaki"},
  {icon:"‚òï", key:"amenity", val:"cafe", label:"K√°v√©z√≥"},
  {icon:"‚öΩ", key:"leisure", val:"pitch", label:"Sport"},
  {icon:"‚õΩ", key:"amenity", val:"fuel", label:"√územanyag"},
  {icon:"üÖøÔ∏è", key:"amenity", val:"parking", label:"Parkol√≥"},
  {icon:"üîã", key:"amenity", val:"charging_station", label:"T√∂lt≈ë"},
];
document.getElementById("poi-legend").innerHTML = poiTypes.map(t=>`<span class="poi-icon">${t.icon}</span>${t.label}`).join("  ");
const demoPollen = [
  { city: "Budapest", ragweed: "magas", grass: "k√∂zepes", birch: "alacsony" },
  { city: "Sz√©kesfeh√©rv√°r", ragweed: "k√∂zepes", grass: "alacsony", birch: "nincs" },
  { city: "Debrecen", ragweed: "alacsony", grass: "alacsony", birch: "alacsony" },
  { city: "Miskolc", ragweed: "k√∂zepes", grass: "k√∂zepes", birch: "alacsony" }
];
function getDemoPollen(cityName) {
  const found = demoPollen.find(x => cityName && cityName.includes(x.city));
  return found || demoPollen[0];
}
function completeChallenge() {
  let count = Number(localStorage.getItem("eco_challenge") || 0) + 1;
  localStorage.setItem("eco_challenge", count);
  document.getElementById('challenge-status').textContent = count + " teljes√≠t√©s";
}
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('challenge-status').textContent =
    (localStorage.getItem("eco_challenge") || 0) + " teljes√≠t√©s";
});
function getPosition() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) reject("Nincs geolok√°ci√≥!");
    navigator.geolocation.getCurrentPosition(
      pos => resolve(pos.coords),
      err => reject(err)
    );
  });
}
async function getWeather(lat, lon) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=uv_index,visibility,relative_humidity_2m,windspeed_10m,precipitation_probability,precipitation,snowfall,weathercode,temperature_2m&forecast_days=3&timezone=auto`;
  const res = await fetch(url);
  if (!res.ok) throw "Nem siker√ºlt lek√©rni az id≈ëj√°r√°st!";
  return await res.json();
}
async function getAirQuality(lat, lon) {
  const url = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}`;
  const res = await fetch(url);
  if (!res.ok) return null;
  const data = await res.json();
  if (!data.list || !data.list.length) return null;
  return data.list[0];
}
async function getCityName(lat, lon) {
  const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=hu`;
  const res = await fetch(url);
  if (!res.ok) return "";
  const data = await res.json();
  return data.address.village || data.address.town || data.address.city || data.address.hamlet || data.display_name;
}
async function getWeatherWarning(cityName) {
  try {
    const url = "https://api.met.hu/idojaras/veszelyjelzes/megye.json";
    const res = await fetch(url);
    const data = await res.json();
    const countyNames = ["B√°cs-Kiskun","Baranya","B√©k√©s","Borsod-Aba√∫j-Zempl√©n","Csongr√°d-Csan√°d","Fej√©r","Gy≈ër-Moson-Sopron","Hajd√∫-Bihar","Heves","J√°sz-Nagykun-Szolnok","Kom√°rom-Esztergom","N√≥gr√°d","Pest","Somogy","Szabolcs-Szatm√°r-Bereg","Tolna","Vas","Veszpr√©m","Zala","Budapest"];
    let county = "";
    for (const name of countyNames) {
      if (cityName && cityName.includes(name)) { county = name; break; }
    }
    if (!county || !data.megye) return { warnings: [], county: "" };
    const c = data.megye.find(x => x.nev === county);
    if (!c || !c.fok || !c.fok.length) return { warnings: [], county };
    let warnings = c.fok.filter(x => x.szint > 0);
    return { warnings, county };
  } catch (e) { return { warnings: [], county: "" }; }
}

const szintTeendo = {
  1: "Figyelmeztet√©s: k√∂vesd az OMSZ tan√°csait.",
  2: "Narancs ‚Äì Fokozott vesz√©ly: ne tart√≥zkodj szabadban!",
  3: "Piros ‚Äì Extr√©m vesz√©ly: csak √©letv√©delmi okb√≥l menj ki, v√©dj mindent, amit tudsz!",
};

function warningIconAndText(jelzes) {
  if (!jelzes) return {icon:"",text:""};
  let txt = jelzes.toLowerCase();
  if (txt.includes("zivatar")) return {icon:"üå©Ô∏è", text:"Zivatar"};
  if (txt.includes("h≈ës√©g")) return {icon:"‚òÄÔ∏è", text:"H≈ës√©g"};
  if (txt.includes("sz√©l")) return {icon:"üí®", text:"Sz√©l"};
  if (txt.includes("j√©ges≈ë")) return {icon:"üßä", text:"J√©ges≈ë"};
  if (txt.includes("h√≥")) return {icon:"üå®Ô∏è", text:"H√≥"};
  if (txt.includes("k√∂d")) return {icon:"üå´Ô∏è", text:"K√∂d"};
  if (txt.includes("es≈ë")) return {icon:"üåßÔ∏è", text:"Es≈ë"};
  return {icon:"‚ö†Ô∏è", text:jelzes};
}
function warningLevelClass(szint) {
  if (szint == 3) return "eco-card warn-red";
  if (szint == 2) return "eco-card warn-orange";
  if (szint == 1) return "eco-card warn-yellow";
  return "eco-card warn-none";
}
function formatOszTime(t) {
  if (!t) return "";
  let d = t.split("T");
  if (!d[0] || !d[1]) return "";
  let dm = d[0].slice(5).replace("-",".") + ". " + d[1].slice(0,5);
  return dm;
}
async function fetchPOI(lat, lon) {
  const rad = 900;
  let parts = poiTypes.map(t => `node["${t.key}"="${t.val}"](around:${rad},${lat},${lon});`).join("");
  const query = `[out:json];(${parts});out body;`;
  try {
    const res = await fetch("https://overpass-api.de/api/interpreter", {method:"POST",body:query});
    const data = await res.json();
    return data.elements || [];
  } catch(e) {
    return [
      {lat:lat+0.0013,lon:lon-0.0017,tags:{shop:"supermarket"},id:1},
      {lat:lat-0.0009,lon:lon+0.0022,tags:{amenity:"cafe"},id:2},
      {lat:lat+0.0007,lon:lon+0.001,tags:{amenity:"charging_station"},id:3},
      {lat:lat-0.0005,lon:lon-0.0006,tags:{public_transport:"platform"},id:4}
    ];
  }
}
function generateAISuggestion(weather, uv, air, atm, trafficMsg) {
  let msg = "";

  // --- Id≈ëj√°r√°s (k√∂zelj√∂v≈ë, 0-60 perc) ---
  if (weather.hourly && weather.hourly.weathercode && weather.hourly.time) {
    let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
    let found = false;
    for (let i = nowIdx+1; i < weather.hourly.time.length && i <= nowIdx+2; i++) {
      if (!weather.hourly.weathercode[i]) continue;
      let code = weather.hourly.weathercode[i], type = "";
      // --- Magyar t√≠pus besorol√°s (√∂sszes, IPC-style) ---
      if ([61,63,65,80,81,82].includes(code)) type = "es≈ë";              // z√°por, es≈ë, zivatar el≈ëjele
      else if ([95,96,99].includes(code))    type = "zivatar";           // vihar/zivatar
      else if ([67,77].includes(code))       type = "j√©ges≈ë";            // j√©ges≈ë
      else if ([71,73,75,85,86].includes(code)) type = "havaz√°s";        // h√≥/havaz√°s
      else if ([51,53,55,56,57].includes(code)) type = "szit√°l√°s";       // enyhe es≈ë/szit√°l√°s
      else if ([3,45,48].includes(code))     type = "k√∂d";               // k√∂d
      else if ([2].includes(code))           type = "felh≈ës";            // felh≈ës
      // tov√°bb b≈ëv√≠theted m√°s WMO weathercode-dal!
      if (type) {
        let dt = new Date(weather.hourly.time[i]);
        let now = new Date(weather.current_weather.time);
        let min = Math.round((dt-now)/1000/60);
        if (min > 0 && min <= 60) {
          msg += `‚ö° <b>${type.charAt(0).toUpperCase()+type.slice(1)} v√°rhat√≥ kb. ${min} perc m√∫lva!</b> `;
          found = true; break;
        }
      }
    }
    if (!found) msg += "";
  }
  // --- Jelenlegi csapad√©k ---
  if (weather.current_weather && weather.current_weather.precipitation > 0) {
    msg += "Jelenleg is csapad√©k van, ";
  }
  // --- UV ---
  if (uv !== null && uv >= 6) msg += "er≈ës UV, haszn√°lj f√©nyv√©d≈ët, ";
  // --- Sz√©l (AI figyelmeztet√©s) ---
  if (atm && atm.wind >= 35) msg += `<b>Viharos sz√©l (${atm.wind} km/h)!</b> `;
  else if (atm && atm.wind >= 18) msg += `er≈ës sz√©l (${atm.wind} km/h), `;
  // --- L√°t√≥t√°vols√°g, p√°ratartalom ---
  if (atm && atm.visibility < 7) msg += `l√°t√≥t√°vols√°g: ${atm.visibility} km, `;
  if (atm && atm.humidity > 80) msg += `magas p√°ratartalom (${atm.humidity}%). `;
  // --- Leveg≈ëmin≈ës√©g ---
  if (air && air.components && air.components.pm2_5 < 18) {
    msg += "J√≥ a leveg≈ëmin≈ës√©g ‚Äì ide√°lis a ker√©kp√°roz√°shoz!";
  } else if (air && air.components) {
    msg += `A leveg≈ëmin≈ës√©g k√∂zepes/szennyezett (PM2.5: ${air.components.pm2_5} ¬µg/m¬≥), ink√°bb ne fuss a szabadban.`;
  } else {
    msg += "Nincs el√©rhet≈ë adat a leveg≈ëmin≈ës√©gr≈ël.";
  }

 // --- H≈ë√©rzet √©s √∂lt√∂z√©k javaslat ---
  if (weather && weather.current_weather && typeof weather.current_weather.temperature === 'number') {
    const t = weather.current_weather.temperature;
    let dress = "";
    if (t >= 29) dress = "K√∂nny≈± ny√°ri ruha, sapka, sok folyad√©k!";
    else if (t >= 22) dress = "R√∂vid ujj√∫ p√≥l√≥, k√∂nny≈± nadr√°g aj√°nlott.";
    else if (t >= 17) dress = "Hossz√∫ ujj√∫ p√≥l√≥, v√©kony pul√≥ver.";
    else if (t >= 12) dress = "K√∂nny≈± dzseki, r√©teges √∂lt√∂zet.";
    else if (t >= 5) dress = "Melegebb kab√°t, pul√≥ver, s√°l.";
    else if (t >= -3) dress = "T√©li kab√°t, sapka, s√°l, keszty≈±!";
    else dress = "Extr√©m hideg! Vastag, r√©teges t√©li √∂lt√∂zet, sapka, s√°l, keszty≈± k√∂telez≈ë!";
    msg += `<br><b>√ñlt√∂z√©k tipp:</b> ${dress}`;
    // H≈ë√©rzet kieg√©sz√≠t≈ë
    if (atm && atm.wind > 18) msg += " (Er≈ës sz√©l miatt hidegebbnek √©rz≈ëdik!)";
    if (atm && atm.humidity > 85 && t > 18) msg += " (Magas p√°ratartalom miatt f√ºlledtebbnek √©rz≈ëdik.)";
  }


  // --- Forgalmi inf√≥, ha van ---
  if (trafficMsg) msg += `<br>üö¶ <b>${trafficMsg}</b>`;

  return msg;
}


let map, marker, circle, poiMarkers = [];
function initMap(lat, lon) {
  if (!map) {
    map = L.map('leafletmap').setView([lat, lon], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    marker = L.marker([lat, lon], {icon: L.icon({
      iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    })}).addTo(map).bindPopup("Itt vagy!").openPopup();
    circle = L.circle([lat, lon], {radius: 100, color: "#50ce90", fillOpacity:.12}).addTo(map);
  } else {
    marker.setLatLng([lat, lon]);
    circle.setLatLng([lat, lon]);
    map.setView([lat, lon], map.getZoom());
  }
  updatePOI(lat, lon);
}
async function updatePOI(lat, lon) {
  poiMarkers.forEach(p => map.removeLayer(p));
  poiMarkers = [];
  const pois = await fetchPOI(lat, lon);
  pois.forEach(node => {
    let icon = "‚ùì", typeLabel = "-";
    for (let t of poiTypes) if (node.tags[t.key] === t.val) { icon = t.icon; typeLabel = t.label; break; }

    // --- M√ºncheni meg√°ll√≥k: √©l≈ë MVV popup ---
    if (typeLabel === "Buszmeg√°ll√≥" && node.tags.name) {
      let stopName = node.tags.name || "";
      let m = L.marker([node.lat, node.lon], {
        icon: L.divIcon({className:"",html:`<span style="font-size:1.5em">üöè</span>`})
      }).addTo(map)
        .on('click', function() {
          showMunichStopDepartures(stopName, m);
        });
      poiMarkers.push(m);

    // --- Minden m√°s POI: alap popup ---
    } else {
      let m = L.marker([node.lat, node.lon], {
        icon: L.divIcon({className:"",html:`<span style="font-size:1.5em">${icon}</span>`})
      }).addTo(map)
        .bindPopup(
          `${icon} <b>${node.tags.name||typeLabel}</b><br><span style="font-size:1em;">${typeLabel}</span>`
        );
      poiMarkers.push(m);
    }
  });
}

function liveFollowPosition() {
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      initMap(lat, lon);
    });
  }
}
document.getElementById("btnstreet").onclick = function() {
  if (marker && marker.getLatLng) {
    let lat = marker.getLatLng().lat, lon = marker.getLatLng().lng;
    window.open(`https://maps.google.com/?cbll=${lat},${lon}&layer=c`, "_blank");
  }
};
document.getElementById("btn2d").onclick = function() {
  if (marker && marker.getLatLng) {
    let lat = marker.getLatLng().lat, lon = marker.getLatLng().lng;
    initMap(lat, lon);
  }
};
// --- S√∂t√©t m√≥d ---
function setDarkMode(on) {
  document.body.classList.toggle('dark', on);
  localStorage.setItem("eco_darkmode", on ? "1":"0");
}
function autoDarkMode() {
  const now = new Date(), sunset = 20;
  setDarkMode(now.getHours() >= sunset || localStorage.getItem("eco_darkmode")==="1");
}
document.getElementById('darkmodeBtn').onclick = ()=>setDarkMode(!document.body.classList.contains('dark'));
setTimeout(autoDarkMode,300);
// --- MODAL/okos figyelmeztet√©s: pollen, UV, h≈ës√©g!
function showAlertModal(title, msg) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMsg').innerHTML = msg;
  document.getElementById('alertModal').style.display = "flex";
}
// --- √âl≈ë ESEM√âNYEK a programturizmus.hu RSS alapj√°n, poz√≠ci√≥hoz igaz√≠tva ---
async function getEventsNearby(cityName) {
  const rssUrl = "https://www.programturizmus.hu/rss.xml";
  const proxy = "https://api.allorigins.win/get?url=";
  try {
    const res = await fetch(proxy + encodeURIComponent(rssUrl));
    const data = await res.json();
    const parser = new window.DOMParser();
    const xml = parser.parseFromString(data.contents, "text/xml");
    const items = xml.querySelectorAll("item");
    let events = [];
    items.forEach(item => {
      const title = item.querySelector("title")?.textContent || "";
      const desc = item.querySelector("description")?.textContent || "";
      const link = item.querySelector("link")?.textContent || "";
      // Ha a c√≠mben vagy le√≠r√°sban szerepel a v√°rosod neve (vagy k√∂rny√©kbeli telep√ºl√©s):
      if (
        title.toLowerCase().includes(cityName.toLowerCase()) ||
        desc.toLowerCase().includes(cityName.toLowerCase())
      ) {
        events.push({title, desc, link});
      }
    });
    return events;
  } catch (e) {
    return [];
  }
}

// --- ESEM√âNYEK MEGJELEN√çT√âSE ---
async function loadEvents(cityName) {
  const events = await getEventsNearby(cityName);
  if (!events.length) {
    document.getElementById("event-list").innerHTML = "<i>Nincs kiemelt esem√©ny a k√∂zelben.</i>";
    return;
  }
  document.getElementById("event-list").innerHTML = events.map(ev =>
    `<div>üéâ <b>${ev.title}</b><br>
      <span style="font-size:.98em;color:#36826a">${ev.desc}</span><br>
      <a href="${ev.link}" target="_blank" style="font-size:.93em;">R√©szletek</a>
    </div>`
  ).join("<hr>");
}

// --- 3 napos gyors id≈ëj√°r√°s panel ---
function renderForecast(weather) {
  const w = weather;
  let res = '';
  for (let d = 0; d < 3; d++) {
    // --- Minimum: 0:00-t√≥l 8:00-ig (√©jszaka/hajnal)
    let minTemp = 99, minIdx = -1;
    for (let h = d * 24; h < d * 24 + 9; h++) {
      if (w.hourly.temperature_2m && w.hourly.temperature_2m[h] !== undefined) {
        if (w.hourly.temperature_2m[h] < minTemp) {
          minTemp = w.hourly.temperature_2m[h];
          minIdx = h;
        }
      }
    }
    // --- Maximum: 13:00-t√≥l 19:00-ig (d√©lut√°ni cs√∫cs)
    let maxTemp = -99, maxIdx = -1;
    for (let h = d * 24 + 13; h < d * 24 + 20; h++) {
      if (w.hourly.temperature_2m && w.hourly.temperature_2m[h] !== undefined) {
        if (w.hourly.temperature_2m[h] > maxTemp) {
          maxTemp = w.hourly.temperature_2m[h];
          maxIdx = h;
        }
      }
    }
    // --- Nap neve (pl. Sze, Cs, P)
    let date = new Date(w.hourly.time[d * 24]);
    let day = date.toLocaleDateString('hu-HU', { weekday: 'short' });
    // --- Id≈ëj√°r√°s ikon: a maximumhoz tartoz√≥ id≈ëpont√©
    let code = w.hourly.weathercode[maxIdx];
    let icon = "‚òÄÔ∏è";
    if ([61,63,65,80,81,82].includes(code)) icon = "üåßÔ∏è";
    if ([71,73,75,85,86].includes(code)) icon = "üå®Ô∏è";
    if ([95,96,99].includes(code)) icon = "‚õàÔ∏è";
    if ([67,77].includes(code)) icon = "üßä";
    // --- Ki√≠r√°s
    let minT = minTemp !== 99 ? Math.round(minTemp) + "¬∞C" : "-";
    let maxT = maxTemp !== -99 ? Math.round(maxTemp) + "¬∞C" : "-";
    res += `<div class="forecast-day">
      <div class="day">${day}</div>
      <div class="icon">${icon}</div>
      <div class="temp"><span style="color:#19e58f">${minT}</span> / <b>${maxT}</b></div>
    </div>`;
  }
  document.getElementById('forecast-panel').innerHTML = res;
}
// --- F≈ê LOGIKA, minden bet√∂lt√©se:
async function loadEcoData() {
  try {
    // const coords = await getPosition();
    const coords = {latitude: 47.4979, longitude: 19.0402}; // Budapest demo

    const lat = coords.latitude, lon = coords.longitude;
    document.getElementById('city').textContent = "Bet√∂lt√©s‚Ä¶";
    const cityName = await getCityName(lat, lon);
    document.getElementById('city').textContent = cityName ? cityName : `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    document.getElementById('weather').textContent = "Bet√∂lt√©s‚Ä¶";
    document.getElementById('uv').textContent = "Bet√∂lt√©s‚Ä¶";

    const weather = await getWeather(lat, lon);
    document.getElementById('weather').textContent =
      `${Math.round(weather.current_weather.temperature)}¬∞C, ` +
      (weather.current_weather.precipitation > 0 ? "es≈ë v√°rhat√≥" : "nincs csapad√©k");

    let uvNow = null;
    if(weather.hourly && weather.hourly.uv_index && weather.hourly.time){
      let idx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
      if(idx>=0) uvNow = weather.hourly.uv_index[idx];
    }
    document.getElementById('uv').textContent = uvNow !== null ? uvNow.toFixed(1)+" (max 11)" : "Nincs adat";

    let atmNow = {visibility:0,humidity:0,wind:0};
    if(weather.hourly && weather.hourly.visibility && weather.hourly.time){
      let idx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
      if(idx>=0) {
        atmNow.visibility = Math.round((weather.hourly.visibility[idx]||0)/1000);
        atmNow.humidity = weather.hourly.relative_humidity_2m ? Math.round(weather.hourly.relative_humidity_2m[idx]||0) : 0;
        atmNow.wind = weather.hourly.windspeed_10m ? Math.round(weather.hourly.windspeed_10m[idx]||0) : 0;
      }
    }
    document.getElementById('atm-panel').innerHTML = `L√°t√≥t√°vols√°g: <b>${atmNow.visibility} km</b>, P√°ratartalom: <b>${atmNow.humidity}%</b>, Sz√©l: <b>${atmNow.wind} km/h</b>`;

    document.getElementById('air-quality').textContent = "Bet√∂lt√©s‚Ä¶";
    let airData = await getAirQuality(lat, lon);
    if (airData && airData.components) {
      let pm = airData.components.pm2_5;
      let status = "J√≥";
      if (pm >= 35) status = "Szennyezett";
      else if (pm >= 18) status = "K√∂zepes";
      document.getElementById('air-quality').textContent =
        `"${status}" (PM2.5: ${pm} ¬µg/m¬≥)`;
      document.getElementById('air-components').innerHTML =
        `<span class="badge pm10">PM10: ${airData.components.pm10} ¬µg/m¬≥</span>` +
        `<span class="badge no2">NO‚ÇÇ: ${airData.components.no2} ¬µg/m¬≥</span>` +
        `<span class="badge o3">O‚ÇÉ: ${airData.components.o3} ¬µg/m¬≥</span>` +
        `<span class="badge co">CO: ${airData.components.co} ¬µg/m¬≥</span>`;
    } else {
      document.getElementById('air-quality').textContent =
        "Nincs el√©rhet≈ë adat a leveg≈ëmin≈ës√©gr≈ël!";
      document.getElementById('air-components').textContent = "";
    }

    const pollen = getDemoPollen(cityName || "");
    document.getElementById('pollen-panel').innerHTML =
      `Parlagf≈±: <b>${pollen.ragweed}</b>, F≈±f√©l√©k: <b>${pollen.grass}</b>, Ny√≠rfa: <b>${pollen.birch}</b>`;

    // --- Riaszt√°s, szint + TEEND≈ê! ---
    const ww = await getWeatherWarning(cityName);
    const warnPanel = document.getElementById('weather-warning-card');
    const warnDiv = document.getElementById('weather-warning-details');
    if (!ww.warnings.length) {
      warnPanel.className = "eco-card warn-none";
      warnDiv.innerHTML = `<span class="warn-icon">‚úÖ</span> <b>Nincs riaszt√°s.</b>`;
    } else {
      warnPanel.className = warningLevelClass(Math.max(...ww.warnings.map(w=>w.szint)));
      warnDiv.innerHTML = ww.warnings.map(w=>{
        const iconAndText = warningIconAndText(w.jelzes);
        let timeInfo = w.kezdete ? `<span class="warn-time">${formatOszTime(w.kezdete)} - ${formatOszTime(w.vege)}</span>` : '';
        let teendo = szintTeendo[w.szint] || "";
        return `<span class="warn-icon">${iconAndText.icon}</span> <b>${iconAndText.text}</b> (szint: <b>${w.szint}</b>)${timeInfo}<br><b>${teendo}</b>`;
      }).join("<hr style='border:none;border-top:1px solid #eee;margin:6px 0;>");
    }

    // --- MODAL, okos figyelmeztet√©s: pollen, UV, h≈ës√©g!
    if (uvNow && uvNow >= 7)
      showAlertModal("Extr√©m UV!","Nagyon er≈ës UV-sug√°rz√°s, ker√ºld a t≈±z≈ë napot 11-15h k√∂z√∂tt! F√©nyv√©delem sz√ºks√©ges.");
    if (pollen.ragweed === "magas")
      showAlertModal("Allerg√©n figyelmeztet√©s","Magas a parlagf≈± pollen koncentr√°ci√≥. Allergi√°soknak fokozott √≥vatoss√°g!");
    if (weather.current_weather.temperature >= 33)
      showAlertModal("H≈ës√©griaszt√°s","Rendk√≠v√ºl magas h≈ëm√©rs√©klet, figyelj a folyad√©kbevitelre √©s √°rny√©kban tart√≥zkodj!");

    // --- Forgalmi inform√°ci√≥ lek√©r√©se √©s AI √∂sszegz√©s
    let trafficMsg = await getUtinform();

    document.getElementById('ai-suggestion').children[1].innerHTML =
      `<strong>AI aj√°nlatod m√°ra:</strong><br>` + generateAISuggestion(weather, uvNow, airData, atmNow, trafficMsg);

    // --- √âl≈ë t√©rk√©p + POI + poz√≠ci√≥
    initMap(lat, lon);
    liveFollowPosition();

    // --- Esem√©ny keres≈ë
    loadEvents(cityName);

    // --- 3 napos el≈ërejelz√©s
    renderForecast(weather);

  } catch (e) {
    document.getElementById('ai-suggestion').children[1].textContent =
      "Nem siker√ºlt lek√©rni az √©l≈ë adatokat: " + e;
    document.getElementById('weather').textContent = "Nincs √©l≈ë adat.";
    document.getElementById('city').textContent = "";
    document.getElementById('uv').textContent = "";
    document.getElementById('atm-panel').textContent = "";
    document.getElementById('air-quality').textContent = "";
    document.getElementById('air-components').textContent = "";
    document.getElementById('pollen-panel').textContent = "";
    document.getElementById('weather-warning-details').textContent = "";
    document.getElementById('traffic-info').textContent = "";
    document.getElementById('traffic-info').innerHTML = "üö¶ <b>Forgalmi inform√°ci√≥:</b> Nincs adat";
  }
}



function updateLastRefresh() {
  const now = new Date();
  const t = now.toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  document.getElementById('last-refresh').textContent = `Utols√≥ friss√≠t√©s: ${t}`;
}

window.onload = loadEcoData;
setInterval(loadEcoData, 60000); // 2 percenk√©nt √∫jra lefut
updateLastRefresh()

</script>
</body>
</html>


