<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>EcoLife AI ‚Äì OpenWeather l√©gszennyezetts√©g, Pollen, Vesz√©lyjelz√©s, Kih√≠v√°s</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {background: linear-gradient(120deg, #e9ffe7 0%, #cbf3d2 100%);
      font-family: 'Montserrat', sans-serif; margin:0; color:#21321b; min-height:100vh;}
    .container {max-width: 580px; margin: 24px auto 0 auto; padding: 16px;
      background:#fff; border-radius:24px; box-shadow:0 8px 32px rgba(48,89,64,0.18);}
    h1 {text-align:center; font-size:2.1rem; color:#247a36; margin-top:4px;}
    .ai-suggestion {background:#e3ffe7; border-left:5px solid #58d172; padding:18px 14px 18px 24px; border-radius:16px;
      font-size:1.17rem; margin-bottom:20px; display:flex; align-items:center; gap:10px; box-shadow:0 2px 8px rgba(85,180,120,0.09);}
    .ai-suggestion svg {flex-shrink:0;width:26px;height:26px;}
    .section-title {font-size:1.15rem; color:#28853b; margin:28px 0 14px 2px; font-weight:700;}
    .eco-cards {display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 10px;}
    .eco-card {flex: 1 1 140px; background: linear-gradient(115deg,#e8f5e9 60%,#d2ffef 100%);
      border-radius: 16px; box-shadow:0 2px 8px rgba(63,155,120,0.09); padding:18px 14px 13px 14px;
      display: flex; flex-direction: column; align-items: flex-start; min-width:120px; max-width:210px; margin-bottom:8px;}
    .eco-card strong {font-size:1.08rem; color:#246c38;}
    .eco-card small, .eco-card span {color:#557b61; font-size:.97rem;}
    .eco-icon {font-size:1.13rem;margin-right:7px;}
    .badges {display:flex; gap:7px; flex-wrap:wrap; margin-top:7px;}
    .badge {background:#ebffe8; border-radius:8px; padding:3px 7px; font-size:.97em;}
    .badge.pm10 {background:#f5ffe1;}
    .badge.no2 {background:#f7f3ff;}
    .badge.o3 {background:#e2f6ff;}
    .badge.co {background:#fff4e2;}
    .challenge-row {display:flex; align-items:center; justify-content:space-between; gap:7px;}
    .challenge-desc {font-size:1.04rem; color:#187441; font-weight:500;}
    .challenge-btn {background:#52c77b; color:#fff; border:none; border-radius:10px; padding:7px 15px; font-size:.99rem; font-weight:600; cursor:pointer; transition:background .2s;}
    .challenge-btn:hover {background:#329758;}
    .map {margin:20px 0 16px 0; height:180px; background:linear-gradient(135deg,#b9e9c2 60%,#e2fae1 100%);
      border-radius:15px; display:flex; align-items:center; justify-content:center;
      color:#267a37; font-size:1.09rem;}
    #leafletmap {width:100%; height:100%; border-radius:15px;}
    .footer {text-align:center; color:#aad2bb; margin:28px 0 8px 0; font-size:.98rem;}
    /* --- Vesz√©lyjelz√©s sz√≠nek, ikon --- */
    .warn-yellow { background: #fffde0!important; border-left: 6px solid #ffe17a!important; }
    .warn-orange { background: #fff2e0!important; border-left: 6px solid #ffbb5c!important; }
    .warn-red { background: #ffe0e0!important; border-left: 6px solid #ff5c5c!important; }
    .warn-none { background: #f2fff1!important; border-left: 6px solid #a7e69e!important; }
    .warn-icon { font-size:1.45em; vertical-align: middle; margin-right:6px;}
    .warn-time { color: #555; font-size: .97em; margin-left:4px;}
    @media (max-width: 600px) {.container {max-width: 100vw; border-radius: 0;} .eco-cards {flex-direction: column;}}
  </style>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <div class="container">

    <h1>üå± EcoLife AI</h1>
    <div id="ai-suggestion" class="ai-suggestion">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 16v-4M12 8h.01" stroke-width="2" stroke-linecap="round"/></svg>
      <span><strong>AI aj√°nlatod t√∂lt≈ëdik‚Ä¶</strong></span>
    </div>

    <div class="section-title">üå§ √âl≈ë √ñko-adatok</div>
    <div class="eco-cards">
      <div class="eco-card"><span class="eco-icon">üèôÔ∏è</span>
        <strong>Hely:</strong>
        <small id="city">Bet√∂lt√©s‚Ä¶</small>
      </div>
      <div class="eco-card"><span class="eco-icon">üå°Ô∏è</span>
        <strong>H≈ëm√©rs√©klet:</strong>
        <small id="weather">Bet√∂lt√©s‚Ä¶</small>
      </div>
      <div class="eco-card"><span class="eco-icon">üåû</span>
        <strong>UV-index:</strong>
        <small id="uv">Bet√∂lt√©s‚Ä¶</small>
      </div>
      <div class="eco-card"><span class="eco-icon">üå¨Ô∏è</span>
        <strong>Leveg≈ëmin≈ës√©g:</strong>
        <small id="air-quality">Bet√∂lt√©s‚Ä¶</small>
        <div class="badges" id="air-components"></div>
      </div>
      <div class="eco-card"><span class="eco-icon">üå∏</span>
        <strong>Pollen el≈ërejelz√©s:</strong>
        <small id="pollen-panel">Bet√∂lt√©s‚Ä¶</small>
      </div>
      <div class="eco-card" id="weather-warning-card">
        <span class="eco-icon">‚õàÔ∏è</span>
        <strong>Vesz√©lyjelz√©s:</strong>
        <div id="weather-warning-details"><small>Bet√∂lt√©s‚Ä¶</small></div>
      </div>
      <div class="eco-card"><span class="eco-icon">üèÜ</span>
        <strong>Heti √∂ko-kih√≠v√°sod:</strong>
        <div class="challenge-row">
          <span class="challenge-desc">Bring√°zz legal√°bb 10 km-t!</span>
          <button class="challenge-btn" onclick="completeChallenge()">Teljes√≠tettem</button>
        </div>
        <small id="challenge-status">0 teljes√≠t√©s</small>
      </div>
    </div>

    <div class="section-title">üó∫Ô∏è √âl≈ë t√©rk√©p (k√∂vet√©s, zoom, mozg√°s)</div>
    <div class="map"><div id="leafletmap"></div></div>

    <div class="footer">
      &copy; 2025 EcoLife AI | <span style="color:#7bbd97">Protot√≠pus OpenWeather-rel, √©l≈ë magyar adatokkal</span>
    </div>
  </div>
  <script>
    const OPENWEATHER_API_KEY = "6a8514078d38de2a2c4e4e1642fede5c";

    // DEMO pollen adatok (v√°rosn√©v alapj√°n)
    const demoPollen = [
      { city: "Budapest", ragweed: "magas", grass: "k√∂zepes", birch: "alacsony" },
      { city: "Sz√©kesfeh√©rv√°r", ragweed: "k√∂zepes", grass: "alacsony", birch: "nincs" },
      { city: "Debrecen", ragweed: "alacsony", grass: "alacsony", birch: "alacsony" },
      { city: "Miskolc", ragweed: "k√∂zepes", grass: "k√∂zepes", birch: "alacsony" }
    ];
    function getDemoPollen(cityName) {
      const found = demoPollen.find(x => cityName && cityName.includes(x.city));
      return found || demoPollen[0];
    }
    function completeChallenge() {
      let count = Number(localStorage.getItem("eco_challenge") || 0) + 1;
      localStorage.setItem("eco_challenge", count);
      document.getElementById('challenge-status').textContent = count + " teljes√≠t√©s";
    }
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('challenge-status').textContent =
        (localStorage.getItem("eco_challenge") || 0) + " teljes√≠t√©s";
    });

    function getPosition() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) reject("Nincs geolok√°ci√≥!");
        navigator.geolocation.getCurrentPosition(
          pos => resolve(pos.coords),
          err => reject(err)
        );
      });
    }
    async function getWeather(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=uv_index&timezone=auto`;
      const res = await fetch(url);
      if (!res.ok) throw "Nem siker√ºlt lek√©rni az id≈ëj√°r√°st!";
      return await res.json();
    }
    async function getAirQuality(lat, lon) {
      const url = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}`;
      const res = await fetch(url);
      if (!res.ok) return null;
      const data = await res.json();
      if (!data.list || !data.list.length) return null;
      return data.list[0];
    }
    async function getCityName(lat, lon) {
      const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=hu`;
      const res = await fetch(url);
      if (!res.ok) return "";
      const data = await res.json();
      return data.address.city || data.address.town || data.address.village || data.address.hamlet || data.display_name;
    }
    async function getWeatherWarning(cityName) {
      try {
        const url = "https://api.met.hu/idojaras/veszelyjelzes/megye.json";
        const res = await fetch(url);
        const data = await res.json();
        const countyNames = ["B√°cs-Kiskun","Baranya","B√©k√©s","Borsod-Aba√∫j-Zempl√©n","Csongr√°d-Csan√°d","Fej√©r","Gy≈ër-Moson-Sopron","Hajd√∫-Bihar","Heves","J√°sz-Nagykun-Szolnok","Kom√°rom-Esztergom","N√≥gr√°d","Pest","Somogy","Szabolcs-Szatm√°r-Bereg","Tolna","Vas","Veszpr√©m","Zala","Budapest"];
        let county = "";
        for (const name of countyNames) {
          if (cityName && cityName.includes(name)) {
            county = name; break;
          }
        }
        if (!county || !data.megye) return { warnings: [], county: "" };
        const c = data.megye.find(x => x.nev === county);
        if (!c || !c.fok || !c.fok.length) return { warnings: [], county };
        let warnings = c.fok.filter(x => x.szint > 0);
        return { warnings, county };
      } catch (e) { return { warnings: [], county: "" }; }
    }
    function warningIconAndText(jelzes) {
      if (!jelzes) return {icon:"",text:""};
      let txt = jelzes.toLowerCase();
      if (txt.includes("zivatar")) return {icon:"üå©Ô∏è", text:"Zivatar"};
      if (txt.includes("h≈ës√©g")) return {icon:"‚òÄÔ∏è", text:"H≈ës√©g"};
      if (txt.includes("sz√©l")) return {icon:"üí®", text:"Sz√©l"};
      if (txt.includes("j√©ges≈ë")) return {icon:"üßä", text:"J√©ges≈ë"};
      if (txt.includes("h√≥")) return {icon:"üå®Ô∏è", text:"H√≥"};
      if (txt.includes("k√∂d")) return {icon:"üå´Ô∏è", text:"K√∂d"};
      if (txt.includes("es≈ë")) return {icon:"üåßÔ∏è", text:"Es≈ë"};
      return {icon:"‚ö†Ô∏è", text:jelzes};
    }
    function warningLevelClass(szint) {
      if (szint == 3) return "eco-card warn-red";
      if (szint == 2) return "eco-card warn-orange";
      if (szint == 1) return "eco-card warn-yellow";
      return "eco-card warn-none";
    }
    function formatOszTime(t) {
      if (!t) return "";
      let d = t.split("T");
      if (!d[0] || !d[1]) return "";
      let dm = d[0].slice(5).replace("-",".") + ". " + d[1].slice(0,5);
      return dm;
    }
    function generateAISuggestion(weather, uv, air) {
      let msg = "";
      if (weather.current_weather && weather.current_weather.precipitation > 0) {
        msg += "Ma es≈ë v√°rhat√≥, √≠gy ink√°bb ne moss aut√≥t, ";
      } else {
        msg += "Sz√°raz id≈ë lesz, ";
      }
      if (uv !== null && uv >= 6) msg += "er≈ës UV, haszn√°lj f√©nyv√©d≈ët, ";
      if (air && air.components && air.components.pm2_5 < 18) {
        msg += "j√≥ a leveg≈ëmin≈ës√©g ‚Äì ide√°lis a ker√©kp√°roz√°shoz!";
      } else if (air && air.components) {
        msg += `a leveg≈ëmin≈ës√©g k√∂zepes/szennyezett (PM2.5: ${air.components.pm2_5} ¬µg/m¬≥), ink√°bb ne fuss a szabadban.`;
      } else {
        msg += "nincs el√©rhet≈ë adat a leveg≈ëmin≈ës√©gr≈ël.";
      }
      return msg;
    }

    // --- LEAFLET MAP ---
    let map, marker, circle;
    function initMap(lat, lon) {
      if (!map) {
        map = L.map('leafletmap').setView([lat, lon], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        marker = L.marker([lat, lon], {icon: L.icon({
          iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-green.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })}).addTo(map).bindPopup("Itt vagy!");
        circle = L.circle([lat, lon], {radius: 100, color: "#50ce90", fillOpacity:.15}).addTo(map);
      } else {
        marker.setLatLng([lat, lon]);
        circle.setLatLng([lat, lon]);
        map.setView([lat, lon], map.getZoom());
      }
    }
    function liveFollowPosition() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
          const lat = pos.coords.latitude, lon = pos.coords.longitude;
          initMap(lat, lon);
        });
      }
    }

    // --- F≈ê LOGIKA ---
    async function loadEcoData() {
      try {
        const coords = await getPosition();
        const lat = coords.latitude, lon = coords.longitude;

        document.getElementById('city').textContent = "Bet√∂lt√©s‚Ä¶";
        const cityName = await getCityName(lat, lon);
        document.getElementById('city').textContent = cityName ? cityName : `${lat.toFixed(4)}, ${lon.toFixed(4)}`;

        document.getElementById('weather').textContent = "Bet√∂lt√©s‚Ä¶";
        document.getElementById('uv').textContent = "Bet√∂lt√©s‚Ä¶";
        const weather = await getWeather(lat, lon);
        document.getElementById('weather').textContent =
          `${Math.round(weather.current_weather.temperature)}¬∞C, ` +
          (weather.current_weather.precipitation > 0 ? "es≈ë v√°rhat√≥" : "nincs csapad√©k");
        let uvNow = null;
        if(weather.hourly && weather.hourly.uv_index && weather.hourly.time){
          let idx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
          if(idx>=0) uvNow = weather.hourly.uv_index[idx];
        }
        document.getElementById('uv').textContent = uvNow !== null ? uvNow.toFixed(1)+" (max 11)" : "Nincs adat";

        document.getElementById('air-quality').textContent = "Bet√∂lt√©s‚Ä¶";
        let airData = await getAirQuality(lat, lon);
        if (airData && airData.components) {
          let pm = airData.components.pm2_5;
          let status = "J√≥";
          if (pm >= 35) status = "Szennyezett";
          else if (pm >= 18) status = "K√∂zepes";
          document.getElementById('air-quality').textContent =
            `"${status}" (PM2.5: ${pm} ¬µg/m¬≥)`;
          document.getElementById('air-components').innerHTML =
            `<span class="badge pm10">PM10: ${airData.components.pm10} ¬µg/m¬≥</span>` +
            `<span class="badge no2">NO‚ÇÇ: ${airData.components.no2} ¬µg/m¬≥</span>` +
            `<span class="badge o3">O‚ÇÉ: ${airData.components.o3} ¬µg/m¬≥</span>` +
            `<span class="badge co">CO: ${airData.components.co} ¬µg/m¬≥</span>`;
        } else {
          document.getElementById('air-quality').textContent =
            "Nincs el√©rhet≈ë adat a leveg≈ëmin≈ës√©gr≈ël!";
          document.getElementById('air-components').textContent = "";
        }

        const pollen = getDemoPollen(cityName || "");
        document.getElementById('pollen-panel').innerHTML =
          `Parlagf≈±: <b>${pollen.ragweed}</b>, F≈±f√©l√©k: <b>${pollen.grass}</b>, Ny√≠rfa: <b>${pollen.birch}</b>`;

        const ww = await getWeatherWarning(cityName);
        const warnPanel = document.getElementById('weather-warning-card');
        const warnDiv = document.getElementById('weather-warning-details');
        if (!ww.warnings.length) {
          warnPanel.className = "eco-card warn-none";
          warnDiv.innerHTML = `<span class="warn-icon">‚úÖ</span> <b>Nincs riaszt√°s.</b>`;
        } else {
          warnPanel.className = warningLevelClass(Math.max(...ww.warnings.map(w=>w.szint)));
          warnDiv.innerHTML = ww.warnings.map(w=>{
            const iconAndText = warningIconAndText(w.jelzes);
            let timeInfo = w.kezdete ? `<span class="warn-time">${formatOszTime(w.kezdete)} - ${formatOszTime(w.vege)}</span>` : '';
            return `<span class="warn-icon">${iconAndText.icon}</span> <b>${iconAndText.text}</b> (szint: <b>${w.szint}</b>)${timeInfo}`;
          }).join("<hr style='border:none;border-top:1px solid #eee;margin:6px 0;'>");
        }

        document.getElementById('ai-suggestion').children[1].innerHTML =
          `<strong>AI aj√°nlatod m√°ra:</strong><br>` + generateAISuggestion(weather, uvNow, airData);

        // --- √âl≈ë t√©rk√©p ---
        initMap(lat, lon);
        liveFollowPosition();

      } catch (e) {
        document.getElementById('ai-suggestion').children[1].textContent =
          "Nem siker√ºlt lek√©rni az √©l≈ë adatokat: " + e;
        document.getElementById('weather').textContent = "Nincs √©l≈ë adat.";
        document.getElementById('city').textContent = "";
        document.getElementById('uv').textContent = "";
        document.getElementById('air-quality').textContent = "";
        document.getElementById('air-components').textContent = "";
        document.getElementById('pollen-panel').textContent = "";
        document.getElementById('weather-warning-details').textContent = "";
      }
    }
    window.onload = loadEcoData;
  </script>
</body>
</html>

