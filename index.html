<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>EcoLife AI ‚Äì 2D t√©rk√©p, radar, okos figyelmeztet√©s</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root {
  --bg: linear-gradient(120deg,#181e25 0%,#12151b 100%);
  --fg: #dcffe3;
  --panel: #1d2431;
  --glow: 0 0 12px #2affbb, 0 0 36px #1e8bc3;
  --panel-glow: 0 0 24px #00ffc2, 0 0 60px #2196f3, 0 0 5px #44f4ae;
  --border-neon: 2px solid #30ffd4;
}


body {
  background: var(--bg);
  color: var(--fg);
  min-height: 100vh;
  font-family: 'Montserrat', sans-serif;
}
.container {
  max-width: 600px;
  margin: 18px auto 0 auto;
  background: var(--panel);
  border-radius: 22px;
  box-shadow: var(--panel-glow);
  border: var(--border-neon);
  padding: 17px 0 18px 0;
}
h1 {
  color: #44ffe9;
  text-align: center;
  text-shadow: 0 0 10px #2affbb, 0 0 30px #0fffc2;
  font-size: 2.15em;
  margin-bottom: 19px;
  margin-top: 7px;
  letter-spacing: 0.04em;
}
.eco-card {
  background: var(--panel);
  border-radius: 17px;
  box-shadow: var(--panel-glow);
  border: var(--border-neon);
  padding: 17px 14px 13px 21px;
  margin-bottom: 14px;
  color: var(--fg);
  font-size: 1.13em;
  transition: box-shadow 0.2s;
}
.eco-card:hover {
  box-shadow: 0 0 18px #0fffc2, 0 0 40px #34fdfe;
  border-color: #45ffd6;
}
.eco-card strong, .section-title {
  color: #23ffbf;
  text-shadow: none;   /* vagy max 0 0 2px #00ffd4cc; */
  font-weight: 700;
  letter-spacing: 0.01em;
}
.eco-card small, .eco-card span {
  color: #aee6ff;
  font-size: 1em;
  text-shadow: none;
  font-weight: 400;
}

.section-title {
  color: #41f8ff;
  font-size: 1.14em;
  margin: 24px 0 13px 14px;
  letter-spacing: .02em;
  font-weight: bold;
}
.ai-suggestion, .info-panel, .forecast-day, .panel {
  background: #142229;
  border-radius: 17px;
  box-shadow: var(--panel-glow);
  border: var(--border-neon);
  color: #aaffeb;
}
.map-box, #leafletmap, #wazeFrame {
  border-radius: 16px !important;
  box-shadow: 0 0 28px #09ffc2, 0 0 18px #2196f333, 0 0 8px #44f4ae33 !important;
  border: 2px solid #13e6bb !important;
  background: #141c24;
}
button, .map-btn, .street-btn {
  background: linear-gradient(90deg,#13e6bb 0%,#35c5ff 100%);
  color: #0b1e15 !important;
  border: none;
  border-radius: 16px;
  font-weight: 700;
  padding: 13px 25px;
  font-size: 1.13em;
  box-shadow: 0 0 12px #13e6bb99, 0 0 28px #35c5ff33;
  margin-bottom: 7px;
  transition: background .22s, color .22s;
  cursor: pointer;
}
button:hover, .map-btn:hover, .street-btn:hover, .darkmode-btn:hover {
  background: linear-gradient(90deg,#20ffd6 0%,#41f8ff 100%);
  color: #03120d !important;
}
.footer {
  color: #27d9b7;
  text-shadow: 0 0 8px #30ffd466;
  font-size: 1.06em;
  background: transparent;
  margin-top: 30px;
}



    body {background:var(--bg);font-family:'Montserrat',sans-serif;margin:0;color:var(--fg);min-height:100vh;transition:.4s;}
    .container {max-width:560px;margin:10px auto 0 auto;padding:10px 0 16px 0;background:var(--panel);
      border-radius:22px;box-shadow:0 8px 32px rgba(48,89,64,0.17);}
    h1 {text-align:center;font-size:2.1rem;color:#247a36;margin:6px 0 16px 0;}
    .ai-suggestion {background:#e3ffe7;border-left:5px solid #58d172;padding:18px 14px 18px 24px;
      border-radius:16px;font-size:1.14rem;margin-bottom:18px;display:flex;align-items:center;gap:10px;
      box-shadow:0 2px 8px rgba(85,180,120,0.08);}
    .ai-suggestion svg {flex-shrink:0;width:26px;height:26px;}
    .section-title {font-size:1.09rem;color:#28853b;margin:20px 0 11px 8px;font-weight:700;}
    .eco-cards {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 9px;
}

@media (max-width: 530px) {
  .eco-cards {
    grid-template-columns: 1fr;
  }
}

.eco-card {
  background: linear-gradient(115deg,#e8f5e9 60%,#d2ffef 100%);
  border-radius: 14px;
  box-shadow: 0 2px 8px rgba(63,155,120,0.09);
  padding: 13px 9px 9px 13px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  min-width: 0;      /* gridhez k√∂telez≈ë! */
  max-width: 100%;   /* gridhez k√∂telez≈ë! */
  margin-bottom: 0;  /* gridn√©l felesleges */
}

.eco-card strong {font-size:1.06rem;color:#246c38;}
.eco-card small,.eco-card span {color:#557b61;font-size:.97rem;}

    .eco-icon {font-size:1.11rem;margin-right:7px;}
    .badges {display:flex;gap:7px;flex-wrap:wrap;margin-top:7px;}
    .badge {background:#ebffe8;border-radius:8px;padding:3px 7px;font-size:.97em;}
    .badge.pm10 {background:#f5ffe1;}
    .badge.no2 {background:#f7f3ff;}
    .badge.o3 {background:#e2f6ff;}
    .badge.co {background:#fff4e2;}
    .challenge-row {display:flex;align-items:center;justify-content:space-between;gap:7px;}
    .challenge-desc {font-size:1.02rem;color:#187441;font-weight:500;}
    .challenge-btn {background:#52c77b;color:#fff;border:none;border-radius:10px;padding:7px 15px;
      font-size:.99rem;font-weight:600;cursor:pointer;transition:background .2s;}
    .challenge-btn:hover {background:#329758;}
    .map-header {display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
    .map-btn {background:#d9f5dd;border:none;color:#187a4c;font-weight:700;
      border-radius:9px;padding:5px 16px;font-size:1.08em;margin-right:8px;cursor:pointer;}
    .map-btn.selected {background:#33ba72;color:#fff;}
    .street-btn {background:#f5ffe2;color:#187a4c;border-radius:10px;font-weight:600;
      padding:4px 16px;font-size:1em;margin-right:2px;cursor:pointer;}
    .street-btn:hover {background:#e4ffe3;}

    .map-box {width:100%;height:220px;min-height:155px;max-height:350px;position:relative;
      border-radius:15px;overflow:hidden;box-shadow:0 2px 12px #d6e6d9;}
    #leafletmap {width:100%;height:100%;border-radius:15px;}
    .footer {text-align:center;color:#aad2bb;margin:21px 0 7px 0;font-size:.97rem;}
    .forecast-panel {display:flex;gap:12px;margin:10px 0 0 6px;justify-content: center;}
    .forecast-day {
  background:#e7fbf6;
  padding:6px 7px;
  border-radius:11px;
  box-shadow:0 1px 6px #b6e6d5;
  text-align:center;
  min-width:55px;
  font-size:0.97em;
  margin: 0 2px;
}
   .forecast-panel { flex-wrap: wrap; }
    .forecast-day .day {font-weight:700;color:#167c44;}
    .forecast-day .icon {font-size:1.5em;}
    .forecast-day .temp {font-size:1.11em;}
    .info-panel {text-align:center;font-size:1.04em;margin:3px 0 2px 0;background:#f2fff6;
      border-radius:10px;padding:4px 0;}
    .info-panel.front {color:#3477af;}
    .info-panel.sun {color:#247a36;}
    .info-panel.pollen {color:#bb6827;}
    .info-panel.jam {color:#c0132e;}
    .modal-bg {position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(48,48,48,0.18);display:none;align-items:center;justify-content:center;}
    .modal-card {background:#fff;border-radius:22px;box-shadow:0 4px 32px #b2c0b3;padding:26px 18px;max-width:340px;text-align:center;}
    .modal-card h3 {margin:0 0 7px 0;color:#c0132e;font-size:1.21em;}
    .modal-card .modal-msg {font-size:1.06em;margin-bottom:12px;}
    .modal-card .modal-ok {margin-top:9px;padding:8px 28px;border:none;background:#248645;color:#fff;font-size:1.04em;border-radius:12px;cursor:pointer;}
    body.dark {
      --bg: linear-gradient(120deg,#222c24 0%,#1e2730 100%);
      --fg: #e3ffe7;
      --panel: #203628;
    }
    body.dark .eco-card, body.dark .forecast-day, body.dark .modal-card {background:#223929!important;color:#a5ffd9;}
    body.dark h1 {color:#82fcab;}
    body.dark .ai-suggestion {background:#19361d;color:#88ffaa;}
    body.dark .footer {color:#427759;}
    body.dark .map-btn, body.dark .street-btn, body.dark .darkmode-btn {background:#2d4936!important;color:#b1ffde;}
    @media (max-width:700px){.container{max-width:100vw;} .eco-cards{flex-direction:column;}
      .map-box{height:190px;min-height:124px;}}
    @media (max-width:430px){.container{padding:1px;} .eco-card{min-width:90px;} h1{font-size:1.25em;}}

.flagBtn.selected {
  border-bottom: 3px solid #38d473;
  background: #e3ffe6;
  color: #145c2c;
}
.flagBtn {
  transition: 0.15s;
  border-radius: 8px;
}

.speech-translate-panels {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 18px;
  margin-bottom: 36px;
  width: 100%;
  max-width: 560px;      /* Ugyanakkora, mint a .container! */
  margin-left: auto;
  margin-right: auto;
}

.speech-translate-panels .panel {
  background: #e8f5e9;
  border-radius: 13px;
  padding: 12px 8px 15px 12px;
  box-shadow: 0 2px 8px #bce1d1;
  min-width: 0;
  max-width: 100%;      /* hogy ne n≈ëj√∂n 280px f√∂l√© 2 oszlopos gridben */
  box-sizing: border-box;
}

/* Mobilon 1 oszlop, panel max. teljes sz√©less√©g */
@media (max-width: 700px) {
  .speech-translate-panels {
    grid-template-columns: 1fr;
    gap: 12px;
    max-width: 99vw;
  }
}

.header-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  position: relative;
  margin-bottom: 10px;
}
.header-row h1 {
  flex: 1 1 auto;
  margin: 0;
  text-align: center;
}
.darkmode-btn {
  position: relative;
  right: 0;
  top: 0;
  margin-left: 12px;
  font-size: 1.25em;
  min-width: 28px;
  min-height: 28px;
  background: linear-gradient(90deg,#13e6bb 0%,#35c5ff 100%);
  color: #031a13 !important;
  border: none;
  border-radius: 16px;
  box-shadow: 0 0 10px #13e6bb88;
  z-index: 2;
  cursor: pointer;
  transition: background .21s;
}
.darkmode-btn:hover {
  background: linear-gradient(90deg,#41f8ff 0%,#20ffd6 100%);
}


@media (max-width: 650px) {
  .container {
    max-width: 100vw !important;
    margin: 0 !important;
    padding: 7px 0 14vw 0 !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    background: var(--panel);
    box-shadow: none !important;
    border-radius: 0 !important;
    border: none !important;
  }
  .eco-cards {
    grid-template-columns: 1fr !important;
    gap: 16px !important;
    margin-bottom: 18px !important;
  }
  .eco-card {
    border-radius: 15px !important;
    margin-bottom: 10px !important;
    padding: 13px 9px 13px 14px !important;
    font-size: 1.10em !important;
  }
  .eco-card strong {font-size: 1.14em;}
  .ai-suggestion {
    font-size: 1.07em !important;
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 8px !important;
    padding: 14px 8px 14px 15px !important;
    border-radius: 13px !important;
    margin-bottom: 13px !important;
  }
  h1 {
    font-size: 1.25em !important;
    margin-bottom: 9px !important;
  }
  .section-title {font-size: 1.08em !important;}
  .forecast-panel {flex-wrap: wrap;}
  .forecast-day {
    min-width: 88px !important;
    font-size: 1em !important;
    padding: 9px 5px !important;
    border-radius: 12px !important;
  }
  .map-header {
    gap: 9px !important;
    flex-direction: column !important;
    align-items: stretch !important;
    margin-bottom: 10px !important;
  }
  .map-btn, .street-btn {
    font-size: 1.12em !important;
    padding: 11px 14px !important;
    margin-bottom: 4px !important;
    min-width: 70vw !important;
    border-radius: 14px !important;
  }
  .map-box, #leafletmap, #wazeFrame {
    height: 170px !important;
    min-height: 100px !important;
    max-height: 220px !important;
    border-radius: 12px !important;
  }
  .speech-translate-panels {
    grid-template-columns: 1fr !important;
    gap: 13px !important;
    max-width: 100vw !important;
  }
  .speech-translate-panels .panel {
    border-radius: 13px !important;
    padding: 11px 6px 13px 10px !important;
    font-size: 1.07em !important;
  }
  .footer {
    font-size: .98em !important;
    padding: 13px 0 10vw 0 !important;
  }
  .forecast-day {
    min-width: 46px !important;
    font-size: 0.91em !important;
    padding: 4px 2px !important;
    border-radius: 9px !important;
    margin: 0 1px !important;
  }

}


@media (max-width: 650px) {
  .container {
    box-shadow: none !important;
    border-radius: 0 !important;
    border: none !important;
  }
  .eco-card, .ai-suggestion, .info-panel, .forecast-day, .panel {
    box-shadow: 0 0 16px #0fffc2, 0 0 60px #2196f3, 0 0 8px #44f4ae;
    border: 2px solid #13e6bb;
    background: #142229cc;
  }
}


  </style>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>


  <div class="container">
  <div class="header-row">
    <h1>üå± EcoLife AI</h1>
    <button class="darkmode-btn" id="darkmodeBtn" title="S√∂t√©t m√≥d v√°lt√°s üåô">üåô</button>
  </div>
    <div id="ai-suggestion" class="ai-suggestion">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 16v-4M12 8h.01" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span><strong>AI aj√°nlatod t√∂lt≈ëdik‚Ä¶</strong></span>
    </div>
    <div id="biometeo-forecast-sparkline" style="margin-top:6px; min-height:28px;"></div>

    

    <!-- INFO panelek -->
    <div id="sun-times-panel" class="info-panel sun"></div>
    <div id="pressure-panel" class="info-panel front"></div>
    <div id="forecast-panel" class="forecast-panel"></div>
    <div id="jam-info-panel" class="info-panel jam"></div>
    <div class="section-title">üå§ √âl≈ë √ñko-adatok</div>
    <div class="eco-cards">
  
       <div class="eco-card"><span class="eco-icon">üèôÔ∏è</span><strong>Hely:</strong>
        <small id="city">Bet√∂lt√©s‚Ä¶</small></div>

      <div class="eco-card"><span class="eco-icon">üå°Ô∏è</span><strong>H≈ëm√©rs√©klet:</strong>
        <small id="weather">Bet√∂lt√©s‚Ä¶</small></div> 

            <div class="eco-card">
  <span class="eco-icon">üî•</span>
  <strong>H≈ë√©rzet:</strong>
  <small id="heat-index-panel">Bet√∂lt√©s‚Ä¶</small>
</div>

<div class="eco-card">
  <span class="eco-icon">üåû</span>
  <strong>UV-index el≈ërejelz√©s:</strong>
  <small id="uv-panel">Bet√∂lt√©s‚Ä¶</small>
</div>


      <div class="eco-card">
  <span class="eco-icon">üëï</span>
  <strong>√ñlt√∂z√©k most √©s 8 √≥r√°n bel√ºl:</strong>
  <div id="clothing-now">Jelenleg bet√∂lt√©s...</div>
  <div id="clothing-forecast" style="margin-top:2px;font-size:.96em;color:#287c50"></div>
</div>


      <div class="eco-card"><span class="eco-icon">üå¨Ô∏è</span><strong>Leveg≈ëmin≈ës√©g:</strong>
        <small id="air-quality">Bet√∂lt√©s‚Ä¶</small>
        <div class="badges" id="air-components"></div></div>

      <div class="eco-card"><span class="eco-icon">üå´Ô∏è</span><strong>L√°t√°si viszony, p√°ratartalom, sz√©l:</strong>
        <small id="atm-panel">Bet√∂lt√©s‚Ä¶</small></div>

<div class="eco-card">
  <span class="eco-icon">‚òÅÔ∏è</span>
  <strong>Felh≈ëzet most √©s 8 √≥r√°ra el≈ëre:</strong>
  <small id="cloud-panel">Bet√∂lt√©s‚Ä¶</small>
</div>

<div class="eco-card">
  <span class="eco-icon">üåßÔ∏è</span>
  <strong>Csapad√©k el≈ërejelz√©s:</strong>
  <small id="rain-panel">Bet√∂lt√©s‚Ä¶</small>
</div>


      <div class="eco-card" id="weather-warning-card"><span class="eco-icon">‚õàÔ∏è</span>
        <strong>Vesz√©lyjelz√©s:</strong>
        <div id="weather-warning-details"><small>Bet√∂lt√©s‚Ä¶</small></div></div>

   <div class="eco-card">
  <span class="eco-icon">üåÉ</span>
  <strong>Csillagmegfigyel√©si ablak:</strong>
  <small id="astro-window-panel">Bet√∂lt√©s‚Ä¶</small>
</div>


<div class="eco-card">
  <span class="eco-icon">‚òÑÔ∏è</span>
  <strong>Meteorraj / Napfogyatkoz√°s:</strong>
  <small id="meteor-panel">Bet√∂lt√©s‚Ä¶</small>
</div>

<div class="eco-card">
  <span class="eco-icon">üåå</span>
  <strong>Sarki f√©ny (Aurora):</strong>
  <small id="aurora-panel">Bet√∂lt√©s‚Ä¶</small>
</div>

<div class="eco-card">
  <span class="eco-icon">üåê</span>
  <strong>F√∂ldreng√©s (utols√≥ 24 √≥ra):</strong>
  <small id="earthquake-panel">Bet√∂lt√©s‚Ä¶</small>
</div>


      <div id="allergen-alert-bar" style="display:none;padding:9px 9px 9px 12px;background:#ffe6e6;color:#b51616;border-radius:11px;margin-bottom:8px;font-weight:600;font-size:1.09em;text-align:left;">
</div>
</div>
</div>
   

<div class="speech-translate-panels">
  <div class="panel">
    <div id="speech-translate-panel" style="display:flex;align-items:center;gap:12px;justify-content:flex-start;">
      <button id="micBtn" style="font-size:1.7em;padding:5px 12px;border-radius:50%;border:2px solid #38d473;background:#e3ffe6;cursor:pointer;">üé§</button>
      <span style="font-weight:600;font-size:1.08em;">Hangfelismer√©s</span>
    </div>
    <div id="speechResult" style="min-height:2em;text-align:left;font-size:1.09em;color:#207b49;padding:4px 0 8px 0;border-bottom:1px solid #e8f8f0;"></div>
    <div style="font-size:.96em;color:#888;">(Itt jelenik meg amit bemondt√°l ‚Äì ezt m√°sold √°t a Google Translate-be!)</div>
  </div>
  <div class="panel" style="text-align:center;">
    <a href="https://translate.google.com/" target="_blank" style="display:inline-block;padding:12px 26px;border-radius:13px;background:#36a5f2;color:#fff;font-weight:600;text-decoration:none;margin-top:8px;font-size:1.13em;">Google Translate megnyit√°sa</a>
    <div style="font-size:.97em;color:#247a36;margin-top:13px;">
      <b>Google Translate</b><br>
      M√°sold be ide a bal oldali sz√∂veget, v√°laszd ki a c√©lnyelvet!
    </div>
  </div>
</div>

<div class="map-header" style="display:flex;justify-content:center;gap:18px;margin-bottom:10px;">

  <button id="btn2d" class="map-btn selected">2D t√©rk√©p</button>
  <button id="btnstreet" class="street-btn"><span style="font-size:1.2em;">üì∑</span> Utcak√©p</button>
</div>

<!-- K√∂z√∂s t√©rk√©ptart√≥ doboz, max-width egyezik! -->
<div style="width:100%;max-width:600px;margin:0 auto;">
  <div class="ecomap-title" style="text-align:center;font-size:1.22em;font-weight:600;margin-bottom:10px;">
    üó∫Ô∏è √âl≈ë 2D t√©rk√©p & POI / Utcak√©p
  </div>
  <div class="map-box" style="width:100%;margin-bottom:15px;">
    <div id="leafletmap" style="width:100%;height:250px;border-radius:14px;box-shadow:0 2px 14px #9ee0b1;"></div>
  </div>

    <!-- Waze t√©rk√©p -->
  <div class="map-box" style="width:100%;margin-bottom:0;">
    <iframe id="wazeFrame"
      src="https://embed.waze.com/iframe?zoom=11&lat=47.191&lon=19.445"
      width="100%" height="250"
      style="width:100%;border-radius:14px;border:2px solid #c3ebca;box-shadow:0 2px 14px #9ee0b1;display:block;margin:0 auto;"
      allowfullscreen></iframe>
    <div style="font-size:.96em;color:#207b49;margin-top:3px;text-align:center;">
      Waze forgalmi t√©rk√©p (nagy√≠that√≥, friss√ºl≈ë adatok)
      <br>
      <a href="https://www.waze.com/hu/live-map/" target="_blank" style="color:#1984ce;">Waze Live Map (√∫j ablakban)</a>
    </div>
  </div>

</div>





    <div id="traffic-info" style="text-align:center; margin:10px 0; color:#1e6b1a; font-size:1.08em;"></div>
    
    
    <div id="omsz-radar" style="margin:18px 0 0 0;text-align:center;">
      <img src="https://www.met.hu/idojaras/radar/radar_animation.gif"
       alt="OMSZ radar"
       style="max-width:98%;border-radius:16px;box-shadow:0 2px 18px #8888;">
      <br>
      <span style="font-size:.98em;color:#237a36;">
        OMSZ hivatalos radar (statikus k√©p, 15p friss√≠t√©s)
      </span>
      <div style="margin-top:12px;">
        <button onclick="window.open('https://www.met.hu/idojaras/aktualis_idojaras/radar/', '_blank', 'width=950,height=750')"
          style="background:#e8ffeb;color:#247a36;padding:7px 19px;border-radius:9px;border:none;cursor:pointer;font-size:1.06em;">
          OMSZ Radar (val√≥sidej≈±, teljes oldal)
        </button>
      </div>
    </div>
    <div class="footer">
      &copy; 2025 EcoLife AI | <span style="color:#7bbd97">Mobil-optimaliz√°lt, radar+esem√©nyek, el≈ërejelz√©s, s√∂t√©t m√≥d</span>
    </div>
    <div class="modal-bg" id="alertModal">
      <div class="modal-card">
        <h3 id="modalTitle">Figyelem!</h3>
        <div class="modal-msg" id="modalMsg">Valamilyen vesz√©ly!</div>
        <button class="modal-ok" onclick="document.getElementById('alertModal').style.display='none'">OK</button>
      </div>
    </div>
  </div>


<!-- T√ºnet r√∂gz√≠t√©s + AI elemz≈ë gombok -->
<div style="margin:28px 0 8px 0;text-align:center;">
  <button onclick="openSymptomDiary()" style="font-weight:600;margin-right:14px;">T√ºnet r√∂gz√≠t√©s</button>
  <button onclick="showSymptomAnalysis()" style="font-weight:600;margin-right:14px;">AI elemz≈ë</button>
  <button onclick="deleteSymptomDiary()" style="font-weight:600;background:#f55;color:#fff;
    border:none;padding:9px 20px;border-radius:18px;box-shadow:0 2px 12px #f55a;cursor:pointer;">Napl√≥ t√∂rl√©se</button>
</div>


<!-- T√ºnet r√∂gz√≠t√©s modal -->
<div id="symptomModal" style="display:none;position:fixed;top:16%;left:50%;transform:translateX(-50%);
  background:#fff; color:#202e28; z-index:1111; padding:22px 22px 14px 22px; border-radius:20px;
  box-shadow:0 2px 22px #0005;width:90vw;max-width:410px;">
  <h3 style="margin-top:0;color:#24b06b;font-weight:700;">Mai t√ºnetek</h3>
  <label style="color:#16513f;"><input type="checkbox" id="cb-fejfajas" style="accent-color:#16e5bb;margin-right:7px;"> Fejf√°j√°s</label><br>
  <label style="color:#16513f;"><input type="checkbox" id="cb-faradtsag" style="accent-color:#16e5bb;margin-right:7px;"> F√°radts√°g</label><br>
  <label style="color:#16513f;"><input type="checkbox" id="cb-alvaszavar" style="accent-color:#16e5bb;margin-right:7px;"> Alv√°szavar</label><br>
  <label style="color:#16513f;"><input type="checkbox" id="cb-ingerkekenyseg" style="accent-color:#16e5bb;margin-right:7px;"> Ingerl√©kenys√©g</label><br>
  <label style="color:#16513f;">Egy√©b: <input type="text" id="inp-egyeb" style="width:68%;margin-left:3px;color:#202e28;background:#f4fffb;border-radius:8px;padding:3px 8px;border:1px solid #b6e5d1;"></label><br>
  <div style="margin-top:16px;">
    <button onclick="saveSymptomDiary()" style="font-weight:600;background:linear-gradient(90deg,#24b06b,#2dd0ff);color:#fff;border:none;border-radius:18px;padding:9px 28px;font-size:1.07em;box-shadow:0 2px 12px #16e5bb28;cursor:pointer;">Ment√©s</button>
    <button onclick="document.getElementById('symptomModal').style.display='none'" style="float:right;margin-top:2px;font-weight:600;background:#e9ecef;color:#2b2b2b;border:none;border-radius:18px;padding:8px 22px;font-size:1.02em;box-shadow:0 2px 7px #bbb4;cursor:pointer;">Bez√°r</button>
  </div>
</div>

<!-- AI elemz√©s modal -->
<div id="symptom-analysis-modal" style="display:none;position:fixed;top:14%;left:50%;transform:translateX(-50%);
  background:#f6fff6; color:#204d3b; z-index:1120; padding:22px 18px 22px 18px; border-radius:18px;
  box-shadow:0 2px 22px #0005; width:95vw; max-width:490px;">
  <h3 style="margin-top:0;color:#24b06b;font-weight:700;">T√ºnet‚Äìbiometeo √∂sszef√ºgg√©sek (AI)</h3>
  <div id="symptom-analysis-result" style="margin-bottom:8px"></div>
  <canvas id="symptom-diagram" width="400" height="110" style="background:#fff;border-radius:8px"></canvas>
  <button onclick="document.getElementById('symptom-analysis-modal').style.display='none'" style="margin-top:13px;font-weight:600;background:#e9ecef;color:#2b2b2b;border:none;border-radius:18px;padding:8px 22px;font-size:1.02em;box-shadow:0 2px 7px #bbb4;cursor:pointer;">Bez√°r</button>
</div>


<script>



function formatEventTime(dtString, nowString) {
  let dt = new Date(dtString);
  let now = new Date(nowString || Date.now());
  let hour = ("0"+dt.getHours()).slice(-2);
  let min = ("0"+dt.getMinutes()).slice(-2);

  if (
    now.getFullYear() === dt.getFullYear() &&
    now.getMonth() === dt.getMonth()
  ) {
    if (dt.getDate() === now.getDate()) {
      return `ma ${hour}:${min}`;
    } else if (dt.getDate() === now.getDate() + 1) {
      return `holnap ${hour}:${min}`;
    }
  }
  return `${dt.getFullYear()}.${("0"+(dt.getMonth()+1)).slice(-2)}.${("0"+dt.getDate()).slice(-2)}. ${hour}:${min}`;
}


const meteorShowers = [
  { name: "Quadrantid√°k", from: "2025-01-03", to: "2025-01-04" },
  { name: "Perseid√°k", from: "2025-08-11", to: "2025-08-13" },
  { name: "Geminid√°k", from: "2025-12-13", to: "2025-12-15" }
];
const solarEclipses = [
  { name: "Teljes napfogyatkoz√°s", date: "2026-08-12" }
];
function updateMeteorPanel() {
  const todayStr = new Date().toISOString().slice(0,10);
  const activeShowers = meteorShowers.filter(m =>
    todayStr >= m.from && todayStr <= m.to
  );
  const eclipseToday = solarEclipses.find(e =>
    todayStr === e.date
  );
  let msg = "";
  if (activeShowers.length)
    msg += `Ma √©jjel <b>${activeShowers.map(m=>m.name).join(", ")}</b> maximum! Figyeld az eget!<br>`;
  if (eclipseToday)
    msg += `Ma <b>${eclipseToday.name}</b> ‚Äì r√©szletek: <a href="https://www.timeanddate.com/eclipse/" target="_blank">id≈ëpont, info</a>`;
  if (!msg) msg = "Ma nincs kiemelked≈ë meteorraj/nagyszab√°s√∫ √©gi esem√©ny.";
  document.getElementById('meteor-panel').innerHTML = msg;
}
function updateAuroraPanel() {
  fetch("https://services.swpc.noaa.gov/json/ovation_aurora_latest.json")
    .then(r => r.json())
    .then(data => {
      let kp = Number(data.Kp || data.kp || 0);
      let msg = "";
      if (kp < 5) {
        msg = "Ma nem v√°rhat√≥ sarki f√©ny Magyarorsz√°gon.<br>Kp-index: <b>" + kp + "</b>";
      } else if (kp >= 5 && kp < 7) {
        msg = "Nagyon kis es√©llyel, de el≈ëfordulhat halv√°ny sarki f√©ny.<br>Kp-index: <b>" + kp + "</b><br><span style='color:#f4d442'>Tiszta, s√∂t√©t √©gbolt kell!</span>";
      } else if (kp >= 7 && kp < 8) {
        msg = "<b>Lehets√©ges halv√°ny sarki f√©ny!</b><br>Kp-index: <b>" + kp + "</b><br><span style='color:#67f414'>Figyeld az √©szaki √©gboltot!</span>";
      } else if (kp >= 8) {
        msg = "<b>Er≈ës geom√°gneses vihar!</b><br><span style='color:#7ef441'>Magyarorsz√°g nagy r√©sz√©n is l√°that√≥ lehet a sarki f√©ny!</span><br>Kp-index: <b>" + kp + "</b>";
      }
      document.getElementById('aurora-panel').innerHTML = msg;
    })
    .catch(() => {
      document.getElementById('aurora-panel').textContent = "Sarki f√©ny el≈ërejelz√©s nem el√©rhet≈ë.";
    });
}

function updateRainPanel(weather) {
  if (!weather.hourly || !weather.hourly.precipitation || !weather.hourly.time) {
    document.getElementById('rain-panel').textContent = "Nincs adat.";
    return;
  }
  const now = new Date();
  const hours = weather.hourly.time;
  const precip = weather.hourly.precipitation;
  let todayStr = now.toISOString().slice(0, 10);

  // Ma melyik √≥r√°ban kezd el esni? (az els≈ë pozit√≠v √©rt√©k)
  let rainStartIdx = -1, rainEndIdx = -1, rainSum = 0;
  for (let i = 0; i < hours.length; i++) {
    if (!hours[i].startsWith(todayStr)) continue;
    if (precip[i] > 0 && rainStartIdx === -1) rainStartIdx = i;
    if (rainStartIdx > -1 && precip[i] === 0 && rainEndIdx === -1) rainEndIdx = i;
    if (rainStartIdx > -1 && rainEndIdx === -1) rainSum += precip[i];
  }
  // Ha nap v√©g√©ig folyamatos az es≈ë:
  if (rainStartIdx > -1 && rainEndIdx === -1) rainEndIdx = hours.length-1;

  let txt = "";
  if (rainStartIdx === -1) {
    txt = "Ma <b>nem v√°rhat√≥ csapad√©k</b>.";
  } else {
    let startH = new Date(hours[rainStartIdx]).getHours();
    let endH = new Date(hours[rainEndIdx]).getHours();
    let tartam = endH - startH;
    txt = `Es≈ë v√°rhat√≥ <b>${startH}:00</b>-t√≥l <b>${endH}:00</b>-ig (${tartam} √≥ra).<br>`;
    txt += `V√°rhat√≥ √∂sszes csapad√©k: <b>${rainSum.toFixed(1)} mm</b>`;
  }
  document.getElementById('rain-panel').innerHTML = txt;
}


function updateEarthquakePanel() {
  // USGS GeoJSON API ‚Äì M0+ f√∂ldreng√©sek az elm√∫lt 24 √≥r√°ban, Eur√≥pa
  fetch("https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson")
    .then(r => r.json())
    .then(data => {
      // Magyarorsz√°g, szomsz√©dos r√©gi√≥ bounding box: 45-49N, 16-23E
      const quakes = data.features.filter(f => {
        const [lon, lat, depth] = f.geometry.coordinates;
        return lat > 45 && lat < 49 && lon > 16 && lon < 23;
      });
      let msg = "";
      if (!quakes.length) {
        msg = "Nincs jelentett f√∂ldreng√©s Magyarorsz√°gon az elm√∫lt 24 √≥r√°ban.";
      } else {
        // Csak a leger≈ësebb (legnagyobb magnit√∫d√≥) f√∂ldreng√©st mutatjuk
        quakes.sort((a, b) => b.properties.mag - a.properties.mag);
        const q = quakes[0];
        const mag = q.properties.mag;
        const place = q.properties.place.replace("of ", "");
        const depth = Math.round(q.geometry.coordinates[2]);
        const time = new Date(q.properties.time).toLocaleString("hu-HU", {hour:"2-digit", minute:"2-digit", day:"2-digit", month:"2-digit"});
        msg = `Utols√≥ 24 √≥r√°ban: <b>${mag}M</b>, ${place}, <span style="color:#4d6f8c">${depth} km m√©lys√©gben</span> <span style="color:#666">(${time})</span>`;
        if (quakes.length > 1) msg += `<br><span style="color:#8c8c8c">(${quakes.length} reng√©s detekt√°lva)</span>`;
      }
      document.getElementById('earthquake-panel').innerHTML = msg;
    })
    .catch(() => {
      document.getElementById('earthquake-panel').textContent = "Nem siker√ºlt lek√©rni a f√∂ldreng√©s adatokat.";
    });
}



function updateUvPanel(weather) {
  const uvElem = document.getElementById('uv-panel');
  const now = new Date();

  // Napkelte √©s napnyugta (pl. 2025-09-07T05:57)
  let sunrise = weather.daily && weather.daily.sunrise && weather.daily.sunrise[0]
      ? new Date(weather.daily.sunrise[0])
      : null;
  let sunset = weather.daily && weather.daily.sunset && weather.daily.sunset[0]
      ? new Date(weather.daily.sunset[0])
      : null;

  // Ha nincs napkelte/napnyugta adat, fallback: 6‚Äì19h
  if (!sunrise || !sunset) {
    const hour = now.getHours();
    if (hour < 6 || hour >= 19) {
      uvElem.textContent = "Most nincs UV-sug√°rz√°s ‚Äì este van!";
      return;
    }
  } else {
    // Ha most naplemente ut√°n vagyunk, √≠rja ezt:
    if (now < sunrise || now >= sunset) {
      uvElem.textContent = "Most nincs UV-sug√°rz√°s ‚Äì naplemente ut√°n!";
      return;
    }
  }

  // ... innen j√∂het a megszokott UV-panel logika:
  if (!weather.hourly || !weather.hourly.uv_index || !weather.hourly.time) {
    uvElem.textContent = "Nincs adat.";
    return;
  }
  let maxUv = -1, maxIdx = -1;
  let hours = [];
  let todayStr = now.toISOString().slice(0, 10);
  for (let i = 0; i < weather.hourly.time.length; i++) {
    if (weather.hourly.time[i].slice(0,10) === todayStr) {
      let uv = weather.hourly.uv_index[i];
      if (uv > maxUv) {
        maxUv = uv;
        maxIdx = i;
      }
      let h = Number(weather.hourly.time[i].slice(11,13));
      if (uv >= 7 && h >= 11 && h <= 16) {
        hours.push(`${h}:00 (${uv.toFixed(1)})`);
      }
    }
  }
  let msg = "";
  if (maxUv < 0) {
    msg = "Nincs adat.";
  } else if (hours.length) {
    msg = `Ma <b>${hours.join(", ")}</b> extr√©m UV v√°rhat√≥! <span style="color:#bb3d14">Ker√ºld a t≈±z≈ë napot!</span>`;
  } else if (maxUv >= 7) {
    let h = weather.hourly.time[maxIdx].slice(11,13);
    msg = `Ma <b>${h}:00</b>-kor extr√©m UV v√°rhat√≥ (${maxUv.toFixed(1)}). <span style="color:#bb3d14">Fokozott v√©delem sz√ºks√©ges!</span>`;
  } else {
    msg = `Ma a maximum UV-index: <b>${maxUv.toFixed(1)}</b> (${maxUv >= 5 ? "magas" : "m√©rs√©kelt"}).`;
  }
  uvElem.innerHTML = msg;
}



function getDressTip(temp, wind, humidity) {
  let dress = "";
  if (temp >= 29) dress = "K√∂nny≈± ny√°ri ruha, sapka, sok folyad√©k!";
  else if (temp >= 22) dress = "R√∂vid ujj√∫ p√≥l√≥, k√∂nny≈± nadr√°g aj√°nlott.";
  else if (temp >= 17) dress = "Hossz√∫ ujj√∫ p√≥l√≥, v√©kony pul√≥ver.";
  else if (temp >= 12) dress = "K√∂nny≈± dzseki, r√©teges √∂lt√∂zet.";
  else if (temp >= 5) dress = "Melegebb kab√°t, pul√≥ver, s√°l.";
  else if (temp >= -3) dress = "T√©li kab√°t, sapka, s√°l, keszty≈±!";
  else dress = "Extr√©m hideg! Vastag, r√©teges t√©li √∂lt√∂zet, sapka, s√°l, keszty≈± k√∂telez≈ë!";
  if (wind > 18) dress += " (Er≈ës sz√©l miatt hidegebbnek √©rz≈ëdik!)";
  if (humidity > 85 && temp > 18) dress += " (Magas p√°ratartalom miatt f√ºlledtebbnek √©rz≈ëdik.)";
  return dress;
}

function makeAirBadge(type, val) {
  let bg = "#ebffe8", txt = "#234";
  if (type === "pm10") {
    if (val >= 50) { bg = "#e66565"; txt="#fff"; }
    else if (val >= 25) { bg = "#ffe66a"; txt="#333"; }
    else { bg = "#e7ffd8"; txt="#246c38"; }
  }
  if (type === "no2") {
    if (val >= 0.2) { bg = "#e66565"; txt="#fff"; }
    else if (val >= 0.1) { bg = "#ffe66a"; txt="#333"; }
    else { bg = "#e7ffd8"; txt="#246c38"; }
  }
  if (type === "o3") {
    if (val >= 120) { bg = "#e66565"; txt="#fff"; }
    else if (val >= 90) { bg = "#ffe66a"; txt="#333"; }
    else { bg = "#e7ffd8"; txt="#246c38"; }
  }
  if (type === "co") {
    if (val >= 6000) { bg = "#e66565"; txt="#fff"; }
    else if (val >= 4000) { bg = "#ffe66a"; txt="#333"; }
    else { bg = "#e7ffd8"; txt="#246c38"; }
  }
  // magyar felirat
  let label = type === "pm10" ? "PM10" :
              type === "no2" ? "NO‚ÇÇ" :
              type === "o3" ? "O‚ÇÉ" :
              type === "co" ? "CO" : type;
  return `<span class="badge" style="background:${bg};color:${txt};font-weight:600;margin-right:5px;margin-bottom:4px;">
    ${label}: ${val} ¬µg/m¬≥
  </span>`;
}


function updateAstroWindowPanel(weather) {
  let cloudArr = weather.hourly.cloudcover || [];
  let rainArr = weather.hourly.precipitation || [];
  let timeArr = weather.hourly.time || [];
  let bestStart = null, bestLen = 0;

  // Este 21:00‚Äì03:00 k√∂z√∂tt keres√ºnk legal√°bb 2 egym√°st k√∂vet≈ë der√ºlt √≥r√°t
  for (let i = 0; i < timeArr.length - 1; i++) {
    let dt = new Date(timeArr[i]);
    let hour = dt.getHours();
    // Csak este/√©jjel, 21:00-t√≥l 3:00-ig (m√°snap hajnal)
    if (!((hour >= 21 && hour <= 23) || (hour >= 0 && hour <= 3))) continue;

    let ok = (cloudArr[i] < 30 && rainArr[i] === 0 && cloudArr[i+1] < 30 && rainArr[i+1] === 0);
    if (ok) {
      bestStart = timeArr[i];
      bestLen = 2;
      // n√©zd tov√°bb, h√°ny egym√°s ut√°ni der√ºlt √≥ra van
      for (let j = i+2; j < timeArr.length; j++) {
        let h2 = new Date(timeArr[j]).getHours();
        if (!((h2 >= 21 && h2 <= 23) || (h2 >= 0 && h2 <= 3))) break;
        if (cloudArr[j] < 30 && rainArr[j] === 0) bestLen++;
        else break;
      }
      break;
    }
  }

  let txt = "";
  if (bestStart) {
    let dt = new Date(bestStart);
    let timeStr = dt.toLocaleTimeString('hu-HU',{hour:'2-digit',minute:'2-digit'});
    txt = `Ma este <b>${timeStr}</b>-t√≥l legal√°bb ${bestLen} √≥r√°n √°t der√ºlt √©gbolt ‚Äì kiv√°l√≥ felt√©telek csillagmegfigyel√©shez!`;
  } else {
    txt = "Ma este 21:00 ut√°n borult vagy felh≈ës √©gbolt v√°rhat√≥ ‚Äì nem ide√°lis csillag√°szathoz.";
  }
  document.getElementById('astro-window-panel').innerHTML = txt;
}


// --- 8 √≥r√°s el≈ërejelz√©s ki√≠r√°sa
function updateClothingBlock(weather) {
  // Jelenlegi adatok
  let tNow = weather.current_weather.temperature;
  let idxNow = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
  let windNow = weather.hourly.windspeed_10m[idxNow] || 0;
  let humNow = weather.hourly.relative_humidity_2m[idxNow] || 0;
  document.getElementById('clothing-now').innerHTML = "<b>Most:</b> " + getDressTip(tNow, windNow, humNow);

  // 8 √≥r√°val k√©s≈ëbbi adatok (ha el√©rhet≈ë)
  let idx8h = idxNow + 8;
  if (weather.hourly.temperature_2m[idx8h] !== undefined) {
    let t8h = weather.hourly.temperature_2m[idx8h];
    let w8h = weather.hourly.windspeed_10m[idx8h] || 0;
    let h8h = weather.hourly.relative_humidity_2m[idx8h] || 0;
    document.getElementById('clothing-forecast').innerHTML =
      "<b>V√°rhat√≥an 8 √≥ra m√∫lva:</b> " + getDressTip(t8h, w8h, h8h) +
      ` <span style="color:#7ba886;font-size:.93em">(${Math.round(t8h)}¬∞C)</span>`;
  } else {
    document.getElementById('clothing-forecast').innerHTML = "El≈ërejelz√©s nem el√©rhet≈ë.";
  }
}

function renderBioMeteoSparkline(weather, atm, air) {
  if (!weather.hourly || !weather.hourly.time) return "";
  let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
  if (nowIdx < 0) nowIdx = 0;

  let html = `<div id="biometeo-sparkline-row" style="display:flex;gap:2px;align-items:flex-end;">`;
  // *** 24 √≥r√°s ciklus ***
  for (let i = nowIdx; i < Math.min(weather.hourly.time.length, nowIdx+24); i++) {
    let biom = calcBiometeoLevel(weather, atm, air, i, nowIdx); // most √°tadja a nowIdx-et is!
    let terheles = biom.level;
    let reasons = biom.reasons.length ? biom.reasons : ["‚Äì"];
    let color = ["#21d687","#dbb52d","#e6664c"][terheles];
    let hour = new Date(weather.hourly.time[i]).getHours();
    let levelText = ["Alacsony","K√∂zepes","Magas"][terheles];
    // Magyar√°zat: ok-lista magyarul, szebb form√°ban
    let magyarOk = reasons.map(r => {
      if (r === "front") return "front";
      if (r === "p√°ratartalom") return "p√°ratartalom";
      if (r === "sz√©l") return "er≈ës sz√©l";
      if (r === "UV") return "magas UV";
      if (r === "l√©gszennyez√©s") return "l√©gszennyez√©s";
      return r;
    }).join(", ");
    html += `<div class="biometeo-bar" 
        data-hour="${hour}" 
        data-level="${levelText}" 
        data-reasons="${magyarOk}"
        style="width:13px;height:${18+terheles*14}px;background:${color};border-radius:4px 4px 0 0;cursor:pointer;"
        title="${hour}:00 ‚Äì ${levelText} (${magyarOk})"
      ></div>`;
  }
  html += `</div>
  <div id="biometeo-bar-info" style="font-size:.98em;color:#7ba886;margin-top:2px;min-height:20px;text-align:center;"></div>
  `;
  document.getElementById("biometeo-forecast-sparkline").innerHTML = html;

  // --- Touch/hover esem√©ny mobilra/PC-re:
  document.querySelectorAll('.biometeo-bar').forEach(bar => {
    bar.addEventListener('mouseover', function() {
      document.getElementById('biometeo-bar-info').innerHTML =
        `<b>${this.dataset.hour}:00</b> ‚Äì <b>${this.dataset.level}</b> (${this.dataset.reasons})`;
    });
    bar.addEventListener('mouseout', function() {
      document.getElementById('biometeo-bar-info').textContent = '';
    });
    // Mobilon tap:
    bar.addEventListener('touchstart', function(e) {
      document.getElementById('biometeo-bar-info').innerHTML =
        `<b>${this.dataset.hour}:00</b> ‚Äì <b>${this.dataset.level}</b> (${this.dataset.reasons})`;
      e.preventDefault();
    });
  });
}




// === SUN TIMES (napkelte/napnyugta) ===
function getSunTimes(lat, lon) {
  const d = new Date();
  const y = d.getFullYear(), m = d.getMonth()+1, day = d.getDate();
  return fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&date=${y}-${m<10?'0'+m:m}-${day<10?'0'+day:day}&formatted=0`)
    .then(res => res.json())
    .then(data => ({
      sunrise: new Date(data.results.sunrise).toLocaleTimeString('hu-HU',{hour:'2-digit',minute:'2-digit'}),
      sunset: new Date(data.results.sunset).toLocaleTimeString('hu-HU',{hour:'2-digit',minute:'2-digit'})
    }));
}

// --- BKK Budapest buszmeg√°ll√≥ √©l≈ë j√°rat inf√≥ lek√©r√©se ---
function showBkkBusArrivals(stopId, marker) {
  // Mostani id≈ë (√≥ra:perc form√°tum)
  const now = new Date();
  const nowStr = ("0" + now.getHours()).slice(-2) + ":" + ("0" + now.getMinutes()).slice(-2);
  // Keresd ki az indul√°sokat az adott meg√°ll√≥b√≥l, amelyek m√©g el≈ëtted vannak ma
  let departures = stopTimes.filter(s =>
    s.stop_id === stopId && s.departure >= nowStr
  );
  // Ha nincs m√°r indul√°s ma, jelezz√ºk
  if (!departures.length) {
    marker.bindPopup("<b>Ma m√°r nincs indul√°s ebb≈ël a meg√°ll√≥b√≥l.</b>").openPopup();
    return;
  }
  // Csak az els≈ë 8 indul√°st mutatjuk (vagy amennyit szeretn√©l)
  departures = departures.slice(0, 8);
  let info = departures.map(arr =>
  `<b>${arr.route_id}</b> ‚Üí <span style="color:#247a36">${arr.trip_headsign||""}</span> ‚Äì indul√°s: <b>${arr.departure}</b>`
).join("<br>");

  marker.bindPopup(`<b>K√∂vetkez≈ë indul√°sok (nem √©l≈ë menetrend):</b><br>${info}`).openPopup();
}


// --- M√ºnchen MVV √©l≈ë indul√°sok ---
async function showMunichStopDepartures(stopName, marker) {
  try {
    const res = await fetch(`https://api.mvv.app/api/locate?query=${encodeURIComponent(stopName)}`);
    const locations = await res.json();
    if (!locations.length) {
      marker.bindPopup(`<b>Nincs ilyen meg√°ll√≥ az MVV rendszer√©ben!</b>`).openPopup();
      return;
    }
    let stopId = locations[0].id;
    const depRes = await fetch(`https://api.mvv.app/api/departure?station=${stopId}`);
    const depData = await depRes.json();
    if (!depData.departures || !depData.departures.length) {
      marker.bindPopup("<b>Nincs indul√°s az elk√∂vetkez≈ë 30 percben!</b>").openPopup();
      return;
    }
    function getTransportIcon(type, label) {
      if (/^U\d+/.test(label))   return "üöá";
      if (/^S\d+/.test(label))   return "üöà";
      if (/^(RB|RE|IC|EC|ICE)/.test(label)) return "üöÑ";
      if (/^(N?\d{1,3})$/.test(label)) return "üöå";
      if (/^(T|Tram|\d{1,2})/.test(label)) return "üöã";
      return "üöç";
    }
    let html = depData.departures.slice(0,14).map(dep =>
      `<span style="font-size:1.3em">${getTransportIcon(dep.product, dep.label)}</span> 
      <b>${dep.label}</b> ‚Üí <span style="color:#1a8fba">${dep.destination}</span>
      <span style="color:#5c9d33;">(${dep.departureTimeMinutes} perc m√∫lva)</span>`
    ).join('<br>');
    marker.bindPopup(
      `<div style="min-width:210px">
        <b>√âl≈ë indul√°sok (${stopName}):</b><br>
        ${html}
        <br><a href="https://efa.mvv-muenchen.de/index.html#trip@enquiry" target="_blank" style="font-size:.93em;color:#2486cc;">MVV Fahrplanauskunft</a>
      </div>`
    ).openPopup();
  } catch (e) {
    marker.bindPopup("<b>Nem siker√ºlt lek√©rni az √©l≈ë menetrendet.</b>").openPopup();
  }
}

// --- H≈ë√©rzet sz√°m√≠t√°s: Humidex, Heat Index, Windchill ---
function calcHumidex(tempC, humidity) {
  let e = (humidity/100) * 6.105 * Math.exp(17.27 * tempC / (237.7 + tempC));
  return Math.round(tempC + 0.5555 * (e - 10));
}
function calcHeatIndex(tempC, humidity) {
  let tempF = tempC * 9/5 + 32;
  let hiF = -42.379 + 2.04901523*tempF + 10.14333127*humidity
    - 0.22475541*tempF*humidity
    - 0.00683783*tempF*tempF
    - 0.05481717*humidity*humidity
    + 0.00122874*tempF*tempF*humidity
    + 0.00085282*tempF*humidity*humidity
    - 0.00000199*tempF*tempF*humidity*humidity;
  if (hiF < tempF) hiF = tempF;
  return Math.round((hiF-32)*5/9);
}
function calcWindChill(tempC, windKmh) {
  if (tempC > 10 || windKmh < 4.8) return tempC;
  return Math.round(13.12 + 0.6215*tempC - 11.37*Math.pow(windKmh,0.16) + 0.3965*tempC*Math.pow(windKmh,0.16));
}

// --- BIOMETEOROL√ìGIAI TERHEL√âS KI√âRT√âKEL√âS ---
function getBioMeteoSummary(weather, atm, air) {
  const biometeoDetailedInfo = {
    "gyors l√©gnyom√°scs√∂kken√©s": "A hirtelen l√©gnyom√°scs√∂kken√©s √©rz√©kenyekn√©l fejf√°j√°st, migr√©nt, v√©rnyom√°s-ingadoz√°st okozhat.",
    "gyors l√©gnyom√°sn√∂veked√©s": "A l√©gnyom√°s gyors emelked√©se idegrendszeri zavarokat, sz√©d√ºl√©st, √°lmoss√°got okozhat.",
    "magas p√°ratartalom": "A magas p√°ratartalom f√°radts√°got, b√°gyadts√°got, nehezebb l√©gz√©st, fullad√°st v√°lthat ki.",
    "alacsony p√°ratartalom": "Az alacsony p√°ratartalom k√∂h√∂g√©st, szem- √©s ny√°lkah√°rtya-irrit√°ci√≥t okozhat.",
    "er≈ës sz√©l": "Az er≈ës sz√©l ingerl√©kenys√©get, fejf√°j√°st, koncentr√°ci√≥zavart okozhat.",
    "magas UV-sug√°rz√°s": "A magas UV-sug√°rz√°s fejf√°j√°st, b≈ërp√≠rt, szemirrit√°ci√≥t okozhat. Fokozott v√©delem sz√ºks√©ges.",
    "l√©gszennyez√©s": "A l√©gszennyez√©s (pl. PM10, NO‚ÇÇ, O‚ÇÉ) fejf√°j√°st, k√∂h√∂g√©st, l√©g√∫ti panaszokat, f√°radts√°got, asztm√°s t√ºneteket v√°lthat ki, k√ºl√∂n√∂sen √©rz√©kenyekn√©l, id≈ësekn√©l, gyerekekn√©l."
  };
  let terheles = 0, risks = [];

  // --- L√âGNYOM√ÅS V√ÅLTOZ√ÅS ---
  let pressureDrop = false, pressureRise = false;
  if (weather && weather.hourly && weather.hourly.pressure_msl && weather.hourly.time) {
    let nowIdx = weather.hourly.time.findIndex(x => x.startsWith(weather.current_weather.time.slice(0, 13)));
    if (nowIdx < 0) nowIdx = 0;
    let curr = weather.hourly.pressure_msl[nowIdx];
    let ahead = [];
    for (let i = nowIdx + 1; i < Math.min(nowIdx + 5, weather.hourly.pressure_msl.length); i++) {
      ahead.push(weather.hourly.pressure_msl[i]);
    }
    if (ahead.length > 0) {
      let min = Math.min(...ahead), max = Math.max(...ahead);
      if (curr - min >= 5) { pressureDrop = true; terheles++; risks.push("gyors l√©gnyom√°scs√∂kken√©s"); }
      if (max - curr >= 5) { pressureRise = true; terheles++; risks.push("gyors l√©gnyom√°sn√∂veked√©s"); }
    }
  }

  // --- P√ÅRATARTALOM ---
  let highHumidity = atm && atm.humidity && atm.humidity >= 75;
  let lowHumidity = atm && atm.humidity && atm.humidity <= 35;
  if (highHumidity) { terheles++; risks.push("magas p√°ratartalom"); }
  if (lowHumidity) { terheles++; risks.push("alacsony p√°ratartalom"); }

  // --- SZ√âL ---
  let strongWind = atm && atm.wind && atm.wind >= 30;
  if (strongWind) { terheles++; risks.push("er≈ës sz√©l"); }

  // --- UV INDEX --- (csak ha el√©rhet≈ë)
  let highUV = false;
  if (weather && weather.hourly && weather.hourly.uv_index && weather.hourly.time) {
    let nowIdx = weather.hourly.time.findIndex(x => x.startsWith(weather.current_weather.time.slice(0, 13)));
    if (nowIdx < 0) nowIdx = 0;
    let nextUV = weather.hourly.uv_index[nowIdx];
    if (nextUV >= 6) { highUV = true; terheles++; risks.push("magas UV-sug√°rz√°s"); }
  }

  // --- L√âGSZENNYEZETTS√âG (PM2.5, O3, NO2, CO) ---
  let airPol = air && air.components && (
    (air.components.pm2_5 && air.components.pm2_5 > 18) ||
    (air.components.o3 && air.components.o3 > 80) ||
    (air.components.pm10 && air.components.pm10 > 25) ||
    (air.components.no2 && air.components.no2 > 0.1) ||
    (air.components.co && air.components.co > 4000)
  );
  if (airPol) { terheles++; risks.push("l√©gszennyez√©s"); }

  // --- L√âGSZENNYEZ√âS OKA (magyar√°z√≥ sz√∂veg, ha rossz az √©rt√©k) ---
  let airCause = "";
  if (air && air.components) {
    if (air.components.pm10 && air.components.pm10 >= 25) {
      airCause = "A magas sz√°ll√≥por (PM10) szint oka lehet: v√°rosi forgalom, ipar, lakoss√°gi f≈±t√©s vagy pollen.";
    } else if (air.components.no2 && air.components.no2 >= 0.1) {
      airCause = "A magas nitrog√©n-dioxid (NO‚ÇÇ) szint f≈ëleg d√≠zelaut√≥k, ipari tev√©kenys√©g vagy t√ºzel√©s miatt emelkedett.";
    } else if (air.components.o3 && air.components.o3 >= 90) {
      airCause = "Az √≥zon (O‚ÇÉ) szint emelked√©s√©t er≈ës naps√ºt√©s √©s szennyez≈ëanyagok k√∂lcs√∂nhat√°sa okozhatja (v√°rosi szmog).";
    } else if (air.components.co && air.components.co >= 4000) {
      airCause = "A sz√©n-monoxid (CO) szint emelked√©se √°ltal√°ban f≈±t√©s, rossz szell≈ëz√©s≈± helyis√©gek vagy forgalom miatt fordul el≈ë.";
    }
  }

  // --- R√ñVID √âRT√âKEL√âS √âS JAVASLAT ---
  let msg = "";
  if (terheles === 0) {
    msg = `<span style="color:#21d687"><b>Biometeo-terhel√©s:</b> <b>alacsony</b> ‚Äì id≈ëj√°r√°s szempontj√°b√≥l a szervezetre n√©zve kedvez≈ë nap.</span>`;
  } else if (terheles === 1) {
    let riskDetails = risks.map(risk =>
      `<span style="cursor:help;" title="${biometeoDetailedInfo[risk] || ''}">‚ÑπÔ∏è</span> <b>${risk}</b>`
    ).join(", ");
    msg = `<span style="color:#dbb52d"><b>Biometeo-terhel√©s:</b> <b>k√∂zepes</b> ‚Äì f≈ë kock√°zat: ${riskDetails}.<br>
      A biometeo-terhel√©s t√ºnetei lehetnek: fejf√°j√°s, enyhe migr√©n, ingerl√©kenys√©g, f√°radts√°g.</span>`;
    if (airCause) {
      msg += `<br><span style="color:#dbb52d"><b>Mi√©rt?</b> ${airCause}</span>`;
      msg += `<br><span style="color:#dbb52d">A biometeo-terhel√©s v√°rhat√≥an a leveg≈ëmin≈ës√©g javul√°s√°ig fenn√°ll.</span>`;
    }
  } else {
    let riskDetails = risks.map(risk =>
      `<span style="cursor:help;" title="${biometeoDetailedInfo[risk] || ''}">‚ÑπÔ∏è</span> <b>${risk}</b>`
    ).join(", ");
    msg = `<span style="color:#e6664c;font-weight:bold"><b>Biometeo-terhel√©s:</b> <b>magas</b> ‚Äì vesz√©lyes kombin√°ci√≥ (${riskDetails}).<br>
      <b>Gyakori t√ºnetek:</b> er≈ës fejf√°j√°s, migr√©n, alv√°szavar, sz√≠vpanaszok, izom- √©s √≠z√ºleti f√°jdalom, f√°rad√©konys√°g, koncentr√°ci√≥zavar.</span>`;
    if (airCause) {
      msg += `<br><span style="color:#e6664c"><b>Mi√©rt?</b> ${airCause}</span>`;
    }
  }
  return msg;
}


// --- BIOMETEOROL√ìGIAI TERHEL√âS EL≈êREJELZ√âS (8 √≥r√°ra el≈ëre) ---
function getBioMeteoForecast(weather, atm, air) {
  // 8 √≥r√°s el≈ërejelz√©s ‚Äì minden √≥r√°ra v√©gigmegy√ºnk
  let changes = [];
  if (!weather.hourly || !weather.hourly.time) return "";

  let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
  if (nowIdx < 0) nowIdx = 0;

  let lastTerheles = null, tartam = 0, lastStart = nowIdx;
  for (let i = nowIdx; i < Math.min(weather.hourly.time.length, nowIdx+8); i++) {
    // "Virtu√°lis" atm √©s air √©rt√©k, mert csak az aktu√°lis van elt√°rolva, de lehet extrapol√°lni
    let humidity = weather.hourly.relative_humidity_2m?.[i] ?? atm?.humidity ?? 0;
    let wind = weather.hourly.windspeed_10m?.[i] ?? atm?.wind ?? 0;
    let uv = weather.hourly.uv_index?.[i] ?? 0;

    let pol = air && air.components; // Jelenleg csak aktu√°lis l√©gszennyez√©sed van, ez nem lesz √≥r√°nk√©nti, ezt csak mosti √©rt√©kkel lehet mutatni!
    let biom = calcBiometeoLevel(weather, atm, air, i);
let terheles = biom.level;
let reasons = biom.reasons;

    // l√©gnyom√°s csak a front miatt van ‚Äì azt az el≈ëz≈ë panel m√°r ki√≠rja!

    // Mentj√ºk a biometeo "√°llapotv√°lt√°sokat"
    if (lastTerheles === null) lastTerheles = terheles;
    if (terheles !== lastTerheles || i === Math.min(weather.hourly.time.length, nowIdx+8)-1) {
      // V√©ge egy peri√≥dusnak, jegyezd fel
      let start = new Date(weather.hourly.time[lastStart]);
      let end = new Date(weather.hourly.time[i]);
      let diffH = Math.floor((end - start)/3600000);
      let diffM = Math.round(((end - start)%3600000)/60000);
      let level = ["alacsony","k√∂zepes","magas"][Math.min(lastTerheles,2)];
      changes.push({
        start: start,
        end: end,
        level: level,
        tartam: (diffH>0?diffH+" √≥ra ":"") + (diffM>0?diffM+" perc":"")
      });
      lastStart = i;
      lastTerheles = terheles;
    }
  }

  // Ki√≠r√°s, csak ha nem v√©gig egyforma!
  if (changes.length > 1) {
    let txt = `<span style="font-size:.98em;color:#47d4c5"><b>Biometeo-terhel√©s v√°rhat√≥ alakul√°sa:</b></span><br>`;
    changes.forEach(ch => {
      txt += `<span style="font-weight:600;color:${ch.level==="magas"?"#e6664c":ch.level==="k√∂zepes"?"#dbb52d":"#21d687"}">
        ${ch.level.charAt(0).toUpperCase()+ch.level.slice(1)} biometeo-terhel√©s
      </span> <span style="color:#888">(${ch.tartam}, ${ch.start.getHours()}:00-t√≥l)</span><br>`;
    });
    return txt;
  }
  return "";
}


// --- √ötinform.hu RSS ---
async function getUtinform(cityName = "") {
  try {
    const proxy = "https://api.allorigins.win/get?url=";
    const url = "https://www.utinform.hu/rss/utinformhirek.rss";
    const res = await fetch(proxy + encodeURIComponent(url));
    const data = await res.json();
    const parser = new window.DOMParser();
    const xml = parser.parseFromString(data.contents, "text/xml");
    const items = xml.querySelectorAll("item");
    let msgList = [];
    items.forEach(item => {
      const title = item.querySelector("title")?.textContent || "";
      const desc = item.querySelector("description")?.textContent || "";
      msgList.push({title, desc});
    });

    // K√∂zvetlen k√∂rnyezet (v√°ros)
    let cityHits = cityName
      ? msgList.filter(x => x.title.includes(cityName) || x.desc.includes(cityName))
      : [];
    // 60km k√∂rzet = megyen√©v
    let megyek = ["Fej√©r","Pest","Kom√°rom","Veszpr√©m","Tolna","Somogy","Budapest"];
    let countyHits = [];
    for (let county of megyek) {
      countyHits.push(...msgList.filter(x => x.title.includes(county) || x.desc.includes(county)));
    }
    return {city: cityHits, county: countyHits, all: msgList.slice(0, 2)};
  } catch (e) {
    return {city: [], county: [], all: []};
  }
}



const OPENWEATHER_API_KEY = "6a8514078d38de2a2c4e4e1642fede5c";
const poiTypes = [
  {icon:"üöå", key:"bus", val:"yes", label:"Buszmeg√°ll√≥"},
  {icon:"üöã", key:"tram", val:"yes", label:"Villamosmeg√°ll√≥"},
  {icon:"üöá", key:"subway", val:"yes", label:"Metr√≥√°llom√°s"},
  {icon:"üöâ", key:"train", val:"yes", label:"Vas√∫t√°llom√°s"},
  {icon:"üöè", key:"public_transport", val:"platform", label:"K√∂z√∂ss√©gi meg√°ll√≥"},
  {icon:"üõí", key:"shop", val:"supermarket", label:"√âlelmiszer"},
  {icon:"üè™", key:"shop", val:"electronics", label:"M≈±szaki"},
  {icon:"‚òï", key:"amenity", val:"cafe", label:"K√°v√©z√≥"},
  {icon:"‚öΩ", key:"leisure", val:"pitch", label:"Sport"},
  {icon:"‚õΩ", key:"amenity", val:"fuel", label:"√územanyag"},
  {icon:"üÖøÔ∏è", key:"amenity", val:"parking", label:"Parkol√≥"},
  {icon:"üîã", key:"amenity", val:"charging_station", label:"T√∂lt≈ë"},
];

const demoPollen = [
  { city: "Budapest", ragweed: "magas", grass: "k√∂zepes", birch: "alacsony" },
  { city: "Sz√©kesfeh√©rv√°r", ragweed: "k√∂zepes", grass: "alacsony", birch: "nincs" },
  { city: "Debrecen", ragweed: "alacsony", grass: "alacsony", birch: "alacsony" },
  { city: "Miskolc", ragweed: "k√∂zepes", grass: "k√∂zepes", birch: "alacsony" }
];
function getDemoPollen(cityName) {
  const found = demoPollen.find(x => cityName && cityName.includes(x.city));
  return found || demoPollen[0];
}
function completeChallenge() {
  let count = Number(localStorage.getItem("eco_challenge") || 0) + 1;
  localStorage.setItem("eco_challenge", count);
  document.getElementById('challenge-status').textContent = count + " teljes√≠t√©s";
}
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('challenge-status').textContent =
    (localStorage.getItem("eco_challenge") || 0) + " teljes√≠t√©s";
});
function getPosition() {
// Sz√©kesfeh√©rv√°r: 47.1860, 18.4221
  return Promise.resolve({ latitude: 47.1860, longitude: 18.4221 });
}
  //  return new Promise((resolve, reject) => {
  //  if (!navigator.geolocation) reject("Nincs geolok√°ci√≥!");
  //  navigator.geolocation.getCurrentPosition(
  //   pos => resolve(pos.coords),
  //  err => reject(err)
  // );
 // });
// }
async function getWeather(lat, lon) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=uv_index,visibility,relative_humidity_2m,windspeed_10m,precipitation_probability,precipitation,snowfall,weathercode,temperature_2m,pressure_msl,cloudcover&forecast_days=8&timezone=Europe/Budapest`;


  const res = await fetch(url);
  if (!res.ok) throw "Nem siker√ºlt lek√©rni az id≈ëj√°r√°st!";
  return await res.json();
}
async function getAirQuality(lat, lon) {
  const url = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}`;
  const res = await fetch(url);
  if (!res.ok) return null;
  const data = await res.json();
  if (!data.list || !data.list.length) return null;
  return data.list[0];
}
async function getCityName(lat, lon) {
  const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=hu`;
  const res = await fetch(url);
  if (!res.ok) return "";
  const data = await res.json();
  let name = data.address.village || data.address.town || data.address.city || data.address.hamlet || data.display_name || "";
  name = name.split(",")[0].trim(); // csak a f≈ë v√°rosn√©v, pl. "Sz√©kesfeh√©rv√°r"
  return name;
}

async function getWeatherWarning(cityName) {
  try {
    const url = "https://api.met.hu/idojaras/veszelyjelzes/megye.json";
    const res = await fetch(url);
    const data = await res.json();
    const countyNames = ["B√°cs-Kiskun","Baranya","B√©k√©s","Borsod-Aba√∫j-Zempl√©n","Csongr√°d-Csan√°d","Fej√©r","Gy≈ër-Moson-Sopron","Hajd√∫-Bihar","Heves","J√°sz-Nagykun-Szolnok","Kom√°rom-Esztergom","N√≥gr√°d","Pest","Somogy","Szabolcs-Szatm√°r-Bereg","Tolna","Vas","Veszpr√©m","Zala","Budapest"];
    let county = "";
    for (const name of countyNames) {
      if (cityName && cityName.includes(name)) { county = name; break; }
    }
    if (!county || !data.megye) return { warnings: [], county: "" };
    const c = data.megye.find(x => x.nev === county);
    if (!c || !c.fok || !c.fok.length) return { warnings: [], county };
    let warnings = c.fok.filter(x => x.szint > 0);
    return { warnings, county };
  } catch (e) { return { warnings: [], county: "" }; }
}
const szintTeendo = {
  1: "Figyelmeztet√©s: k√∂vesd az OMSZ tan√°csait.",
  2: "Narancs ‚Äì Fokozott vesz√©ly: ne tart√≥zkodj szabadban!",
  3: "Piros ‚Äì Extr√©m vesz√©ly: csak √©letv√©delmi okb√≥l menj ki, v√©dj mindent, amit tudsz!",
};
function warningIconAndText(jelzes) {
  if (!jelzes) return {icon:"",text:""};
  let txt = jelzes.toLowerCase();
  if (txt.includes("zivatar")) return {icon:"üå©Ô∏è", text:"Zivatar"};
  if (txt.includes("h≈ës√©g")) return {icon:"‚òÄÔ∏è", text:"H≈ës√©g"};
  if (txt.includes("sz√©l")) return {icon:"üí®", text:"Sz√©l"};
  if (txt.includes("j√©ges≈ë")) return {icon:"üßä", text:"J√©ges≈ë"};
  if (txt.includes("h√≥")) return {icon:"üå®Ô∏è", text:"H√≥"};
  if (txt.includes("k√∂d")) return {icon:"üå´Ô∏è", text:"K√∂d"};
  if (txt.includes("es≈ë")) return {icon:"üåßÔ∏è", text:"Es≈ë"};
  return {icon:"‚ö†Ô∏è", text:jelzes};
}
function warningLevelClass(szint) {
  if (szint == 3) return "eco-card warn-red";
  if (szint == 2) return "eco-card warn-orange";
  if (szint == 1) return "eco-card warn-yellow";
  return "eco-card warn-none";
}
function formatOszTime(t) {
  if (!t) return "";
  let d = t.split("T");
  if (!d[0] || !d[1]) return "";
  let dm = d[0].slice(5).replace("-",".") + ". " + d[1].slice(0,5);
  return dm;
}
async function fetchPOI(lat, lon) {
  const rad = 900;
  let parts = poiTypes.map(t => `node["${t.key}"="${t.val}"](around:${rad},${lat},${lon});`).join("");
  const query = `[out:json];(${parts});out body;`;
  try {
    const res = await fetch("https://overpass-api.de/api/interpreter", {method:"POST",body:query});
    const data = await res.json();
    return data.elements || [];
  } catch(e) {
    return [
      {lat:lat+0.0013,lon:lon-0.0017,tags:{shop:"supermarket"},id:1},
      {lat:lat-0.0009,lon:lon+0.0022,tags:{amenity:"cafe"},id:2},
      {lat:lat+0.0007,lon:lon+0.001,tags:{amenity:"charging_station"},id:3},
      {lat:lat-0.0005,lon:lon-0.0006,tags:{public_transport:"platform"},id:4}
    ];
  }
}

// === Kieg√©sz√≠t≈ë infopanelek ===
function updateSunTimesPanel(lat, lon) {
  // Napkelte/nyugta ugyan√∫gy
  const sunUrl = `https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&date=today&formatted=0`;

  fetch(sunUrl).then(res => res.json()).then(sunData => {
    const sunrise = new Date(sunData.results.sunrise).toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });
    const sunset = new Date(sunData.results.sunset).toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });

    // --- HOLD F√ÅZIS (helyi JS sz√°m√≠t√°ssal, API n√©lk√ºl) ---
    // Algoritmus forr√°s: https://www.subsystems.us/uploads/9/8/9/4/98948044/moonphase.pdf
    function getMoonPhase(date) {
      var year = date.getFullYear();
      var month = date.getMonth() + 1; // 1-12
      var day = date.getDate();

      if (month < 3) { year--; month += 12; }
      ++month;

      var c = 365.25 * year;
      var e = 30.6 * month;
      var jd = c + e + day - 694039.09; // jd is total days elapsed
      jd /= 29.5305882; // divide by the moon cycle
      var b = parseInt(jd); // int(jd) -> b, take integer part of jd
      jd -= b; // subtract integer part to leave fractional part of original jd
      var phase = Math.round(jd * 8); // scale fraction from 0-8 and round

      if (phase >= 8 ) phase = 0;
      return phase;
    }

    // F√°zis nevek √©s ikonok
    const phases = [
      { name: "√öjhold", icon: "üåë" },
      { name: "N√∂v≈ë holdsarl√≥", icon: "üåí" },
      { name: "Els≈ë negyed", icon: "üåì" },
      { name: "N√∂v≈ë hold", icon: "üåî" },
      { name: "Telihold", icon: "üåï" },
      { name: "Fogy√≥ hold", icon: "üåñ" },
      { name: "Utols√≥ negyed", icon: "üåó" },
      { name: "Fogy√≥ holdsarl√≥", icon: "üåò" }
    ];
    let phaseIdx = getMoonPhase(new Date());
    let moon = phases[phaseIdx];

    document.getElementById('sun-times-panel').innerHTML =
      `üåÖ Napkelte: <b>${sunrise}</b> &nbsp;|&nbsp; üèôÔ∏è Napnyugta: <b>${sunset}</b> &nbsp;|&nbsp; ${moon.icon} Holdf√°zis: <b>${moon.name}</b>`;
  });
}



function updatePressurePanel(weather) {
  let p = "";
  if (weather.hourly && weather.hourly.time && weather.hourly.pressure_msl) {
    var idxNow = weather.hourly.time.findIndex(x => x.startsWith(weather.current_weather.time.slice(0,13)));
    p = weather.hourly.pressure_msl[idxNow] || weather.current_weather.pressure_msl;
  } else if (weather.current_weather && typeof weather.current_weather.pressure_msl === "number") {
    p = weather.current_weather.pressure_msl;
  }
  let txt = "";
  if (p) {
    txt = `‚è≥ L√©gnyom√°s: <b>${Math.round(p)} hPa</b>`;
    if (p < 1003) txt += " ‚Äì üåÄ Hidegfront (front√©rz√©kenyek figyelem!)";
    else if (p > 1020) txt += " ‚Äì üåû Melegfront (√°lmoss√°g, f√°radts√°g jelentkezhet)";
    else txt += " ‚Äì √Åtlagos l√©gnyom√°s";
  }

  // -- Pontos id≈ë kalkul√°ci√≥ (csak ha lesz jelent≈ës v√°ltoz√°s)
  let vanValtozas = false;
  let targetIdx = -1;
  if (weather.hourly && weather.hourly.time && weather.hourly.pressure_msl) {
    var idxNow = weather.hourly.time.findIndex(x => x.startsWith(weather.current_weather.time.slice(0,13)));
    let aktFront = (p < 1003 || p > 1020);
    for (let i = idxNow+1; i < weather.hourly.pressure_msl.length; i++) {
      let pres = weather.hourly.pressure_msl[i];
      // Ha frontb√≥l √°tl√©p √°tlagosba, vagy √°tlagosb√≥l frontba
      if (aktFront && pres >= 1003 && pres <= 1020) { vanValtozas = true; targetIdx = i; break; }
      if (!aktFront && (pres < 1003 || pres > 1020)) { vanValtozas = true; targetIdx = i; break; }
    }
  }
  if (vanValtozas && targetIdx > 0) {
    let nowTime = new Date(weather.hourly.time[idxNow]);
    let targetTime = new Date(weather.hourly.time[targetIdx]);
    let diffMs = targetTime - nowTime;
    let diffH = Math.floor(diffMs / 3600000);
    let diffM = Math.round((diffMs % 3600000) / 60000);
    txt += `<br><span style='font-size:.97em'>${diffH} √≥ra${diffM>0?` ${diffM} perc`:''} m√∫lva: <b>${Math.round(weather.hourly.pressure_msl[targetIdx])} hPa</b> `;
    if (weather.hourly.pressure_msl[targetIdx] < 1003) txt += "‚Äì üåÄ Hidegfront v√°rhat√≥";
    else if (weather.hourly.pressure_msl[targetIdx] > 1020) txt += "‚Äì üåû Melegfront v√°rhat√≥";
    else txt += "‚Äì √Åtlagos l√©gnyom√°s <span style='color:#888;'>(AI kalkul√°lt)</span>";
    txt += "</span>";
  }
  // Ha nincs v√°ltoz√°s, nem √≠runk ki semmit!

  document.getElementById('pressure-panel').innerHTML = txt;
}


function updatePollenHourPanel(weather) {
  // "Pollen-√≥ra": fikt√≠v logika, amikor 24 fok felett, sz√°raz id≈ëben √©s napos UV>4, pollen rosszabb 12‚Äì16h
  let txt = "";
  let now = new Date(weather.current_weather.time);
  let hour = now.getHours();
  let uv = null, temp = weather.current_weather.temperature;
  if (weather.hourly && weather.hourly.uv_index && weather.hourly.time) {
    let idx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
    if(idx>=0) uv = weather.hourly.uv_index[idx];
  }
  if (temp > 22 && uv !== null && uv > 4 && hour >= 12 && hour <= 16) {
    txt = "üå∏ <b>Pollen-cs√∫csid≈ëszak:</b> Most k√ºl√∂n√∂sen magas! (12‚Äì16 √≥ra, UV er≈ës, sz√°raz meleg id≈ë)";
  } else if (uv !== null && uv > 4) {
    txt = "üå∏ <b>K√∂zepes pollenhelyzet:</b> Ker√ºld a hosszabb szabadt√©ri tart√≥zkod√°st, f≈ëleg d√©lt≈ël 16h-ig!";
  } else {
    txt = "üå∏ <b>Jelenleg nincs kiugr√≥ pollen-cs√∫csid≈ëszak.</b>";
  }
  document.getElementById('pollen-hour-panel').innerHTML = txt;
}
function updateJamPanel(trafficObj) {
  let html = "";
  if (trafficObj.local) html += "üöó <b>Helyi forgalmi helyzet:</b> " + trafficObj.local;
  if (trafficObj.regional) html += "<br>üõ£Ô∏è <b>60km k√∂rzet esem√©nyei:</b> " + trafficObj.regional;
  document.getElementById('jam-info-panel').innerHTML = html;
}



// === POI √©s MAP ===
let map, marker, circle, poiMarkers = [];
function initMap(lat, lon) {
  if (!map) {
    map = L.map('leafletmap').setView([lat, lon], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    marker = L.marker([lat, lon], {icon: L.icon({
      iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    })}).addTo(map).bindPopup("Itt vagy!").openPopup();
    circle = L.circle([lat, lon], {radius: 100, color: "#50ce90", fillOpacity:.12}).addTo(map);
  } else {
    marker.setLatLng([lat, lon]);
    circle.setLatLng([lat, lon]);
    map.setView([lat, lon], map.getZoom());
  }
  updatePOI(lat, lon);
}

function normalizeName(str) {
  return (str||"")
    .trim()
    .toLowerCase()
    .replace(/[√°√§√†√¢]/g,'a').replace(/[√©√´√®√™]/g,'e')
    .replace(/[√≠√Ø√¨√Æ]/g,'i').replace(/[√≥√∂≈ë√≤√¥]/g,'o')
    .replace(/[√∫√º≈±√π√ª]/g,'u')
    .replace(/[√ß]/g,'c').replace(/[√ü]/g,'ss')
    .replace(/[^a-z0-9]/g,''); // minden nem-bet≈±/sz√°m elt√°vol√≠t
}


async function updatePOI(lat, lon) {
  poiMarkers.forEach(p => map.removeLayer(p));
  poiMarkers = [];
  const pois = await fetchPOI(lat, lon);
  pois.forEach(node => {
    let icon = "‚ùì", typeLabel = "-";
    for (let t of poiTypes) if (node.tags[t.key] === t.val) { icon = t.icon; typeLabel = t.label; break; }

    // --- Budapesti buszmeg√°ll√≥k: statikus menetrendi popup ---
    if (typeLabel === "Buszmeg√°ll√≥" && node.tags.name) {
  let m = L.marker([node.lat, node.lon], {
    icon: L.divIcon({className:"", html:`<span style="font-size:1.5em">üöè</span>`})
  }).addTo(map)
    .on('click', function() {
      m.bindPopup(
        `<b>${node.tags.name}</b><br><span style="font-size:1em;">${typeLabel}</span>`
      ).openPopup();
    });
  poiMarkers.push(m);
}



    // --- Egy√©b POI ---
    else {
      let m = L.marker([node.lat, node.lon], {
        icon: L.divIcon({className:"",html:`<span style="font-size:1.5em">${icon}</span>`})
      }).addTo(map)
        .bindPopup(
          `${icon} <b>${node.tags.name||typeLabel}</b><br><span style="font-size:1em;">${typeLabel}</span>`
        );
      poiMarkers.push(m);
    }
  });
}

function liveFollowPosition() {
 // if (navigator.geolocation) {
  //  navigator.geolocation.watchPosition(pos => {
   //   const lat = pos.coords.latitude, lon = pos.coords.longitude;
    //  initMap(lat, lon);
   // });
  //}
}
document.getElementById("btnstreet").onclick = function() {
  if (marker && marker.getLatLng) {
    let lat = marker.getLatLng().lat, lon = marker.getLatLng().lng;
    window.open(`https://maps.google.com/?cbll=${lat},${lon}&layer=c`, "_blank");
  }
};
document.getElementById("btn2d").onclick = function() {
  if (marker && marker.getLatLng) {
    let lat = marker.getLatLng().lat, lon = marker.getLatLng().lng;
    initMap(lat, lon);
  }
};
// --- S√∂t√©t m√≥d ---
function setDarkMode(on) {
  document.body.classList.toggle('dark', on);
  localStorage.setItem("eco_darkmode", on ? "1":"0");
}
function autoDarkMode() {
  const now = new Date(), sunset = 20;
  setDarkMode(now.getHours() >= sunset || localStorage.getItem("eco_darkmode")==="1");
}
document.getElementById('darkmodeBtn').onclick = ()=>setDarkMode(!document.body.classList.contains('dark'));
setTimeout(autoDarkMode,300);
// --- MODAL/okos figyelmeztet√©s: pollen, UV, h≈ës√©g!
function showAlertModal(title, msg) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMsg').innerHTML = msg;
  document.getElementById('alertModal').style.display = "flex";
}

function isWetCode(code){
  code = Number(code);
  return [51,53,55,56,57,61,63,65,66,67,71,73,75,77,80,81,82,85,86,95,96,99].includes(code);
}
function isSnowCode(code){ return [71,73,75,77,85,86].includes(Number(code)); }
function isThunderCode(code){ return [95,96,99].includes(Number(code)); }
function sameYMD(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

function summarizeDayParts(weather, baseDate=new Date()){
  const h = weather?.hourly;
  if(!h?.time || !h?.weathercode) return [];

  const slots = [
    { label:"√©jjel",    start:0,  end:6  },
    { label:"d√©lel≈ëtt", start:6,  end:12 },
    { label:"d√©lut√°n",  start:12, end:18 },
    { label:"este",     start:18, end:24 }
  ];

  return slots.map(slot => {
    let idxs = [];
    for (let i=0;i<h.time.length;i++){
      const d = new Date(h.time[i]);
      if (sameYMD(d, baseDate) && d.getHours() >= slot.start && d.getHours() < slot.end) idxs.push(i);
    }
    if (!idxs.length) return {label:slot.label, status:"nincs adat", icon:"‚ãØ", mm:0};

    let wet=false, snow=false, thunder=false, mmSum=0;
    for (const k of idxs){
      const wc = Number(h.weathercode[k]);
      wet = wet || isWetCode(wc);
      snow = snow || isSnowCode(wc);
      thunder = thunder || isThunderCode(wc);
      mmSum += Number(h.precipitation?.[k] ?? 0);
    }
    let status, icon;
    const anyRain = wet || mmSum > 0.1;
    if (thunder) { status = "zivatar"; icon = "‚õàÔ∏è"; }
    else if (snow) { status = "havaz√°s"; icon = "üå®Ô∏è"; }
    else if (anyRain) { status = "es≈ë"; icon = "üåßÔ∏è"; }
    else { status = "borult"; icon = "‚òÅÔ∏è"; }
    return { label:slot.label, status, icon, mm:Math.round(mmSum*10)/10 };
  });
}


// --- 7 napos id≈ëj√°r√°s panel ---
function renderForecast(weather) {
  const w = weather;
  let res = '';
  for (let d = 0; d < 4; d++) {
    if (!w.hourly.time[d * 24]) break;
    // Nap neve
    let date = w.hourly.time[d * 24] ? new Date(w.hourly.time[d * 24]) : null;
    let day = date ? date.toLocaleDateString('hu-HU', { weekday: 'short' }) : "-";
    // Min/max h≈ëm√©rs√©klet (teljes napra)
    let minTemp = 99, maxTemp = -99;
    for (let h = d * 24; h < (d + 1) * 24; h++) {
      if (w.hourly.temperature_2m && w.hourly.temperature_2m[h] !== undefined) {
        if (w.hourly.temperature_2m[h] < minTemp) minTemp = w.hourly.temperature_2m[h];
        if (w.hourly.temperature_2m[h] > maxTemp) maxTemp = w.hourly.temperature_2m[h];
      }
    }
    let minT = minTemp !== 99 ? Math.round(minTemp) + "¬∞C" : "-";
    let maxT = maxTemp !== -99 ? Math.round(maxTemp) + "¬∞C" : "-";
    // Napszakos √∂sszegz√©s: summarizeDayParts
    const parts = summarizeDayParts(w, date);
    res += `<div class="forecast-day" style="min-width:85px;">
      <div class="day">${day}</div>
      <div class="icon" style="display:flex;flex-direction:column;align-items:center;font-size:1.09em;">
        <span>üåÉ ${parts[0].icon} <span style="font-size:.93em;color:#5fd0e7">${parts[0].status}</span></span>
        <span>üåÖ ${parts[1].icon} <span style="font-size:.93em;color:#5fd0e7">${parts[1].status}</span></span>
        <span>üåû ${parts[2].icon} <span style="font-size:.93em;color:#5fd0e7">${parts[2].status}</span></span>
        <span>üåÜ ${parts[3].icon} <span style="font-size:.93em;color:#5fd0e7">${parts[3].status}</span></span>
      </div>
      <div class="temp"><span style="color:#19e58f">${minT}</span> / <b>${maxT}</b></div>
    </div>`;
  }
  document.getElementById('forecast-panel').innerHTML = res;
}


function getWeatherText(code, cloud) {
  if ([95,96,99].includes(code))      return "zivatar";
  if ([67,77].includes(code))         return "j√©ges≈ë";
  if ([71,73,75,85,86].includes(code))return "havaz√°s";
  if ([61,63,65,80,81,82].includes(code)) return "es≈ë";
  if (cloud <= 15) return "der√ºlt";
  if (cloud <= 50) return "gyeng√©n felh≈ës";
  if (cloud <= 85) return "er≈ësen felh≈ës";
  return "borult";
}

// --- AI √∂sszegz√©s, ‚ÄúIndulj vagy v√°rj!‚Äù, √∂lt√∂z√©k, csapad√©k, minden --- 
function generateAISuggestion(weather, air, atm, trafficMsg) {
  let msg = "";

  // --- Id≈ëj√°r√°s (k√∂zelj√∂v≈ë, 0-60 perc) ---
  // --- Id≈ëj√°r√°s (k√∂zelj√∂v≈ë, 0-60 perc) ---
if (
  weather && weather.hourly &&
  Array.isArray(weather.hourly.weathercode) &&
  Array.isArray(weather.hourly.time) &&
  weather.current_weather && typeof weather.current_weather.time === "string"
) {
  let nowIdx = weather.hourly.time.findIndex(x => x.startsWith(weather.current_weather.time.slice(0, 13)));
  if (nowIdx < 0) nowIdx = 0;
  let found = false;
  for (let i = nowIdx + 1; i < weather.hourly.time.length && i <= nowIdx + 2; i++) {
    if (typeof weather.hourly.weathercode[i] === "undefined") continue;
    let code = weather.hourly.weathercode[i], type = "";

    // --- ES≈ê ---
    if ([61,63,65,80,81,82].includes(code)) {
      let rainCount = 1;
      for (let j = i + 1; j <= i + 2 && j < weather.hourly.weathercode.length; j++) {
        if ([61,63,65,80,81,82].includes(weather.hourly.weathercode[j])) rainCount++;
      }
      let highProb = false;
      if (
        weather.hourly.precipitation_probability &&
        typeof weather.hourly.precipitation_probability[i] === "number" &&
        weather.hourly.precipitation_probability[i] >= 40
      ) {
        highProb = true;
      }
      if (rainCount >= 2 || highProb) type = "es≈ë";
      else type = "";
    }

    // --- ZIVATAR ---
    else if ([95,96,99].includes(code)) {
      let stormCount = 1;
      for (let j = i + 1; j <= i + 2 && j < weather.hourly.weathercode.length; j++) {
        if ([95,96,99].includes(weather.hourly.weathercode[j])) stormCount++;
      }
      let highProb = false;
      if (
        weather.hourly.precipitation_probability &&
        typeof weather.hourly.precipitation_probability[i] === "number" &&
        weather.hourly.precipitation_probability[i] >= 40
      ) {
        highProb = true;
      }
      if (stormCount >= 2 || highProb) type = "zivatar";
      else type = "";
    }

    // --- J√âGES≈ê ---
    else if ([67,77].includes(code)) {
      let hailCount = 1;
      for (let j = i + 1; j <= i + 2 && j < weather.hourly.weathercode.length; j++) {
        if ([67,77].includes(weather.hourly.weathercode[j])) hailCount++;
      }
      if (hailCount >= 2) type = "j√©ges≈ë";
      else type = "";
    }

    // --- HAVAZ√ÅS ---
    else if ([71,73,75,85,86].includes(code)) {
      let snowCount = 1;
      for (let j = i + 1; j <= i + 2 && j < weather.hourly.weathercode.length; j++) {
        if ([71,73,75,85,86].includes(weather.hourly.weathercode[j])) snowCount++;
      }
      if (snowCount >= 2) type = "havaz√°s";
      else type = "";
    }

    // --- SZIT√ÅL√ÅS ---
    else if ([51,53,55,56,57].includes(code)) {
      let drizzleCount = 1;
      for (let j = i + 1; j <= i + 2 && j < weather.hourly.weathercode.length; j++) {
        if ([51,53,55,56,57].includes(weather.hourly.weathercode[j])) drizzleCount++;
      }
      if (drizzleCount >= 2) type = "szit√°l√°s";
      else type = "";
    }

    // --- K√ñD finom√≠tott felt√©tel ---
    else if ([3,45,48].includes(code)) {
      let fogCount = 1;
      for (let j = i + 1; j <= i + 2 && j < weather.hourly.weathercode.length; j++) {
        if ([3,45,48].includes(weather.hourly.weathercode[j])) fogCount++;
      }
      let lowVis = false;
      if (
        weather.hourly.visibility &&
        typeof weather.hourly.visibility[i] === "number" &&
        weather.hourly.visibility[i] < 3000 // <--- szigor√∫bb, csak 3 km alatt!
      ) {
        lowVis = true;
      }
      let hour = new Date(weather.hourly.time[i]).getHours();
      // Csak akkor √≠rjon, ha legal√°bb 3 √≥r√°s k√∂d, vagy nagyon rossz l√°t√≥t√°v, √©s csak hajnali/korareggeli id≈ëszakban!
      if ((fogCount >= 3 || lowVis) && (hour >= 5 && hour <= 9)) type = "k√∂d";
      else type = ""; // csak 1-2 √≥ra, vagy nem hajnalban, ne jelezzen!
    }

    // --- FELH≈êS/DER√úLT ---
    else if ([2].includes(code)) type = "felh≈ës";

    // --- RIASZT√ÅS KI√çR√ÅSA ---
    if (type) {
      let dt = new Date(weather.hourly.time[i]);
      let now = new Date(weather.current_weather.time);
      let min = Math.round((dt - now) / 1000 / 60);
      if (min > 0 && min <= 60) {
        msg += `‚ö° <b>${type.charAt(0).toUpperCase() + type.slice(1)} v√°rhat√≥ kb. ${min} perc m√∫lva!</b> `;
        found = true; break;
      }
    }
  }
  if (!found) msg += "";
}


  if (weather.current_weather && weather.current_weather.precipitation > 0) {
    msg += "Jelenleg is csapad√©k van, ";
  }
  
  if (atm && atm.wind >= 35) msg += `<b>Viharos sz√©l (${atm.wind} km/h)!</b> `;
  else if (atm && atm.wind >= 18) msg += `er≈ës sz√©l (${atm.wind} km/h), `;
  if (atm && atm.visibility < 7) msg += `l√°t√≥t√°vols√°g: ${atm.visibility} km, `;
  if (atm && atm.humidity > 80) msg += `magas p√°ratartalom (${atm.humidity}%). `;
  if (air && air.components && air.components.pm2_5 < 18) {
    msg += "J√≥ a leveg≈ëmin≈ës√©g ‚Äì ide√°lis a szabadban t√∂lteni!";
  } else if (air && air.components) {
    msg += `A leveg≈ëmin≈ës√©g k√∂zepes/szennyezett (PM2.5: ${air.components.pm2_5} ¬µg/m¬≥), ink√°bb ne fuss a szabadban.`;
  } else {
    msg += "Nincs el√©rhet≈ë adat a leveg≈ëmin≈ës√©gr≈ël.";
  }

  // --- H≈ë√©rzet √©s √∂lt√∂z√©k javaslat ---
  if (weather && weather.current_weather && typeof weather.current_weather.temperature === 'number') {
    const t = weather.current_weather.temperature;
    let dress = "";
    if (t >= 29) dress = "K√∂nny≈± ny√°ri ruha, sapka, sok folyad√©k!";
    else if (t >= 22) dress = "R√∂vid ujj√∫ p√≥l√≥, k√∂nny≈± nadr√°g aj√°nlott.";
    else if (t >= 17) dress = "Hossz√∫ ujj√∫ p√≥l√≥, v√©kony pul√≥ver.";
    else if (t >= 12) dress = "K√∂nny≈± dzseki, r√©teges √∂lt√∂zet.";
    else if (t >= 5) dress = "Melegebb kab√°t, pul√≥ver, s√°l.";
    else if (t >= -3) dress = "T√©li kab√°t, sapka, s√°l, keszty≈±!";
    else dress = "Extr√©m hideg! Vastag, r√©teges t√©li √∂lt√∂zet, sapka, s√°l, keszty≈± k√∂telez≈ë!";
    msg += `<br><b>√ñlt√∂z√©k tipp:</b> ${dress}`;
    if (atm && atm.wind > 18) msg += " (Er≈ës sz√©l miatt hidegebbnek √©rz≈ëdik!)";
    if (atm && atm.humidity > 85 && t > 18) msg += " (Magas p√°ratartalom miatt f√ºlledtebbnek √©rz≈ëdik.)";
  }

  // --- Csapad√©k inf√≥ ---
  const rainSum = calcTodayRainSum(weather);
  if (rainSum > 0) msg += `<br><b>Mai v√°rhat√≥ csapad√©k:</b> ${rainSum} mm`;

  // --- J√©ges≈ë vagy zivatar v√©ge (weathercode: 77, 96, 99) ---
let hailEndTime = null;
if (weather.hourly && weather.hourly.weathercode && weather.hourly.time) {
  let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
  for (let i = nowIdx+1; i < weather.hourly.time.length; i++) {
    if (![77,96,99].includes(weather.hourly.weathercode[i])) {
      hailEndTime = weather.hourly.time[i];
      break;
    }
  }
}
if ([77,96,99].includes(weather.current_weather.weathercode) && hailEndTime) {
  let formattedHailEnd = formatEventTime(hailEndTime, weather.current_weather.time);
  msg += `<br><b>V√°rhat√≥an a j√©ges≈ë/zivatar v√©ge: <span style="color:#3477af">${formattedHailEnd}</span></b>`;
}

// --- Havaz√°s v√©ge (weathercode: 71, 73, 75, 85, 86) ---
let snowEndTime = null;
if (weather.hourly && weather.hourly.weathercode && weather.hourly.time) {
  let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
  for (let i = nowIdx+1; i < weather.hourly.time.length; i++) {
    if (![71,73,75,85,86].includes(weather.hourly.weathercode[i])) {
      snowEndTime = weather.hourly.time[i];
      break;
    }
  }
}
if ([71,73,75,85,86].includes(weather.current_weather.weathercode) && snowEndTime) {
  let formattedSnowEnd = formatEventTime(snowEndTime, weather.current_weather.time);
  msg += `<br><b>V√°rhat√≥an a havaz√°s v√©ge: <span style="color:#3477af">${formattedSnowEnd}</span></b>`;
}

// --- Viharos sz√©l v√©ge ---
let stormEndTime = null;
if (weather.hourly && weather.hourly.windspeed_10m && weather.hourly.time) {
  let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
  for (let i = nowIdx+1; i < weather.hourly.time.length; i++) {
    if (weather.hourly.windspeed_10m[i] < 40) {
      stormEndTime = weather.hourly.time[i];
      break;
    }
  }
}
if (atm && atm.wind >= 40 && stormEndTime) {
  let formattedStormEnd = formatEventTime(stormEndTime, weather.current_weather.time);
  msg += `<br><b>V√°rhat√≥an a viharos sz√©l v√©ge: <span style="color:#d25d15">${formattedStormEnd}</span></b>`;
}


  // --- AI k√∂zleked√©si tan√°cs ---
  const aiTanacs = aiIndulasiTanacs(weather);
  if (aiTanacs) msg += `<br><b>K√∂zleked√©si tipp:</b> ${aiTanacs}`;

  // --- Forgalmi inf√≥, ha van ---
  if (trafficMsg) msg += `<br>üö¶ <b>${trafficMsg}</b>`;

  return msg;
}

// --- Csapad√©k √∂sszege √©s becs√ºlt v√©g√©ig tart√≥ id≈ë ---
function calcTodayRainSum(weather) {
  if (!weather.hourly || !weather.hourly.precipitation || !weather.hourly.time) return "-";
  let sum = 0;
  let todayStr = new Date().toISOString().slice(0,10); // "2025-09-05"
  for (let i = 0; i < weather.hourly.time.length; i++) {
    if (weather.hourly.time[i].startsWith(todayStr)) {
      sum += weather.hourly.precipitation[i] || 0;
    }
  }
  return sum.toFixed(1);
}
function estimateRainEnd(weather) {
  if (!weather.hourly || !weather.hourly.precipitation || !weather.hourly.time) return "";
  let now = new Date(weather.current_weather.time);
  let rainEndMin = null;
  for (let i = 0; i < weather.hourly.time.length; i++) {
    let t = new Date(weather.hourly.time[i]);
    if (t < now) continue;
    if (weather.hourly.precipitation[i] > 0) {
      rainEndMin = Math.round((t - now) / 60000);
    } else if (rainEndMin !== null) {
      return rainEndMin + 60;
    }
  }
  return rainEndMin ? (rainEndMin + 60) : null;
}
function aiIndulasiTanacs(weather, atm) {
  if (!weather || !weather.hourly || !weather.hourly.precipitation || !weather.hourly.time || !weather.current_weather) return "";
  let now = new Date(weather.current_weather.time);
  let rainNow = weather.current_weather.precipitation > 0;
  let snowNow = weather.current_weather.weathercode && [71,73,75,85,86].includes(weather.current_weather.weathercode);
  let stormNow = atm && atm.wind >= 40;
  
  // --- Es≈ë vagy havaz√°s vagy viharos sz√©l, UV mind tilt√≥ t√©nyez≈ë lehet ---
  if (rainNow) {
    // Mikor √°ll el?
    let firstRainFreeMinute = null;
    for (let i = 0; i < weather.hourly.time.length; i++) {
      let t = new Date(weather.hourly.time[i]);
      if (t < now) continue;
      if (weather.hourly.precipitation[i] === 0) {
        firstRainFreeMinute = Math.round((t - now) / 60000);
        break;
      }
    }
    if (firstRainFreeMinute !== null && firstRainFreeMinute < 60)
      return `Most nem javasolt elindulni, ${firstRainFreeMinute} perc m√∫lva v√°rhat√≥an el√°ll az es≈ë.`;
    return "Most esik az es≈ë, n√©zd meg az aktu√°lis radart!";
  }

  if (snowNow) {
    // Mikor olvad el, mikor m√∫lik el?
    let snowEnd = null;
    if (weather.hourly && weather.hourly.weathercode && weather.hourly.time) {
      let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
      for (let i = nowIdx+1; i < weather.hourly.time.length; i++) {
        if (![71,73,75,85,86].includes(weather.hourly.weathercode[i])) {
          snowEnd = weather.hourly.time[i];
          break;
        }
      }
    }
    if (snowEnd) {
      let dt = new Date(snowEnd);
      let perc = Math.round((dt-now)/60000);
      if (perc < 60) return `Most havazik, v√°rhat√≥an ${perc} perc m√∫lva el√°ll a havaz√°s.`;
      return "Most havazik, ink√°bb v√°rd meg, am√≠g el√°ll!";
    }
    return "Most havazik, indul√°s el≈ëtt ellen≈ërizd a h√≥helyzetet!";
  }

  if (stormNow) {
    // Mikor szel√≠d√ºl a sz√©l?
    let stormEnd = null;
    if (weather.hourly && weather.hourly.windspeed_10m && weather.hourly.time) {
      let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
      for (let i = nowIdx+1; i < weather.hourly.time.length; i++) {
        if (weather.hourly.windspeed_10m[i] < 40) {
          stormEnd = weather.hourly.time[i];
          break;
        }
      }
    }
    if (stormEnd) {
      let dt = new Date(stormEnd);
      let perc = Math.round((dt-now)/60000);
      if (perc < 60) return `Viharos sz√©l van, ${perc} perc m√∫lva v√°rhat√≥an m√©rs√©kl≈ëdik.`;
      return "Viharos sz√©l van, ha nem musz√°j, ne indulj el most!";
    }
    return "Viharos sz√©l van, fokozott √≥vatoss√°ggal indulj csak el!";
  }

  
// --- J√©ges≈ë (weathercode: 77) ---
let hailNow = weather.current_weather.weathercode === 77;
if (hailNow) {
  // Mikor √©r v√©get?
  let hailEnd = null;
  if (weather.hourly && weather.hourly.weathercode && weather.hourly.time) {
    let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
    for (let i = nowIdx+1; i < weather.hourly.time.length; i++) {
      if (weather.hourly.weathercode[i] !== 77) {
        hailEnd = weather.hourly.time[i];
        break;
      }
    }
  }
  if (hailEnd) {
    let dt = new Date(hailEnd);
    let perc = Math.round((dt-now)/60000);
    if (perc < 60) return `J√©ges≈ë van, ${perc} perc m√∫lva v√°rhat√≥an el√°ll.`;
    return "J√©ges≈ë van, ha nem musz√°j, most ink√°bb ne indulj el!";
  }
  return "J√©ges≈ë van, ker√ºld a szabadt√©ri mozg√°st √©s v√©dd a j√°rm≈±vedet!";
}

// --- K√∂d (weathercode: 3, 45, 48) ---
let fogNow = weather.current_weather.weathercode && [3,45,48].includes(weather.current_weather.weathercode);
if (fogNow) {
  // Mikor lesz v√©ge?
  let fogEnd = null;
  if (weather.hourly && weather.hourly.weathercode && weather.hourly.time) {
    let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
    for (let i = nowIdx+1; i < weather.hourly.time.length; i++) {
      if (![3,45,48].includes(weather.hourly.weathercode[i])) {
        fogEnd = weather.hourly.time[i];
        break;
      }
    }
  }
  if (fogEnd) {
    let dt = new Date(fogEnd);
    let perc = Math.round((dt-now)/60000);
    if (perc < 60) return `K√∂d van, ${perc} perc m√∫lva oszlani kezd. Vezess nagyon √≥vatosan!`;
    return "S≈±r≈± k√∂d van, vezess lassan √©s k√∂r√ºltekint≈ëen!";
  }
  return "S≈±r≈± k√∂d van, vezess lassan √©s k√∂r√ºltekint≈ëen!";
}

// --- Szit√°l√°s (weathercode: 51, 53, 55, 56, 57) ---
let drizzleNow = weather.current_weather.weathercode && [51,53,55,56,57].includes(weather.current_weather.weathercode);
if (drizzleNow) {
  // Mikor √©r v√©get?
  let drizzleEnd = null;
  if (weather.hourly && weather.hourly.weathercode && weather.hourly.time) {
    let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
    for (let i = nowIdx+1; i < weather.hourly.time.length; i++) {
      if (![51,53,55,56,57].includes(weather.hourly.weathercode[i])) {
        drizzleEnd = weather.hourly.time[i];
        break;
      }
    }
  }
  if (drizzleEnd) {
    let dt = new Date(drizzleEnd);
    let perc = Math.round((dt-now)/60000);
    if (perc < 60) return `Szit√°l√°s van, ${perc} perc m√∫lva el√°ll.`;
    return "Szit√°l√°s van, sz√°molj enyhe csapad√©kkal az √∫ton.";
  }
  return "Szit√°l√°s van, sz√°molj enyhe csapad√©kkal az √∫ton.";
}


  // --- Ha semmi extr√©m, akkor adj pozit√≠v tan√°csot ---
  // Lesz-e es≈ë, h√≥, viharos sz√©l a k√∂vetkez≈ë √≥r√°ban?
  let leszEse = false, leszHo = false, leszVihar = false;
  for (let i = 0; i < 4; i++) {
    if (weather.hourly.precipitation[i] > 0) leszEse = true;
    if (weather.hourly.weathercode && [71,73,75,85,86].includes(weather.hourly.weathercode[i])) leszHo = true;
    if (weather.hourly.windspeed_10m && weather.hourly.windspeed_10m[i] >= 40) leszVihar = true;
  }
  if (leszEse) return "Most ide√°lis elindulni, de es≈ë 1 √≥r√°n bel√ºl v√°rhat√≥!";
  if (leszHo) return "Most ide√°lis elindulni, de 1 √≥r√°n bel√ºl havaz√°s v√°rhat√≥!";
  if (leszVihar) return "Most ide√°lis elindulni, de 1 √≥r√°n bel√ºl viharos sz√©l v√°rhat√≥!";
  return "Most ide√°lis elindulni, a k√∂vetkez≈ë √≥r√°ban nem v√°rhat√≥ es≈ë, havaz√°s vagy vihar!";
}

// --- F≈ê LOGIKA, minden bet√∂lt√©se, infopanelek update ---
async function loadEcoData() {
  try {
    const coords = await getPosition();
  //  const coords = {latitude: 47.4979, longitude: 19.0402}; // Budapest
    const lat = coords.latitude, lon = coords.longitude;
    document.getElementById('city').textContent = "Bet√∂lt√©s‚Ä¶";
    const cityName = await getCityName(lat, lon);
    document.getElementById('city').textContent = cityName ? cityName : `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    document.getElementById('weather').textContent = "Bet√∂lt√©s‚Ä¶";
    document.getElementById('uv-panel').textContent = "Bet√∂lt√©s‚Ä¶";
    const weather = await getWeather(lat, lon);
    let rainNow = false;
let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
if (nowIdx < 0) nowIdx = 0;
for (let i = nowIdx; i <= nowIdx + 1 && i < weather.hourly.precipitation.length; i++) {
  if (weather.hourly.precipitation[i] > 0) rainNow = true;
}
document.getElementById('weather').textContent =
  `${Math.round(weather.current_weather.temperature)}¬∞C, ` +
  (weather.current_weather.precipitation > 0 ? "jelenleg is esik" : (rainNow ? "es≈ë v√°rhat√≥" : "nincs csapad√©k"));


    let uvNow = null;
    if(weather.hourly && weather.hourly.uv_index && weather.hourly.time){
      let idx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
      if(idx>=0) uvNow = weather.hourly.uv_index[idx];
    }
    document.getElementById('uv-panel').textContent = uvNow !== null ? uvNow.toFixed(1)+" (max 11)" : "Nincs adat";
    let atmNow = {visibility:0,humidity:0,wind:0};
    if(weather.hourly && weather.hourly.visibility && weather.hourly.time){
      let idx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
      if(idx>=0) {
        atmNow.visibility = Math.round((weather.hourly.visibility[idx]||0)/1000);
        atmNow.humidity = weather.hourly.relative_humidity_2m ? Math.round(weather.hourly.relative_humidity_2m[idx]||0) : 0;
        atmNow.wind = weather.hourly.windspeed_10m ? Math.round(weather.hourly.windspeed_10m[idx]||0) : 0;
      }
    }

// --- √âl≈ë h≈ë√©rzet panel (humidex/heat index/windchill) ---
let temp = weather.current_weather.temperature;
let humidity = atmNow.humidity;
let wind = atmNow.wind;

let heatIndex = temp;
let method = "";

if (temp >= 27 && humidity >= 40) {
  heatIndex = calcHeatIndex(temp, humidity);
  method = "heat index";
} else if (temp > 0 && humidity > 0) {
  heatIndex = calcHumidex(temp, humidity);
  method = "humidex";
}
if (temp <= 10 && wind >= 5) {
  heatIndex = calcWindChill(temp, wind);
  method = "windchill";
}

let heatTxt = `Jelenlegi h≈ë√©rzet: <b>${heatIndex}¬∞C</b> <span style="color:#7b9778;font-size:.98em">(${method || "h≈ëm√©rs√©klet"})</span>`;
document.getElementById('heat-index-panel').innerHTML = heatTxt;


    document.getElementById('atm-panel').innerHTML = `L√°t√≥t√°vols√°g: <b>${atmNow.visibility} km</b>, P√°ratartalom: <b>${atmNow.humidity}%</b>, Sz√©l: <b>${atmNow.wind} km/h</b>`;
    document.getElementById('air-quality').textContent = "Bet√∂lt√©s‚Ä¶";
    let airData = await getAirQuality(lat, lon);
    if (airData && airData.components) {
      let pm = airData.components.pm2_5;
      let status = "J√≥";
      if (pm >= 35) status = "Szennyezett";
      else if (pm >= 18) status = "K√∂zepes";
      document.getElementById('air-quality').textContent =
        `"${status}" (PM2.5: ${pm} ¬µg/m¬≥)`;
      document.getElementById('air-components').innerHTML =
  makeAirBadge('pm10', airData.components.pm10) +
  makeAirBadge('no2', airData.components.no2) +
  makeAirBadge('o3', airData.components.o3) +
  makeAirBadge('co', airData.components.co);

    } else {
      document.getElementById('air-quality').textContent =
        "Nincs el√©rhet≈ë adat a leveg≈ëmin≈ës√©gr≈ël!";
      document.getElementById('air-components').textContent = "";
    }
    
    // --- Riaszt√°s logika ---
    let ww = {warnings:[]};
    try {
      ww = await getWeatherWarning(cityName);
    } catch (err) {
      // ha az OMSZ API nem el√©rhet≈ë, "√ºres" riaszt√°st adunk vissza, a program NE √°lljon le
      ww = {warnings:[]};
    }
    const warnPanel = document.getElementById('weather-warning-card');
    const warnDiv = document.getElementById('weather-warning-details');
    if (!ww.warnings.length) {
      warnPanel.className = "eco-card warn-none";
      warnDiv.innerHTML = `<span class="warn-icon">‚úÖ</span> <b>Nincs riaszt√°s.</b>`;
    } else {
      warnPanel.className = warningLevelClass(Math.max(...ww.warnings.map(w=>w.szint)));
      warnDiv.innerHTML = ww.warnings.map(w=>{
        const iconAndText = warningIconAndText(w.jelzes);
        let timeInfo = w.kezdete ? `<span class="warn-time">${formatOszTime(w.kezdete)} - ${formatOszTime(w.vege)}</span>` : '';
        let teendo = szintTeendo[w.szint] || "";
        return `<span class="warn-icon">${iconAndText.icon}</span> <b>${iconAndText.text}</b> (szint: <b>${w.szint}</b>)${timeInfo}<br><b>${teendo}</b>`;
      }).join("<hr style='border:none;border-top:1px solid #eee;margin:6px 0;>");
    }
    

if (weather.current_weather.temperature >= 33)
  showAlertModal("H≈ës√©griaszt√°s","Rendk√≠v√ºl magas h≈ëm√©rs√©klet, figyelj a folyad√©kbevitelre √©s √°rny√©kban tart√≥zkodj!");


// --- Forgalmi inform√°ci√≥ (helyi √©s 60 km-es k√∂rzet) ---
let trafficObj = await getUtinform(cityName);
let localMsg = trafficObj.city && trafficObj.city.length
  ? trafficObj.city.map(x => x.title + ": " + x.desc).join("<br>")
  : "";
let around60kmMsg = trafficObj.county && trafficObj.county.length
  ? trafficObj.county.map(x => x.title + ": " + x.desc).join("<br>")
  : "";
trafficObj = { local: localMsg, around60km: around60kmMsg };


// --- Front inform√°ci√≥ gener√°l√°sa, val√≥di √°llapot + k√∂vetkez≈ë front ---
let frontBox = "";
let frontType = "";
let symptoms = "";
let frontEndTime = "";
let nextFrontTime = "";

if (weather.hourly && weather.hourly.time && weather.hourly.pressure_msl) {
  let now = new Date(weather.current_weather.time);
  let idxNow = weather.hourly.time.findIndex(x => x.startsWith(weather.current_weather.time.slice(0,13)));
  let activeFront = "";
  let frontEndIdx = null;
  let frontStartIdx = null;

  // --- Keresd, hogy most van-e front ---
  if (idxNow >= 0) {
    let presNow = weather.hourly.pressure_msl[idxNow];
    if (presNow < 1003) activeFront = "hidegfront";
    else if (presNow > 1020) activeFront = "melegfront";
  }

  // --- Ha most van front, keresd a v√©g√©t ---
  if (activeFront && idxNow >= 0) {
    for (let i = idxNow; i < Math.min(weather.hourly.time.length, idxNow + 48); i++) {
      let pres = weather.hourly.pressure_msl[i];
      if ((activeFront === "hidegfront" && pres >= 1003) ||
          (activeFront === "melegfront" && pres <= 1020)) {
        frontEndIdx = i;
        break;
      }
    }
    if (frontEndIdx !== null && (frontEndIdx + 1) < weather.hourly.time.length) {
      let dtEnd = new Date(weather.hourly.time[frontEndIdx]);
      let dtNow = new Date(weather.current_weather.time);
      let diffMs = dtEnd - dtNow;
      let diffH = Math.floor(diffMs / 3600000);
      let diffM = Math.round((diffMs % 3600000) / 60000);
      let day = Math.floor(diffH / 24);
      let hour = diffH % 24;
      let tartam = (day > 0 ? `${day} nap ` : "") + (hour > 0 ? `${hour} √≥ra ` : "") + (diffM > 0 ? `${diffM} perc` : "");
      let endHour = dtEnd.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });
      let nowDay = dtNow.getDate(), endDay = dtEnd.getDate();
      let dayLabel = (endDay === nowDay) ? "ma" : (endDay === nowDay + 1) ? "holnap" : dtEnd.toLocaleDateString('hu-HU', { month: '2-digit', day: '2-digit' });
      frontEndTime = `<br><span style='font-size:.97em;font-weight:400;'>V√°rhat√≥an frontos √°llapot v√©ge: <b>${dayLabel} ${endHour}</b> <span style="color:#198944">(${tartam} m√∫lva)</span></span>`;
    } else if (frontEndIdx !== null) {
      let dtEnd = new Date(weather.hourly.time[frontEndIdx]);
      let endHour = dtEnd.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });
      frontEndTime = `<br><span style='font-size:.97em;font-weight:400;'>A frontos √°llapot v√©ge: <b>${endHour}</b> ut√°n</span>`;
    } else {
      frontEndTime = `<br><span style='font-size:.97em;font-weight:400;'>A frontos √°llapot v√°rhat√≥an m√©g 24 √≥r√°n bel√ºl is tart.</span>`;
    }
  }

  // --- Ha most NINCS front, keresd meg a k√∂vetkez≈ë front TELJES id≈ëtartam√°t ---
if (!activeFront && idxNow >= 0) {
  let nextFrontStart = null, nextFrontEnd = null, nextFrontType = "";
  for (let i = idxNow + 1; i < Math.min(weather.hourly.time.length, idxNow + 48); i++) {
    let pres = weather.hourly.pressure_msl[i];
    if (pres < 1003 || pres > 1020) {
      nextFrontStart = i;
      nextFrontType = pres < 1003 ? "üåÄ Hidegfront" : "üåû Melegfront";
      // Most keress√ºk meg a v√©g√©t!
      for (let j = i; j < Math.min(weather.hourly.time.length, i + 48); j++) {
        let presEnd = weather.hourly.pressure_msl[j];
        if ((nextFrontType === "üåÄ Hidegfront" && presEnd >= 1003) ||
            (nextFrontType === "üåû Melegfront" && presEnd <= 1020)) {
          nextFrontEnd = j;
          break;
        }
      }
      break;
    }
  }
  if (nextFrontStart !== null) {
    let dtStart = new Date(weather.hourly.time[nextFrontStart]);
    let dtEnd = nextFrontEnd !== null ? new Date(weather.hourly.time[nextFrontEnd]) : null;
    // Adj hozz√° d√°tumot is, ha nem ugyanaz a nap!
    let sameDay = dtEnd && dtStart.getDate() === dtEnd.getDate();
    let startStr = dtStart.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' }) +
      (sameDay ? '' : ` (${dtStart.toLocaleDateString('hu-HU', { month: '2-digit', day: '2-digit' })})`);
    let endStr = dtEnd
      ? dtEnd.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' }) +
        (sameDay ? '' : ` (${dtEnd.toLocaleDateString('hu-HU', { month: '2-digit', day: '2-digit' })})`)
      : "n.a.";
    let tartam = (dtEnd && dtEnd > dtStart)
      ? Math.round((dtEnd - dtStart) / 3600000)
      : "?";
    if (dtEnd && dtEnd > dtStart) {
      nextFrontTime = `<br><span style='font-size:.97em;font-weight:400;'>K√∂vetkez≈ë front (${nextFrontType}) v√°rhat√≥an <b>${startStr}</b>-t√≥l <b>${endStr}</b>-ig (${tartam} √≥ra)</span>`;
    } else {
      nextFrontTime = `<br><span style='font-size:.97em;font-weight:400;'>K√∂vetkez≈ë front (${nextFrontType}) v√°rhat√≥an <b>${startStr}</b>-t√≥l (tartam nem meghat√°rozhat√≥)</span>`;
    }
  }
}


  // --- Panel tartalom ---
  if (activeFront === "hidegfront") {
    frontType = "üåÄ Hidegfront";
    symptoms = "Gyakori t√ºnet: fejf√°j√°s, migr√©n, v√©rnyom√°s-ingadoz√°s, √≠z√ºleti panaszok.";
  } else if (activeFront === "melegfront") {
    frontType = "üåû Melegfront";
    symptoms = "Gyakori t√ºnet: migr√©n, √°lmoss√°g, b√°gyadts√°g, ingerl√©kenys√©g.";
  } else {
    frontType = "Nincs front";
    symptoms = "Front√©rz√©kenyek ma v√°rhat√≥an nyugodtabb napra sz√°m√≠thatnak.";
  }
} else if (weather.current_weather && typeof weather.current_weather.pressure_msl === "number") {
  let p = weather.current_weather.pressure_msl;
  if (p < 1003) {
    frontType = "üåÄ Hidegfront";
    symptoms = "Gyakori t√ºnet: fejf√°j√°s, migr√©n, v√©rnyom√°s-ingadoz√°s, √≠z√ºleti panaszok.";
  }
  else if (p > 1020) {
    frontType = "üåû Melegfront";
    symptoms = "Gyakori t√ºnet: migr√©n, √°lmoss√°g, b√°gyadts√°g, ingerl√©kenys√©g.";
  }
  else {
    frontType = "Nincs front";
    symptoms = "Front√©rz√©kenyek ma v√°rhat√≥an nyugodtabb napra sz√°m√≠thatnak.";
  }
}

// --- Panel HTML ki√≠r√°s ---
if (frontType && frontType !== "Nincs front") {
  frontBox = `<div style="background:#e4f1fe;padding:8px 10px 8px 15px;margin-bottom:8px;border-radius:11px;font-size:1.02em;font-weight:600;color:#234b69;">
    ${frontType}<br>
    ${frontEndTime}
    <span style="font-weight:400">${symptoms}</span>
  </div>`;
} else if (frontType === "Nincs front") {
  frontBox = `<div style="background:#e6fbe4;padding:8px 10px 8px 15px;margin-bottom:8px;border-radius:11px;font-size:1.01em;font-weight:500;color:#198944;">
    ${frontType}
    ${nextFrontTime}
    <br><span style="font-weight:400">${symptoms}</span>
  </div>`;
}




// --- AI panel gener√°l√°sa ---
const aiSug = document.getElementById('ai-suggestion');
const trafficMsg = [trafficObj.local, trafficObj.around60km].filter(Boolean).join("<br>");

if (aiSug && aiSug.children[1]) {
  aiSug.children[1].innerHTML =
    frontBox +
    `<strong>AI aj√°nlatod m√°ra:</strong><br>` +
    generateAISuggestion(weather, airData, atmNow, trafficMsg) +
    "<br>" + getBioMeteoSummary(weather, atmNow, airData) +
    "<br>" + getBioMeteoForecast(weather, atmNow, airData); // <-- √öJ SOR!

} else if (aiSug) {
  // Itt is .innerHTML, de az aiSug.children[1] nincs, ez√©rt sz√ºl≈ëbe megy.
  aiSug.innerHTML =
    frontBox +
    `<strong>AI aj√°nlatod m√°ra:</strong><br>` +
    generateAISuggestion(weather, airData, atmNow, trafficMsg) +
    "<br>" + getBioMeteoSummary(weather, atmNow, airData) +
    "<br>" + getBioMeteoForecast(weather, atmNow, airData); // <-- √öJ SOR!
}

// ... (panelek update, t√©rk√©pek, minden egy√©b)
updateSunTimesPanel(lat, lon);
updatePressurePanel(weather);
updateClothingBlock(weather);
updateAstroWindowPanel(weather);
updateMeteorPanel();
updateAuroraPanel();
updateEarthquakePanel();
updateUvPanel(weather);
updateRainPanel(weather);
updateJamPanel(trafficObj.local, trafficObj.around60km);
initMap(lat, lon);
liveFollowPosition();
renderForecast(weather);
renderBioMeteoSparkline(weather, atmNow, airData);
updateCloudPanel(weather);

} catch (e) {
  const aiSug = document.getElementById('ai-suggestion');
  const trafficMsg = [trafficObj.local, trafficObj.around60km].filter(Boolean).join("<br>");
  if (aiSug && aiSug.children[1] && aiSug.children[1].tagName === 'SPAN') {
    aiSug.children[1].innerHTML =
      frontBox +
      `<strong>AI aj√°nlatod m√°ra:</strong><br>` +
      generateAISuggestion(weather, airData, atmNow, trafficMsg) +
      "<br>" + getBioMeteoSummary(weather, atmNow, airData) +
      "<br>" + getBioMeteoForecast(weather, atmNow, airData); // <-- √öJ SOR!

  } else if (aiSug) {
    // V√©gs≈ë fallback: √≠rja ki az eg√©sz dobozt, SVG-vel egy√ºtt
    aiSug.innerHTML =
      `<svg ...></svg>
      <span>` +
      frontBox +
      `<strong>AI aj√°nlatod m√°ra:</strong><br>` +
      generateAISuggestion(weather, airData, atmNow, trafficMsg) +
      "<br>" + getBioMeteoSummary(weather, atmNow, airData) +
      `</span>`;
  }

  // ... a t√∂bbi hiba panel √ºres√≠t√©s:
  const weatherPanel = document.getElementById('weather');
  if (weatherPanel) weatherPanel.textContent = "Nincs √©l≈ë adat.";
  const cityPanel = document.getElementById('city');
  if (cityPanel) cityPanel.textContent = "";
  const atmPanel = document.getElementById('atm-panel');
  if (atmPanel) atmPanel.textContent = "";
  const airQuality = document.getElementById('air-quality');
  if (airQuality) airQuality.textContent = "";
  const airComponents = document.getElementById('air-components');
  if (airComponents) airComponents.textContent = "";
  const pollenPanel = document.getElementById('pollen-panel');
  if (pollenPanel) pollenPanel.textContent = "";
  const weatherWarn = document.getElementById('weather-warning-details');
  if (weatherWarn) weatherWarn.textContent = "";
  const trafficInfo = document.getElementById('traffic-info');
  if (trafficInfo) {
    trafficInfo.textContent = "";
    trafficInfo.innerHTML = "üö¶ <b>Forgalmi inform√°ci√≥:</b> Nincs adat";
  }
}

}

// --- Waze iframe automatikus poz√≠ci√≥ ---
// Ez mindig a te aktu√°lis poz√≠ci√≥dat mutatja a waze t√©rk√©pen!
function updateWazeIframe(lat, lon) {
  const zoom = 11;
  const src = `https://embed.waze.com/iframe?zoom=${zoom}&lat=${lat}&lon=${lon}`;
  document.getElementById('wazeFrame').src = src;
}
getPosition().then(coords => {
  updateWazeIframe(coords.latitude, coords.longitude);
});
// if (navigator.geolocation) {
 // navigator.geolocation.watchPosition(pos => {
  //  updateWazeIframe(pos.coords.latitude, pos.coords.longitude);
 // });
// }


window.onload = loadEcoData;
setInterval(loadEcoData, 60000); // 1 percenk√©nt √∫jra friss√≠t

setInterval(updateAuroraPanel, 900000); // 15 perc


let recognizing = false;
let recognition;
let targetLang = "en";

// --- Z√°szl√≥ gombok kezel√©se a FORD√çT√ì panelhez ---
document.querySelectorAll('.flagBtn').forEach(btn => {
  btn.onclick = function() {
    document.querySelectorAll('.flagBtn').forEach(b => b.classList.remove('selected'));
    this.classList.add('selected');
    targetLang = this.dataset.lang;
  }
});
document.querySelector('.flagBtn[data-lang="en"]')?.classList.add('selected');

// --- Mikrofon logika ---
const micBtn = document.getElementById('micBtn');
if (micBtn) {
  micBtn.onclick = function() {
    if (!recognition) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.interimResults = false;
      recognition.continuous = false; // csak egy mondat
      recognition.lang = "hu-HU";     // mindig magyar!
      recognition.onresult = function(event) {
        const text = Array.from(event.results).map(r => r[0].transcript).join(' ').trim();
        document.getElementById('speechResult').textContent = text;
        const manualInput = document.getElementById('manualInput');
        if (manualInput) manualInput.value = text; // <-- ide is bem√°solja
      };
      recognition.onerror = function(event) {
        document.getElementById('speechResult').textContent = "Hiba: " + event.error;
        micBtn.classList.remove('active');
        recognizing = false;
      };
      recognition.onend = function() {
        micBtn.classList.remove('active');
        recognizing = false;
      };
    }
    if (!recognizing) {
      recognition.start();
      recognizing = true;
      this.classList.add('active');
      document.getElementById('speechResult').textContent = "Besz√©lj most... (magyar)";
    } else {
      recognition.stop();
      recognizing = false;
      this.classList.remove('active');
    }
  };
}

// --- Ford√≠t√≥ gomb ---
const translateBtn = document.getElementById('translateBtn');
if (translateBtn) {
  translateBtn.onclick = async function() {
    const text = document.getElementById('manualInput')?.value || "";
    document.getElementById('translateResult').textContent = "Ford√≠t√°s...";
    const translation = await translateWithLibre(text, targetLang, "auto");
    document.getElementById('translateResult').textContent = translation;
  };
}

// --- Ford√≠t√°s (LibreTranslate API) ---
async function translateWithLibre(text, targetLang = "en", sourceLang = "auto") {
  if (!text.trim()) return "";
  try {
    const res = await fetch("https://libretranslate.de/translate", {
      method: "POST",
      body: JSON.stringify({
        q: text,
        source: sourceLang,
        target: targetLang,
        format: "text"
      }),
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json();
    return data.translatedText || "[Nincs ford√≠t√°s]";
  } catch (e) {
    return "[Ford√≠t√°si hiba]";
  }
}

function updateCloudPanel(weather) {
  if (!weather || !weather.hourly || !weather.hourly.cloudcover || !weather.hourly.time)
    return document.getElementById('cloud-panel').textContent = "Nincs adat.";
  let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
  if (nowIdx < 0) nowIdx = 0;
  let currentCloud = weather.hourly.cloudcover[nowIdx];
  // 8 √≥r√°ra el≈ëre, √°tlag
  let sum = 0, n = 0;
  for (let i = nowIdx; i < Math.min(nowIdx+8, weather.hourly.cloudcover.length); i++) {
    sum += weather.hourly.cloudcover[i];
    n++;
  }
  let avgCloud = n ? Math.round(sum/n) : currentCloud;
  let currentDesc = currentCloud <= 15 ? "der√ºlt" : currentCloud <= 50 ? "gyeng√©n felh≈ës" : currentCloud <= 85 ? "er≈ësen felh≈ës" : "borult";
  let forecastDesc = avgCloud <= 15 ? "der√ºlt" : avgCloud <= 50 ? "gyeng√©n felh≈ës" : avgCloud <= 85 ? "er≈ësen felh≈ës" : "borult";
  document.getElementById('cloud-panel').innerHTML =
    `<b>Most:</b> ${currentCloud}% ‚Äì ${currentDesc}<br><b>8 √≥r√°s √°tlag:</b> ${avgCloud}% ‚Äì ${forecastDesc}`;
}

function calcBiometeoLevel(weather, atm, air, idx, nowIdx) {
  let level = 0, reasons = [];
  // --- Front detekt√°l√°s ---
  let pres = weather.hourly && weather.hourly.pressure_msl ? weather.hourly.pressure_msl[idx] : null;
  if (pres !== null) {
    if (pres < 1003 || pres > 1020) { level++; reasons.push("front"); }
  }
  // --- P√°ratartalom ---
  let humidity = weather.hourly.relative_humidity_2m?.[idx];
  if (humidity !== undefined) {
    if (humidity >= 75 || humidity <= 35) { level++; reasons.push("p√°ratartalom"); }
  }
  // --- Sz√©l ---
  let wind = weather.hourly.windspeed_10m?.[idx];
  if (wind !== undefined && wind >= 30) { level++; reasons.push("sz√©l"); }
  // --- UV ---
  let uv = weather.hourly.uv_index?.[idx];
  if (uv !== undefined && uv >= 6) { level++; reasons.push("UV"); }
  // --- L√©gszennyez√©s --- csak az aktu√°lis √≥r√°ban!
  if (
    air && air.components &&
    idx === nowIdx && // <-- Csak a mostani √≥ra!
    (
      (air.components.pm2_5 && air.components.pm2_5 > 18) ||
      (air.components.o3 && air.components.o3 > 80) ||
      (air.components.pm10 && air.components.pm10 > 25) ||
      (air.components.no2 && air.components.no2 > 0.1) ||
      (air.components.co && air.components.co > 4000)
    )
  ) {
    level++; reasons.push("l√©gszennyez√©s");
  }
  return {level: Math.min(level,2), reasons};
}

function openSymptomDiary() {
  // El≈ët√∂lt√©s
  let diary = JSON.parse(localStorage.getItem("symptomDiary") || "{}");
  let today = new Date().toISOString().slice(0,10);
  let rec = diary[today] || {};
  document.getElementById('cb-fejfajas').checked = !!rec.fejfajas;
  document.getElementById('cb-faradtsag').checked = !!rec.faradtsag;
  document.getElementById('cb-alvaszavar').checked = !!rec.alvaszavar;
  document.getElementById('cb-ingerkekenyseg').checked = !!rec.ingerkekenyseg;
  document.getElementById('inp-egyeb').value = rec.egyeb || "";
  document.getElementById('symptomModal').style.display = "block";
}

function saveSymptomDiary() {
  let diary = JSON.parse(localStorage.getItem("symptomDiary") || "{}");
  let today = new Date().toISOString().slice(0,10);

  // --- Biometeo √°llapot bek√©r√©se a napl√≥z√°shoz (aktu√°lis front, szmog, UV, sz√©l stb.) ---
  // Itt a te AI biometeo-f√ºggv√©nyeidet h√≠vd!
  let bioLevel = window.currentBioLevel || 0;
  let bioRisks = window.currentBioRisks || [];
  let front = window.currentFrontType || "";    // pl. "hidegfront" / "melegfront" / ""
  let szmog = window.currentSzmog || false;
  let uv = window.currentUV || 0;
  let szel = window.currentWind || 0;
  let homerseklet = window.currentTemp || 0;
  let paratartalom = window.currentHumidity || 0;

  diary[today] = {
    fejfajas: document.getElementById('cb-fejfajas').checked,
    faradtsag: document.getElementById('cb-faradtsag').checked,
    alvaszavar: document.getElementById('cb-alvaszavar').checked,
    ingerkekenyseg: document.getElementById('cb-ingerkekenyseg').checked,
    egyeb: document.getElementById('inp-egyeb').value.trim(),
    bioLevel, bioRisks, front, szmog, uv, szel, homerseklet, paratartalom
  };
  localStorage.setItem("symptomDiary", JSON.stringify(diary));
  document.getElementById('symptomModal').style.display = "none";
  alert("T√ºnetek √©s aktu√°lis biometeo √°llapot mentve.");
}

function showSymptomAnalysis() {
  let diary = JSON.parse(localStorage.getItem("symptomDiary") || "{}");
  let napok = Object.keys(diary).slice(-14); // utols√≥ 14 nap
  let stat = {fejfajas:0, front:0, szmog:0, fejfajasFront:0, fejfajasSzmog:0, fejfajasBio:0};
  let fejBioRisks = {};
  napok.forEach(nap => {
    let rec = diary[nap];
    if(rec.fejfajas) {
      stat.fejfajas++;
      if(rec.front && rec.front!=="") stat.fejfajasFront++;
      if(rec.szmog) stat.fejfajasSzmog++;
      if(rec.bioLevel>=1) stat.fejfajasBio++;
      if(rec.bioRisks) rec.bioRisks.forEach(r=>{ fejBioRisks[r]=(fejBioRisks[r]||0)+1; });
    }
    if(rec.front && rec.front!=="") stat.front++;
    if(rec.szmog) stat.szmog++;
  });
  // AI sz√∂veg automatikus:
  let txt = "";
  if(stat.fejfajas) {
    txt += `Az elm√∫lt 2 h√©tben <b>${stat.fejfajas}</b> alkalommal volt fejf√°j√°sod.<br>`;
    if(stat.fejfajasFront)
      txt += `A fejf√°j√°sok <b>${Math.round(100*stat.fejfajasFront/stat.fejfajas)}%</b>-a frontos napon jelentkezett.<br>`;
    if(stat.fejfajasSzmog)
      txt += `A fejf√°j√°sok <b>${Math.round(100*stat.fejfajasSzmog/stat.fejfajas)}%</b>-a szmogos id≈ëben volt.<br>`;
    if(stat.fejfajasBio)
      txt += `A fejf√°j√°sok <b>${Math.round(100*stat.fejfajasBio/stat.fejfajas)}%</b>-a k√∂zepes vagy magas biometeo terhel√©sn√©l fordult el≈ë.<br>`;
    if(Object.keys(fejBioRisks).length)
      txt += `Leggyakoribb biometeo okok fejf√°j√°skor: <b>${Object.keys(fejBioRisks).join(", ")}</b>`;
  } else {
    txt = "Az elm√∫lt 2 h√©tben nem r√∂gz√≠tett√©l fejf√°j√°st.";
  }
  document.getElementById('symptom-analysis-result').innerHTML = txt;
  drawSymptomDiagram(napok, diary);
  document.getElementById('symptom-analysis-modal').style.display = "block";
}

function drawSymptomDiagram(napok, diary) {
  // Mini vonaldiagram: X=tizedik napt√≥l mostan√°ig, Y: fejf√°j√°s, front, szmog
  let ctx = document.getElementById('symptom-diagram').getContext('2d');
  ctx.clearRect(0,0,400,110);
  // Tengelyek
  ctx.strokeStyle="#bbb"; ctx.beginPath(); ctx.moveTo(38,14);ctx.lineTo(38,100);ctx.lineTo(398,100);ctx.stroke();
  // Napi jelek
  let dx = (400-45)/Math.max(1,napok.length-1);
  napok.forEach((nap,n) => {
    let rec = diary[nap];
    let x = 38 + n*dx;
    // Fejf√°j√°s: piros pont, front: k√©k n√©gyzet, szmog: s√°rga h√°romsz√∂g
    if(rec.fejfajas) { ctx.fillStyle="#e23"; ctx.beginPath(); ctx.arc(x,90,6,0,2*Math.PI); ctx.fill(); }
    if(rec.front && rec.front!=="") { ctx.fillStyle="#36c"; ctx.fillRect(x-6,70,12,12);}
    if(rec.szmog) { ctx.fillStyle="#dc0"; ctx.beginPath(); ctx.moveTo(x,53);ctx.lineTo(x-7,65);ctx.lineTo(x+7,65);ctx.closePath();ctx.fill();}
    ctx.fillStyle="#444"; ctx.font="11px sans-serif";
    ctx.fillText(nap.slice(5),x-10,105); // d√°tum, csak h√≥-nap
  });
  // Jelmagyar√°zat
  ctx.fillStyle="#e23";ctx.beginPath();ctx.arc(60,18,5,0,2*Math.PI);ctx.fill(); ctx.fillStyle="#444";ctx.fillText("Fejf√°j√°s",70,22);
  ctx.fillStyle="#36c";ctx.fillRect(130,13,12,12);ctx.fillStyle="#444";ctx.fillText("Front",147,22);
  ctx.fillStyle="#dc0";ctx.beginPath();ctx.moveTo(205,17);ctx.lineTo(198,28);ctx.lineTo(212,28);ctx.closePath();ctx.fill();ctx.fillStyle="#444";ctx.fillText("Szmog",215,22);
}

function deleteSymptomDiary() {
  if (confirm("Biztosan t√∂rl√∂d az √∂sszes t√ºnetnapl√≥-adatot? Ez nem visszavonhat√≥!")) {
    localStorage.removeItem("symptomDiary");
    alert("Az √∂sszes napl√≥zott adat t√∂r√∂lve! Mostant√≥l √∫jra kezdheted a r√∂gz√≠t√©st √©s elemz√©st.");
  }
}



</script>
</body>
</html>
