<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>EcoLife AI ‚Äì 2D t√©rk√©p, radar, okos figyelmeztet√©s</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root {
      --bg: linear-gradient(120deg,#e9ffe7 0%,#cbf3d2 100%);
      --fg: #21321b;
      --panel: #fff;
    }
    body {background:var(--bg);font-family:'Montserrat',sans-serif;margin:0;color:var(--fg);min-height:100vh;transition:.4s;}
    .container {max-width:560px;margin:10px auto 0 auto;padding:10px 0 16px 0;background:var(--panel);
      border-radius:22px;box-shadow:0 8px 32px rgba(48,89,64,0.17);}
    h1 {text-align:center;font-size:2.1rem;color:#247a36;margin:6px 0 16px 0;}
    .ai-suggestion {background:#e3ffe7;border-left:5px solid #58d172;padding:18px 14px 18px 24px;
      border-radius:16px;font-size:1.14rem;margin-bottom:18px;display:flex;align-items:center;gap:10px;
      box-shadow:0 2px 8px rgba(85,180,120,0.08);}
    .ai-suggestion svg {flex-shrink:0;width:26px;height:26px;}
    .section-title {font-size:1.09rem;color:#28853b;margin:20px 0 11px 8px;font-weight:700;}
    .eco-cards {display:flex;gap:12px;flex-wrap:wrap;margin-bottom:9px;}
    .eco-card {flex:1 1 142px;background:linear-gradient(115deg,#e8f5e9 60%,#d2ffef 100%);
      border-radius:14px;box-shadow:0 2px 8px rgba(63,155,120,0.09);padding:13px 9px 9px 13px;
      display:flex;flex-direction:column;align-items:flex-start;min-width:116px;max-width:210px;margin-bottom:7px;}
    .eco-card strong {font-size:1.06rem;color:#246c38;}
    .eco-card small,.eco-card span {color:#557b61;font-size:.97rem;}
    .eco-icon {font-size:1.11rem;margin-right:7px;}
    .badges {display:flex;gap:7px;flex-wrap:wrap;margin-top:7px;}
    .badge {background:#ebffe8;border-radius:8px;padding:3px 7px;font-size:.97em;}
    .badge.pm10 {background:#f5ffe1;}
    .badge.no2 {background:#f7f3ff;}
    .badge.o3 {background:#e2f6ff;}
    .badge.co {background:#fff4e2;}
    .challenge-row {display:flex;align-items:center;justify-content:space-between;gap:7px;}
    .challenge-desc {font-size:1.02rem;color:#187441;font-weight:500;}
    .challenge-btn {background:#52c77b;color:#fff;border:none;border-radius:10px;padding:7px 15px;
      font-size:.99rem;font-weight:600;cursor:pointer;transition:background .2s;}
    .challenge-btn:hover {background:#329758;}
    .map-header {display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
    .map-btn {background:#d9f5dd;border:none;color:#187a4c;font-weight:700;
      border-radius:9px;padding:5px 16px;font-size:1.08em;margin-right:8px;cursor:pointer;}
    .map-btn.selected {background:#33ba72;color:#fff;}
    .street-btn {background:#f5ffe2;color:#187a4c;border-radius:10px;font-weight:600;
      padding:4px 16px;font-size:1em;margin-right:2px;cursor:pointer;}
    .street-btn:hover {background:#e4ffe3;}
    .darkmode-btn {background:#253e28;color:#d5ffd6;padding:4px 12px;border:none;border-radius:9px;cursor:pointer;float:right;}
    .map-box {width:100%;height:220px;min-height:155px;max-height:350px;position:relative;
      border-radius:15px;overflow:hidden;box-shadow:0 2px 12px #d6e6d9;}
    #leafletmap {width:100%;height:100%;border-radius:15px;}
    .footer {text-align:center;color:#aad2bb;margin:21px 0 7px 0;font-size:.97rem;}
    .forecast-panel {display:flex;gap:12px;margin:10px 0 0 6px;justify-content: center;}
    .forecast-day {background:#e7fbf6;padding:9px 12px;border-radius:13px;box-shadow:0 1px 6px #b6e6d5;
      text-align:center;min-width:72px;}
    .forecast-day .day {font-weight:700;color:#167c44;}
    .forecast-day .icon {font-size:1.5em;}
    .forecast-day .temp {font-size:1.11em;}
    .info-panel {text-align:center;font-size:1.04em;margin:3px 0 2px 0;background:#f2fff6;
      border-radius:10px;padding:4px 0;}
    .info-panel.front {color:#3477af;}
    .info-panel.sun {color:#247a36;}
    .info-panel.pollen {color:#bb6827;}
    .info-panel.jam {color:#c0132e;}
    .modal-bg {position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(48,48,48,0.18);display:none;align-items:center;justify-content:center;}
    .modal-card {background:#fff;border-radius:22px;box-shadow:0 4px 32px #b2c0b3;padding:26px 18px;max-width:340px;text-align:center;}
    .modal-card h3 {margin:0 0 7px 0;color:#c0132e;font-size:1.21em;}
    .modal-card .modal-msg {font-size:1.06em;margin-bottom:12px;}
    .modal-card .modal-ok {margin-top:9px;padding:8px 28px;border:none;background:#248645;color:#fff;font-size:1.04em;border-radius:12px;cursor:pointer;}
    body.dark {
      --bg: linear-gradient(120deg,#222c24 0%,#1e2730 100%);
      --fg: #e3ffe7;
      --panel: #203628;
    }
    body.dark .eco-card, body.dark .forecast-day, body.dark .modal-card {background:#223929!important;color:#a5ffd9;}
    body.dark h1 {color:#82fcab;}
    body.dark .ai-suggestion {background:#19361d;color:#88ffaa;}
    body.dark .footer {color:#427759;}
    body.dark .map-btn, body.dark .street-btn, body.dark .darkmode-btn {background:#2d4936!important;color:#b1ffde;}
    @media (max-width:700px){.container{max-width:100vw;} .eco-cards{flex-direction:column;}
      .map-box{height:190px;min-height:124px;}}
    @media (max-width:430px){.container{padding:1px;} .eco-card{min-width:90px;} h1{font-size:1.25em;}}

.flagBtn.selected {
  border-bottom: 3px solid #38d473;
  background: #e3ffe6;
  color: #145c2c;
}
.flagBtn {
  transition: 0.15s;
  border-radius: 8px;
}


  </style>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <div class="container">
    <button class="darkmode-btn" id="darkmodeBtn" title="S√∂t√©t m√≥d v√°lt√°s üåô">üåô</button>
    <h1>üå± EcoLife AI</h1>
    <div id="ai-suggestion" class="ai-suggestion">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 16v-4M12 8h.01" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span><strong>AI aj√°nlatod t√∂lt≈ëdik‚Ä¶</strong></span>
    </div>
    <!-- INFO panelek -->
    <div id="sun-times-panel" class="info-panel sun"></div>
    <div id="pressure-panel" class="info-panel front"></div>
    <div id="pollen-hour-panel" class="info-panel pollen"></div>
    <div id="ragweed-alert-panel" class="info-panel pollen" style="margin-top:2px;"></div>

    <div id="jam-info-panel" class="info-panel jam"></div>
    <div class="section-title">üå§ √âl≈ë √ñko-adatok</div>
    <div class="eco-cards">
      <div class="eco-card">
  <span class="eco-icon">üëï</span>
  <strong>√ñlt√∂z√©k most √©s 8 √≥r√°n bel√ºl:</strong>
  <div id="clothing-now">Jelenleg bet√∂lt√©s...</div>
  <div id="clothing-forecast" style="margin-top:2px;font-size:.96em;color:#287c50"></div>
</div>

      <div class="eco-card"><span class="eco-icon">üèôÔ∏è</span><strong>Hely:</strong>
        <small id="city">Bet√∂lt√©s‚Ä¶</small></div>
      <div class="eco-card"><span class="eco-icon">üå°Ô∏è</span><strong>H≈ëm√©rs√©klet:</strong>
        <small id="weather">Bet√∂lt√©s‚Ä¶</small></div>
      <div class="eco-card"><span class="eco-icon">üåû</span><strong>UV-index:</strong>
        <small id="uv">Bet√∂lt√©s‚Ä¶</small></div>
      <div class="eco-card"><span class="eco-icon">üå¨Ô∏è</span><strong>Leveg≈ëmin≈ës√©g:</strong>
        <small id="air-quality">Bet√∂lt√©s‚Ä¶</small>
        <div class="badges" id="air-components"></div></div>
      <div class="eco-card"><span class="eco-icon">üå´Ô∏è</span><strong>L√°t√°si viszony, p√°ratartalom, sz√©l:</strong>
        <small id="atm-panel">Bet√∂lt√©s‚Ä¶</small></div>
      <div id="allergen-alert-bar" style="display:none;padding:9px 9px 9px 12px;background:#ffe6e6;color:#b51616;border-radius:11px;margin-bottom:8px;font-weight:600;font-size:1.09em;text-align:left;">
</div>
<div class="eco-card"><span class="eco-icon">üå∏</span><strong>Pollen el≈ërejelz√©s:</strong>
  <small id="pollen-panel">Bet√∂lt√©s‚Ä¶</small>
</div>

      <div class="eco-card" id="weather-warning-card"><span class="eco-icon">‚õàÔ∏è</span>
        <strong>Vesz√©lyjelz√©s:</strong>
        <div id="weather-warning-details"><small>Bet√∂lt√©s‚Ä¶</small></div></div>
      <div class="eco-card"><span class="eco-icon">üèÜ</span>
        <strong>Heti √∂ko-kih√≠v√°sod:</strong>
        <div class="challenge-row">
          <span class="challenge-desc">Bring√°zz legal√°bb 10 km-t!</span>
          <button class="challenge-btn" onclick="completeChallenge()">Teljes√≠tettem</button>
        </div>
        <small id="challenge-status">0 teljes√≠t√©s</small>
      </div>
    </div>
   



 <!-- K√âT PANEL EGY SORBAN, flex-ben -->
<div style="display:flex; gap:28px; align-items:flex-start; justify-content:center; margin-bottom:36px;">
  <!-- BAL: Mikrofonos bemenet -->
  <div style="min-width:230px;max-width:310px;">
    <div id="speech-translate-panel" style="display:flex;align-items:center;gap:12px;justify-content:flex-start;">
      <button id="micBtn" style="font-size:1.7em;padding:5px 12px;border-radius:50%;border:2px solid #38d473;background:#e3ffe6;cursor:pointer;">üé§</button>
      <span style="font-weight:600;font-size:1.08em;">Hangfelismer√©s</span>
    </div>
    <div id="speechResult" style="min-height:2em;text-align:left;font-size:1.09em;color:#207b49;padding:4px 0 8px 0;border-bottom:1px solid #e8f8f0;"></div>
    <div style="font-size:.96em;color:#888;">(Itt jelenik meg amit bemondt√°l ‚Äì ezt m√°sold √°t a Google Translate-be!)</div>
  </div>
  <!-- JOBB: Gomb Google Translate-hez -->
  <div style="min-width:230px;max-width:310px;text-align:center;">
    <a href="https://translate.google.com/" target="_blank" style="display:inline-block;padding:12px 26px;border-radius:13px;background:#36a5f2;color:#fff;font-weight:600;text-decoration:none;margin-top:8px;font-size:1.13em;">Google Translate megnyit√°sa</a>
    <div style="font-size:.97em;color:#247a36;margin-top:13px;">
      <b>Google Translate</b><br>
      M√°sold be ide a bal oldali sz√∂veget, v√°laszd ki a c√©lnyelvet!
    </div>
  </div>
</div>






<div class="section-title">üó∫Ô∏è √âl≈ë 2D t√©rk√©p & POI / Utcak√©p</div>

<div class="map-header" style="display:flex;justify-content:center;gap:18px;margin-bottom:10px;">
  <button id="btn2d" class="map-btn selected">2D t√©rk√©p</button>
  <button id="btnstreet" class="street-btn"><span style="font-size:1.2em;">üì∑</span> Utcak√©p</button>
</div>

<!-- K√∂z√∂s t√©rk√©ptart√≥ doboz, max-width egyezik! -->
<div style="width:100%;max-width:600px;margin:0 auto;">

  <!-- OSM t√©rk√©p -->
  <div class="map-box" style="width:100%;margin-bottom:15px;">
    <div id="leafletmap" style="width:100%;height:250px;border-radius:14px;box-shadow:0 2px 14px #9ee0b1;"></div>
  </div>

  <!-- Waze t√©rk√©p -->
  <div class="map-box" style="width:100%;margin-bottom:0;">
    <iframe id="wazeFrame"
      src="https://embed.waze.com/iframe?zoom=11&lat=47.191&lon=19.445"
      width="100%" height="250"
      style="width:100%;border-radius:14px;border:2px solid #c3ebca;box-shadow:0 2px 14px #9ee0b1;display:block;margin:0 auto;"
      allowfullscreen></iframe>
    <div style="font-size:.96em;color:#207b49;margin-top:3px;text-align:center;">
      Waze forgalmi t√©rk√©p (nagy√≠that√≥, friss√ºl≈ë adatok)
      <br>
      <a href="https://www.waze.com/hu/live-map/" target="_blank" style="color:#1984ce;">Waze Live Map (√∫j ablakban)</a>
    </div>
  </div>

</div>





    <div id="traffic-info" style="text-align:center; margin:10px 0; color:#1e6b1a; font-size:1.08em;"></div>
    
    <div class="section-title">üìÖ Kiemelt esem√©nyek, rendezv√©nyek a k√∂zelben</div>
    <div id="event-list"></div>
    <div id="omsz-radar" style="margin:18px 0 0 0;text-align:center;">
      <img src="https://www.met.hu/idojaras/radar/radar_animation.gif"
       alt="OMSZ radar"
       style="max-width:98%;border-radius:16px;box-shadow:0 2px 18px #8888;">
      <br>
      <span style="font-size:.98em;color:#237a36;">
        OMSZ hivatalos radar (statikus k√©p, 15p friss√≠t√©s)
      </span>
      <div style="margin-top:12px;">
        <button onclick="window.open('https://www.met.hu/idojaras/aktualis_idojaras/radar/', '_blank', 'width=950,height=750')"
          style="background:#e8ffeb;color:#247a36;padding:7px 19px;border-radius:9px;border:none;cursor:pointer;font-size:1.06em;">
          OMSZ Radar (val√≥sidej≈±, teljes oldal)
        </button>
      </div>
    </div>
    <div class="footer">
      &copy; 2025 EcoLife AI | <span style="color:#7bbd97">Mobil-optimaliz√°lt, radar+esem√©nyek, el≈ërejelz√©s, s√∂t√©t m√≥d</span>
    </div>
    <div class="modal-bg" id="alertModal">
      <div class="modal-card">
        <h3 id="modalTitle">Figyelem!</h3>
        <div class="modal-msg" id="modalMsg">Valamilyen vesz√©ly!</div>
        <button class="modal-ok" onclick="document.getElementById('alertModal').style.display='none'">OK</button>
      </div>
    </div>
  </div>
<script>

function getDressTip(temp, wind, humidity) {
  let dress = "";
  if (temp >= 29) dress = "K√∂nny≈± ny√°ri ruha, sapka, sok folyad√©k!";
  else if (temp >= 22) dress = "R√∂vid ujj√∫ p√≥l√≥, k√∂nny≈± nadr√°g aj√°nlott.";
  else if (temp >= 17) dress = "Hossz√∫ ujj√∫ p√≥l√≥, v√©kony pul√≥ver.";
  else if (temp >= 12) dress = "K√∂nny≈± dzseki, r√©teges √∂lt√∂zet.";
  else if (temp >= 5) dress = "Melegebb kab√°t, pul√≥ver, s√°l.";
  else if (temp >= -3) dress = "T√©li kab√°t, sapka, s√°l, keszty≈±!";
  else dress = "Extr√©m hideg! Vastag, r√©teges t√©li √∂lt√∂zet, sapka, s√°l, keszty≈± k√∂telez≈ë!";
  if (wind > 18) dress += " (Er≈ës sz√©l miatt hidegebbnek √©rz≈ëdik!)";
  if (humidity > 85 && temp > 18) dress += " (Magas p√°ratartalom miatt f√ºlledtebbnek √©rz≈ëdik.)";
  return dress;
}

// --- 8 √≥r√°s el≈ërejelz√©s ki√≠r√°sa
function updateClothingBlock(weather) {
  // Jelenlegi adatok
  let tNow = weather.current_weather.temperature;
  let idxNow = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
  let windNow = weather.hourly.windspeed_10m[idxNow] || 0;
  let humNow = weather.hourly.relative_humidity_2m[idxNow] || 0;
  document.getElementById('clothing-now').innerHTML = "<b>Most:</b> " + getDressTip(tNow, windNow, humNow);

  // 8 √≥r√°val k√©s≈ëbbi adatok (ha el√©rhet≈ë)
  let idx8h = idxNow + 8;
  if (weather.hourly.temperature_2m[idx8h] !== undefined) {
    let t8h = weather.hourly.temperature_2m[idx8h];
    let w8h = weather.hourly.windspeed_10m[idx8h] || 0;
    let h8h = weather.hourly.relative_humidity_2m[idx8h] || 0;
    document.getElementById('clothing-forecast').innerHTML =
      "<b>V√°rhat√≥an 8 √≥ra m√∫lva:</b> " + getDressTip(t8h, w8h, h8h) +
      ` <span style="color:#7ba886;font-size:.93em">(${Math.round(t8h)}¬∞C)</span>`;
  } else {
    document.getElementById('clothing-forecast').innerHTML = "El≈ërejelz√©s nem el√©rhet≈ë.";
  }
}


// === SUN TIMES (napkelte/napnyugta) ===
function getSunTimes(lat, lon) {
  const d = new Date();
  const y = d.getFullYear(), m = d.getMonth()+1, day = d.getDate();
  return fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&date=${y}-${m<10?'0'+m:m}-${day<10?'0'+day:day}&formatted=0`)
    .then(res => res.json())
    .then(data => ({
      sunrise: new Date(data.results.sunrise).toLocaleTimeString('hu-HU',{hour:'2-digit',minute:'2-digit'}),
      sunset: new Date(data.results.sunset).toLocaleTimeString('hu-HU',{hour:'2-digit',minute:'2-digit'})
    }));
}

// --- BKK Budapest buszmeg√°ll√≥ √©l≈ë j√°rat inf√≥ lek√©r√©se ---
async function showBkkBusArrivals(stopId, marker) {
  try {
    const res = await fetch(`https://futar.bkk.hu/api/query/v1/ws/stop-arrivals?stopId=${stopId}`);
    const data = await res.json();
    if (!data.data || !data.data.arrivals.length) {
      marker.bindPopup("<b>Nincs el√©rhet≈ë j√°rat inform√°ci√≥.</b>").openPopup();
      return;
    }
    let info = data.data.arrivals.map(arr =>
      `<b>${arr.routeShortName}</b> ‚Üí ${arr.headsign} (${Math.round((arr.departureTimestamp*1000 - Date.now())/60000)} perc m√∫lva)`
    ).join('<br>');
    marker.bindPopup(`<b>√âl≈ë j√°ratok:</b><br>${info}`).openPopup();
  } catch (e) {
    marker.bindPopup("<b>Nem siker√ºlt lek√©rni az √©l≈ë j√°ratokat.</b>").openPopup();
  }
}

// --- M√ºnchen MVV √©l≈ë indul√°sok ---
async function showMunichStopDepartures(stopName, marker) {
  try {
    const res = await fetch(`https://api.mvv.app/api/locate?query=${encodeURIComponent(stopName)}`);
    const locations = await res.json();
    if (!locations.length) {
      marker.bindPopup(`<b>Nincs ilyen meg√°ll√≥ az MVV rendszer√©ben!</b>`).openPopup();
      return;
    }
    let stopId = locations[0].id;
    const depRes = await fetch(`https://api.mvv.app/api/departure?station=${stopId}`);
    const depData = await depRes.json();
    if (!depData.departures || !depData.departures.length) {
      marker.bindPopup("<b>Nincs indul√°s az elk√∂vetkez≈ë 30 percben!</b>").openPopup();
      return;
    }
    function getTransportIcon(type, label) {
      if (/^U\d+/.test(label))   return "üöá";
      if (/^S\d+/.test(label))   return "üöà";
      if (/^(RB|RE|IC|EC|ICE)/.test(label)) return "üöÑ";
      if (/^(N?\d{1,3})$/.test(label)) return "üöå";
      if (/^(T|Tram|\d{1,2})/.test(label)) return "üöã";
      return "üöç";
    }
    let html = depData.departures.slice(0,14).map(dep =>
      `<span style="font-size:1.3em">${getTransportIcon(dep.product, dep.label)}</span> 
      <b>${dep.label}</b> ‚Üí <span style="color:#1a8fba">${dep.destination}</span>
      <span style="color:#5c9d33;">(${dep.departureTimeMinutes} perc m√∫lva)</span>`
    ).join('<br>');
    marker.bindPopup(
      `<div style="min-width:210px">
        <b>√âl≈ë indul√°sok (${stopName}):</b><br>
        ${html}
        <br><a href="https://efa.mvv-muenchen.de/index.html#trip@enquiry" target="_blank" style="font-size:.93em;color:#2486cc;">MVV Fahrplanauskunft</a>
      </div>`
    ).openPopup();
  } catch (e) {
    marker.bindPopup("<b>Nem siker√ºlt lek√©rni az √©l≈ë menetrendet.</b>").openPopup();
  }
}

// --- √ötinform.hu RSS ---
async function getUtinform(cityName = "") {
  try {
    const proxy = "https://api.allorigins.win/get?url=";
    const url = "https://www.utinform.hu/rss/utinformhirek.rss";
    const res = await fetch(proxy + encodeURIComponent(url));
    const data = await res.json();
    const parser = new window.DOMParser();
    const xml = parser.parseFromString(data.contents, "text/xml");
    const items = xml.querySelectorAll("item");
    let msgList = [];
    items.forEach(item => {
      const title = item.querySelector("title")?.textContent || "";
      const desc = item.querySelector("description")?.textContent || "";
      msgList.push({title, desc});
    });

    // K√∂zvetlen k√∂rnyezet (v√°ros)
    let cityHits = cityName
      ? msgList.filter(x => x.title.includes(cityName) || x.desc.includes(cityName))
      : [];
    // 60km k√∂rzet = megyen√©v
    let megyek = ["Fej√©r","Pest","Kom√°rom","Veszpr√©m","Tolna","Somogy","Budapest"];
    let countyHits = [];
    for (let county of megyek) {
      countyHits.push(...msgList.filter(x => x.title.includes(county) || x.desc.includes(county)));
    }
    return {city: cityHits, county: countyHits, all: msgList.slice(0, 2)};
  } catch (e) {
    return {city: [], county: [], all: []};
  }
}



const OPENWEATHER_API_KEY = "6a8514078d38de2a2c4e4e1642fede5c";
const poiTypes = [
  {icon:"üöå", key:"bus", val:"yes", label:"Buszmeg√°ll√≥"},
  {icon:"üöã", key:"tram", val:"yes", label:"Villamosmeg√°ll√≥"},
  {icon:"üöá", key:"subway", val:"yes", label:"Metr√≥√°llom√°s"},
  {icon:"üöâ", key:"train", val:"yes", label:"Vas√∫t√°llom√°s"},
  {icon:"üöè", key:"public_transport", val:"platform", label:"K√∂z√∂ss√©gi meg√°ll√≥"},
  {icon:"üõí", key:"shop", val:"supermarket", label:"√âlelmiszer"},
  {icon:"üè™", key:"shop", val:"electronics", label:"M≈±szaki"},
  {icon:"‚òï", key:"amenity", val:"cafe", label:"K√°v√©z√≥"},
  {icon:"‚öΩ", key:"leisure", val:"pitch", label:"Sport"},
  {icon:"‚õΩ", key:"amenity", val:"fuel", label:"√územanyag"},
  {icon:"üÖøÔ∏è", key:"amenity", val:"parking", label:"Parkol√≥"},
  {icon:"üîã", key:"amenity", val:"charging_station", label:"T√∂lt≈ë"},
];

const demoPollen = [
  { city: "Budapest", ragweed: "magas", grass: "k√∂zepes", birch: "alacsony" },
  { city: "Sz√©kesfeh√©rv√°r", ragweed: "k√∂zepes", grass: "alacsony", birch: "nincs" },
  { city: "Debrecen", ragweed: "alacsony", grass: "alacsony", birch: "alacsony" },
  { city: "Miskolc", ragweed: "k√∂zepes", grass: "k√∂zepes", birch: "alacsony" }
];
function getDemoPollen(cityName) {
  const found = demoPollen.find(x => cityName && cityName.includes(x.city));
  return found || demoPollen[0];
}
function completeChallenge() {
  let count = Number(localStorage.getItem("eco_challenge") || 0) + 1;
  localStorage.setItem("eco_challenge", count);
  document.getElementById('challenge-status').textContent = count + " teljes√≠t√©s";
}
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('challenge-status').textContent =
    (localStorage.getItem("eco_challenge") || 0) + " teljes√≠t√©s";
});
function getPosition() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) reject("Nincs geolok√°ci√≥!");
    navigator.geolocation.getCurrentPosition(
      pos => resolve(pos.coords),
      err => reject(err)
    );
  });
}
async function getWeather(lat, lon) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=uv_index,visibility,relative_humidity_2m,windspeed_10m,precipitation_probability,precipitation,snowfall,weathercode,temperature_2m,pressure_msl&forecast_days=4&timezone=auto`;
  const res = await fetch(url);
  if (!res.ok) throw "Nem siker√ºlt lek√©rni az id≈ëj√°r√°st!";
  return await res.json();
}
async function getAirQuality(lat, lon) {
  const url = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}`;
  const res = await fetch(url);
  if (!res.ok) return null;
  const data = await res.json();
  if (!data.list || !data.list.length) return null;
  return data.list[0];
}
async function getCityName(lat, lon) {
  const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=hu`;
  const res = await fetch(url);
  if (!res.ok) return "";
  const data = await res.json();
  let name = data.address.village || data.address.town || data.address.city || data.address.hamlet || data.display_name || "";
  name = name.split(",")[0].trim(); // csak a f≈ë v√°rosn√©v, pl. "Sz√©kesfeh√©rv√°r"
  return name;
}

async function getWeatherWarning(cityName) {
  try {
    const url = "https://api.met.hu/idojaras/veszelyjelzes/megye.json";
    const res = await fetch(url);
    const data = await res.json();
    const countyNames = ["B√°cs-Kiskun","Baranya","B√©k√©s","Borsod-Aba√∫j-Zempl√©n","Csongr√°d-Csan√°d","Fej√©r","Gy≈ër-Moson-Sopron","Hajd√∫-Bihar","Heves","J√°sz-Nagykun-Szolnok","Kom√°rom-Esztergom","N√≥gr√°d","Pest","Somogy","Szabolcs-Szatm√°r-Bereg","Tolna","Vas","Veszpr√©m","Zala","Budapest"];
    let county = "";
    for (const name of countyNames) {
      if (cityName && cityName.includes(name)) { county = name; break; }
    }
    if (!county || !data.megye) return { warnings: [], county: "" };
    const c = data.megye.find(x => x.nev === county);
    if (!c || !c.fok || !c.fok.length) return { warnings: [], county };
    let warnings = c.fok.filter(x => x.szint > 0);
    return { warnings, county };
  } catch (e) { return { warnings: [], county: "" }; }
}
const szintTeendo = {
  1: "Figyelmeztet√©s: k√∂vesd az OMSZ tan√°csait.",
  2: "Narancs ‚Äì Fokozott vesz√©ly: ne tart√≥zkodj szabadban!",
  3: "Piros ‚Äì Extr√©m vesz√©ly: csak √©letv√©delmi okb√≥l menj ki, v√©dj mindent, amit tudsz!",
};
function warningIconAndText(jelzes) {
  if (!jelzes) return {icon:"",text:""};
  let txt = jelzes.toLowerCase();
  if (txt.includes("zivatar")) return {icon:"üå©Ô∏è", text:"Zivatar"};
  if (txt.includes("h≈ës√©g")) return {icon:"‚òÄÔ∏è", text:"H≈ës√©g"};
  if (txt.includes("sz√©l")) return {icon:"üí®", text:"Sz√©l"};
  if (txt.includes("j√©ges≈ë")) return {icon:"üßä", text:"J√©ges≈ë"};
  if (txt.includes("h√≥")) return {icon:"üå®Ô∏è", text:"H√≥"};
  if (txt.includes("k√∂d")) return {icon:"üå´Ô∏è", text:"K√∂d"};
  if (txt.includes("es≈ë")) return {icon:"üåßÔ∏è", text:"Es≈ë"};
  return {icon:"‚ö†Ô∏è", text:jelzes};
}
function warningLevelClass(szint) {
  if (szint == 3) return "eco-card warn-red";
  if (szint == 2) return "eco-card warn-orange";
  if (szint == 1) return "eco-card warn-yellow";
  return "eco-card warn-none";
}
function formatOszTime(t) {
  if (!t) return "";
  let d = t.split("T");
  if (!d[0] || !d[1]) return "";
  let dm = d[0].slice(5).replace("-",".") + ". " + d[1].slice(0,5);
  return dm;
}
async function fetchPOI(lat, lon) {
  const rad = 900;
  let parts = poiTypes.map(t => `node["${t.key}"="${t.val}"](around:${rad},${lat},${lon});`).join("");
  const query = `[out:json];(${parts});out body;`;
  try {
    const res = await fetch("https://overpass-api.de/api/interpreter", {method:"POST",body:query});
    const data = await res.json();
    return data.elements || [];
  } catch(e) {
    return [
      {lat:lat+0.0013,lon:lon-0.0017,tags:{shop:"supermarket"},id:1},
      {lat:lat-0.0009,lon:lon+0.0022,tags:{amenity:"cafe"},id:2},
      {lat:lat+0.0007,lon:lon+0.001,tags:{amenity:"charging_station"},id:3},
      {lat:lat-0.0005,lon:lon-0.0006,tags:{public_transport:"platform"},id:4}
    ];
  }
}

// === Kieg√©sz√≠t≈ë infopanelek ===
function updateSunTimesPanel(lat, lon) {
  getSunTimes(lat, lon).then(res => {
    document.getElementById('sun-times-panel').innerHTML =
      `üåÖ Napkelte: <b>${res.sunrise}</b> &nbsp;|&nbsp; üåá Napnyugta: <b>${res.sunset}</b>`;
  });
}
function updatePressurePanel(weather) {
  let p = "";
  let p8h = "";
  let idxNow = 0;
  let idx8h = 0;
  if (weather.hourly && weather.hourly.time && weather.hourly.pressure_msl) {
    idxNow = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
    idx8h = idxNow + 8;
    p = weather.hourly.pressure_msl[idxNow] || weather.current_weather.pressure_msl;
    p8h = weather.hourly.pressure_msl[idx8h];
  } else if (weather.current_weather && typeof weather.current_weather.pressure_msl === "number") {
    p = weather.current_weather.pressure_msl;
  }
  let txt = "";
  if (p) {
    txt = `‚è≥ L√©gnyom√°s: <b>${Math.round(p)} hPa</b>`;
    if (p < 1003) txt += " ‚Äì üåÄ Hidegfront (front√©rz√©kenyek figyelem!)";
    else if (p > 1020) txt += " ‚Äì üåû Melegfront (√°lmoss√°g, f√°radts√°g jelentkezhet)";
    else txt += " ‚Äì √Åtlagos l√©gnyom√°s";
  }
  if (p8h) {
    txt += "<br><span style='font-size:.97em'>8 √≥ra m√∫lva: <b>" + Math.round(p8h) + " hPa</b> ";
    if (p8h < 1003) txt += "‚Äì üåÄ Hidegfront v√°rhat√≥";
    else if (p8h > 1020) txt += "‚Äì üåû Melegfront v√°rhat√≥";
    else txt += "‚Äì √Åtlagos l√©gnyom√°s";
    txt += "</span>";
  }
  document.getElementById('pressure-panel').innerHTML = txt;
}

function updatePollenHourPanel(weather) {
  // "Pollen-√≥ra": fikt√≠v logika, amikor 24 fok felett, sz√°raz id≈ëben √©s napos UV>4, pollen rosszabb 12‚Äì16h
  let txt = "";
  let now = new Date(weather.current_weather.time);
  let hour = now.getHours();
  let uv = null, temp = weather.current_weather.temperature;
  if (weather.hourly && weather.hourly.uv_index && weather.hourly.time) {
    let idx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
    if(idx>=0) uv = weather.hourly.uv_index[idx];
  }
  if (temp > 22 && uv !== null && uv > 4 && hour >= 12 && hour <= 16) {
    txt = "üå∏ <b>Pollen-cs√∫csid≈ëszak:</b> Most k√ºl√∂n√∂sen magas! (12‚Äì16 √≥ra, UV er≈ës, sz√°raz meleg id≈ë)";
  } else if (uv !== null && uv > 4) {
    txt = "üå∏ <b>K√∂zepes pollenhelyzet:</b> Ker√ºld a hosszabb szabadt√©ri tart√≥zkod√°st, f≈ëleg d√©lt≈ël 16h-ig!";
  } else {
    txt = "üå∏ <b>Jelenleg nincs kiugr√≥ pollen-cs√∫csid≈ëszak.</b>";
  }
  document.getElementById('pollen-hour-panel').innerHTML = txt;
}
function updateJamPanel(trafficObj) {
  let html = "";
  if (trafficObj.local) html += "üöó <b>Helyi forgalmi helyzet:</b> " + trafficObj.local;
  if (trafficObj.regional) html += "<br>üõ£Ô∏è <b>60km k√∂rzet esem√©nyei:</b> " + trafficObj.regional;
  document.getElementById('jam-info-panel').innerHTML = html;
}



// === POI √©s MAP ===
let map, marker, circle, poiMarkers = [];
function initMap(lat, lon) {
  if (!map) {
    map = L.map('leafletmap').setView([lat, lon], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    marker = L.marker([lat, lon], {icon: L.icon({
      iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    })}).addTo(map).bindPopup("Itt vagy!").openPopup();
    circle = L.circle([lat, lon], {radius: 100, color: "#50ce90", fillOpacity:.12}).addTo(map);
  } else {
    marker.setLatLng([lat, lon]);
    circle.setLatLng([lat, lon]);
    map.setView([lat, lon], map.getZoom());
  }
  updatePOI(lat, lon);
}
async function updatePOI(lat, lon) {
  poiMarkers.forEach(p => map.removeLayer(p));
  poiMarkers = [];
  const pois = await fetchPOI(lat, lon);
  pois.forEach(node => {
    let icon = "‚ùì", typeLabel = "-";
    for (let t of poiTypes) if (node.tags[t.key] === t.val) { icon = t.icon; typeLabel = t.label; break; }
    // --- M√ºncheni meg√°ll√≥k: √©l≈ë MVV popup ---
    if (typeLabel === "Buszmeg√°ll√≥" && node.tags.name) {
      let stopName = node.tags.name || "";
      let m = L.marker([node.lat, node.lon], {
        icon: L.divIcon({className:"",html:`<span style="font-size:1.5em">üöè</span>`})
      }).addTo(map)
        .on('click', function() {
          showMunichStopDepartures(stopName, m);
        });
      poiMarkers.push(m);
    } else {
      let m = L.marker([node.lat, node.lon], {
        icon: L.divIcon({className:"",html:`<span style="font-size:1.5em">${icon}</span>`})
      }).addTo(map)
        .bindPopup(
          `${icon} <b>${node.tags.name||typeLabel}</b><br><span style="font-size:1em;">${typeLabel}</span>`
        );
      poiMarkers.push(m);
    }
  });
}

function liveFollowPosition() {
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      initMap(lat, lon);
    });
  }
}
document.getElementById("btnstreet").onclick = function() {
  if (marker && marker.getLatLng) {
    let lat = marker.getLatLng().lat, lon = marker.getLatLng().lng;
    window.open(`https://maps.google.com/?cbll=${lat},${lon}&layer=c`, "_blank");
  }
};
document.getElementById("btn2d").onclick = function() {
  if (marker && marker.getLatLng) {
    let lat = marker.getLatLng().lat, lon = marker.getLatLng().lng;
    initMap(lat, lon);
  }
};
// --- S√∂t√©t m√≥d ---
function setDarkMode(on) {
  document.body.classList.toggle('dark', on);
  localStorage.setItem("eco_darkmode", on ? "1":"0");
}
function autoDarkMode() {
  const now = new Date(), sunset = 20;
  setDarkMode(now.getHours() >= sunset || localStorage.getItem("eco_darkmode")==="1");
}
document.getElementById('darkmodeBtn').onclick = ()=>setDarkMode(!document.body.classList.contains('dark'));
setTimeout(autoDarkMode,300);
// --- MODAL/okos figyelmeztet√©s: pollen, UV, h≈ës√©g!
function showAlertModal(title, msg) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMsg').innerHTML = msg;
  document.getElementById('alertModal').style.display = "flex";
}

// --- √âl≈ë esem√©nyek: programturizmus.hu RSS ---
async function getEventsNearby(cityName) {
  const rssUrl = "https://www.programturizmus.hu/rss.xml";
  const proxy = "https://api.allorigins.win/get?url=";
  try {
    const res = await fetch(proxy + encodeURIComponent(rssUrl));
    const data = await res.json();
    const parser = new window.DOMParser();
    const xml = parser.parseFromString(data.contents, "text/xml");
    const items = xml.querySelectorAll("item");
    let events = [];
    // --- ITT kezdj√ºk a ciklust ---
    items.forEach(item => {
      const title = item.querySelector("title")?.textContent || "";
      const desc = item.querySelector("description")?.textContent || "";
      const link = item.querySelector("link")?.textContent || "";
      const city = cityName.toLowerCase();
      const cityAlt = city.replace(/[^a-zA-Z0-9]/g, ""); // √©kezet/space/karakter kisz≈±r√©se
      const titleNorm = title.toLowerCase().replace(/[^a-zA-Z0-9]/g, "");
      const descNorm = desc.toLowerCase().replace(/[^a-zA-Z0-9]/g, "");
      if (
        title.toLowerCase().includes(city) || desc.toLowerCase().includes(city) ||
        titleNorm.includes(cityAlt) || descNorm.includes(cityAlt)
      ) {
        events.push({title, desc, link});
      }
    });
    return events;
  } catch (e) {
    return [];
  }
}
async function loadEvents(cityName) {
  // Pr√≥b√°lj el≈ësz√∂r helyi esem√©nyt mutatni
  let events = await getEventsNearby(cityName);

  // Ha nincs tal√°lat, pr√≥b√°ld alternat√≠v v√°rosr√©szletekkel (pl. csak "feh√©rv√°r")
  if (!events.length && cityName.toLowerCase().includes("feh√©rv√°r")) {
    events = await getEventsNearby("feh√©rv√°r");
  }
  // M√©g mindig nincs? Akkor k√©rj le orsz√°gosat (√ºres keres≈ëvel)
  if (!events.length) {
    const allEvents = await getEventsNearby(""); // ez minden esem√©nyt visszaad
    document.getElementById("event-list").innerHTML =
      "<b>Orsz√°gos esem√©nyek:</b><br>" +
      allEvents.slice(0, 3).map(ev =>
        `<div>üéâ <b>${ev.title}</b><br>
          <span style="font-size:.98em;color:#36826a">${ev.desc}</span><br>
          <a href="${ev.link}" target="_blank" style="font-size:.93em;">R√©szletek</a>
        </div>`
      ).join("<hr>");
    return;
  }
  // Helyi tal√°latok
  document.getElementById("event-list").innerHTML = events.map(ev =>
    `<div>üéâ <b>${ev.title}</b><br>
      <span style="font-size:.98em;color:#36826a">${ev.desc}</span><br>
      <a href="${ev.link}" target="_blank" style="font-size:.93em;">R√©szletek</a>
    </div>`
  ).join("<hr>");
}


// --- 4 napos id≈ëj√°r√°s panel ---
function renderForecast(weather) {
  const w = weather;
  let res = '';
  for (let d = 0; d < 4; d++) {
    if (!w.hourly.time[d * 24]) break;
    let minTemp = 99, minIdx = -1;
    for (let h = d * 24; h < d * 24 + 9; h++) {
      if (w.hourly.temperature_2m && w.hourly.temperature_2m[h] !== undefined) {
        if (w.hourly.temperature_2m[h] < minTemp) {
          minTemp = w.hourly.temperature_2m[h];
          minIdx = h;
        }
      }
    }
    let maxTemp = -99, maxIdx = -1;
    for (let h = d * 24 + 13; h < d * 24 + 20; h++) {
      if (w.hourly.temperature_2m && w.hourly.temperature_2m[h] !== undefined) {
        if (w.hourly.temperature_2m[h] > maxTemp) {
          maxTemp = w.hourly.temperature_2m[h];
          maxIdx = h;
        }
      }
    }
    let date = w.hourly.time[d * 24] ? new Date(w.hourly.time[d * 24]) : null;
    let day = date ? date.toLocaleDateString('hu-HU', { weekday: 'short' }) : "-";
    let code = w.hourly.weathercode[maxIdx];
    let icon = "‚òÄÔ∏è";
    if ([61,63,65,80,81,82].includes(code)) icon = "üåßÔ∏è";
    if ([71,73,75,85,86].includes(code)) icon = "üå®Ô∏è";
    if ([95,96,99].includes(code)) icon = "‚õàÔ∏è";
    if ([67,77].includes(code)) icon = "üßä";
    let minT = minTemp !== 99 ? Math.round(minTemp) + "¬∞C" : "-";
    let maxT = maxTemp !== -99 ? Math.round(maxTemp) + "¬∞C" : "-";
    res += `<div class="forecast-day">
      <div class="day">${day}</div>
      <div class="icon">${icon}</div>
      <div class="temp"><span style="color:#19e58f">${minT}</span> / <b>${maxT}</b></div>
    </div>`;
  }
  document.getElementById('forecast-panel').innerHTML = res;
}

// --- AI √∂sszegz√©s, ‚ÄúIndulj vagy v√°rj!‚Äù, √∂lt√∂z√©k, csapad√©k, minden --- 
function generateAISuggestion(weather, uv, air, atm, trafficMsg) {
  let msg = "";

  // --- Id≈ëj√°r√°s (k√∂zelj√∂v≈ë, 0-60 perc) ---
  if (weather.hourly && weather.hourly.weathercode && weather.hourly.time) {
    let nowIdx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
    let found = false;
    for (let i = nowIdx+1; i < weather.hourly.time.length && i <= nowIdx+2; i++) {
      if (!weather.hourly.weathercode[i]) continue;
      let code = weather.hourly.weathercode[i], type = "";
      if ([61,63,65,80,81,82].includes(code)) type = "es≈ë";
      else if ([95,96,99].includes(code)) type = "zivatar";
      else if ([67,77].includes(code)) type = "j√©ges≈ë";
      else if ([71,73,75,85,86].includes(code)) type = "havaz√°s";
      else if ([51,53,55,56,57].includes(code)) type = "szit√°l√°s";
      else if ([3,45,48].includes(code)) type = "k√∂d";
      else if ([2].includes(code)) type = "felh≈ës";
      if (type) {
        let dt = new Date(weather.hourly.time[i]);
        let now = new Date(weather.current_weather.time);
        let min = Math.round((dt-now)/1000/60);
        if (min > 0 && min <= 60) {
          msg += `‚ö° <b>${type.charAt(0).toUpperCase()+type.slice(1)} v√°rhat√≥ kb. ${min} perc m√∫lva!</b> `;
          found = true; break;
        }
      }
    }
    if (!found) msg += "";
  }
  if (weather.current_weather && weather.current_weather.precipitation > 0) {
    msg += "Jelenleg is csapad√©k van, ";
  }
  if (uv !== null && uv >= 6) msg += "er≈ës UV, haszn√°lj f√©nyv√©d≈ët, ";
  if (atm && atm.wind >= 35) msg += `<b>Viharos sz√©l (${atm.wind} km/h)!</b> `;
  else if (atm && atm.wind >= 18) msg += `er≈ës sz√©l (${atm.wind} km/h), `;
  if (atm && atm.visibility < 7) msg += `l√°t√≥t√°vols√°g: ${atm.visibility} km, `;
  if (atm && atm.humidity > 80) msg += `magas p√°ratartalom (${atm.humidity}%). `;
  if (air && air.components && air.components.pm2_5 < 18) {
    msg += "J√≥ a leveg≈ëmin≈ës√©g ‚Äì ide√°lis a ker√©kp√°roz√°shoz!";
  } else if (air && air.components) {
    msg += `A leveg≈ëmin≈ës√©g k√∂zepes/szennyezett (PM2.5: ${air.components.pm2_5} ¬µg/m¬≥), ink√°bb ne fuss a szabadban.`;
  } else {
    msg += "Nincs el√©rhet≈ë adat a leveg≈ëmin≈ës√©gr≈ël.";
  }

  // --- H≈ë√©rzet √©s √∂lt√∂z√©k javaslat ---
  if (weather && weather.current_weather && typeof weather.current_weather.temperature === 'number') {
    const t = weather.current_weather.temperature;
    let dress = "";
    if (t >= 29) dress = "K√∂nny≈± ny√°ri ruha, sapka, sok folyad√©k!";
    else if (t >= 22) dress = "R√∂vid ujj√∫ p√≥l√≥, k√∂nny≈± nadr√°g aj√°nlott.";
    else if (t >= 17) dress = "Hossz√∫ ujj√∫ p√≥l√≥, v√©kony pul√≥ver.";
    else if (t >= 12) dress = "K√∂nny≈± dzseki, r√©teges √∂lt√∂zet.";
    else if (t >= 5) dress = "Melegebb kab√°t, pul√≥ver, s√°l.";
    else if (t >= -3) dress = "T√©li kab√°t, sapka, s√°l, keszty≈±!";
    else dress = "Extr√©m hideg! Vastag, r√©teges t√©li √∂lt√∂zet, sapka, s√°l, keszty≈± k√∂telez≈ë!";
    msg += `<br><b>√ñlt√∂z√©k tipp:</b> ${dress}`;
    if (atm && atm.wind > 18) msg += " (Er≈ës sz√©l miatt hidegebbnek √©rz≈ëdik!)";
    if (atm && atm.humidity > 85 && t > 18) msg += " (Magas p√°ratartalom miatt f√ºlledtebbnek √©rz≈ëdik.)";
  }

  // --- Csapad√©k inf√≥ ---
  const rainSum = calcTodayRainSum(weather);
  if (rainSum > 0) msg += `<br><b>Mai v√°rhat√≥ csapad√©k:</b> ${rainSum} mm`;

  const rainEnd = estimateRainEnd(weather);
  if (weather.current_weather.precipitation > 0 && rainEnd) {
    msg += `<br><b>V√°rhat√≥an m√©g ~${rainEnd} percig esik az es≈ë.</b>`;
  }

  // --- AI k√∂zleked√©si tan√°cs ---
  const aiTanacs = aiIndulasiTanacs(weather);
  if (aiTanacs) msg += `<br><b>K√∂zleked√©si tipp:</b> ${aiTanacs}`;

  // --- Forgalmi inf√≥, ha van ---
  if (trafficMsg) msg += `<br>üö¶ <b>${trafficMsg}</b>`;

  return msg;
}

// --- Csapad√©k √∂sszege √©s becs√ºlt v√©g√©ig tart√≥ id≈ë ---
function calcTodayRainSum(weather) {
  if (!weather.hourly || !weather.hourly.precipitation || !weather.hourly.time) return "-";
  let sum = 0;
  let todayStr = new Date().toISOString().slice(0,10); // "2025-09-05"
  for (let i = 0; i < weather.hourly.time.length; i++) {
    if (weather.hourly.time[i].startsWith(todayStr)) {
      sum += weather.hourly.precipitation[i] || 0;
    }
  }
  return sum.toFixed(1);
}
function estimateRainEnd(weather) {
  if (!weather.hourly || !weather.hourly.precipitation || !weather.hourly.time) return "";
  let now = new Date(weather.current_weather.time);
  let rainEndMin = null;
  for (let i = 0; i < weather.hourly.time.length; i++) {
    let t = new Date(weather.hourly.time[i]);
    if (t < now) continue;
    if (weather.hourly.precipitation[i] > 0) {
      rainEndMin = Math.round((t - now) / 60000);
    } else if (rainEndMin !== null) {
      return rainEndMin + 60;
    }
  }
  return rainEndMin ? (rainEndMin + 60) : null;
}
function aiIndulasiTanacs(weather) {
  if (!weather || !weather.hourly || !weather.hourly.precipitation || !weather.hourly.time || !weather.current_weather) return "";
  let now = new Date(weather.current_weather.time);
  let rainNow = weather.current_weather.precipitation > 0;
  let firstRainFreeMinute = null;
  let rainContinuesMin = null;
  for (let i = 0; i < weather.hourly.time.length; i++) {
    let t = new Date(weather.hourly.time[i]);
    if (t < now) continue;
    if (weather.hourly.precipitation[i] > 0) {
      rainContinuesMin = Math.round((t - now) / 60000);
    } else if (rainNow) {
      firstRainFreeMinute = Math.round((t - now) / 60000);
      break;
    }
  }
  if (!rainNow) {
    let leszEsik = false;
    for (let i = 0; i < 4; i++) {
      if (weather.hourly.precipitation[i] > 0) { leszEsik = true; break; }
    }
    if (leszEsik) return "Most ide√°lis elindulni, de az es≈ë 1 √≥r√°n bel√ºl v√°rhat√≥!";
    return "Most ide√°lis elindulni, a k√∂vetkez≈ë √≥r√°ban nem v√°rhat√≥ es≈ë.";
  } else {
    if (firstRainFreeMinute !== null && firstRainFreeMinute < 60)
      return `Most nem javasolt elindulni, ${firstRainFreeMinute} perc m√∫lva v√°rhat√≥an el√°ll az es≈ë.`;
    if (rainContinuesMin && rainContinuesMin > 60)
      return `Az es≈ë m√©g legal√°bb 1 √≥r√°ig folytat√≥dik, k√©sz√ºlj fel!`;
    return "Most esik az es≈ë, n√©zd meg az aktu√°lis radart!";
  }
}

// --- F≈ê LOGIKA, minden bet√∂lt√©se, infopanelek update ---
async function loadEcoData() {
  try {
    const coords = await getPosition();
  //  const coords = {latitude: 47.4979, longitude: 19.0402}; // Budapest
    const lat = coords.latitude, lon = coords.longitude;
    document.getElementById('city').textContent = "Bet√∂lt√©s‚Ä¶";
    const cityName = await getCityName(lat, lon);
    document.getElementById('city').textContent = cityName ? cityName : `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    document.getElementById('weather').textContent = "Bet√∂lt√©s‚Ä¶";
    document.getElementById('uv').textContent = "Bet√∂lt√©s‚Ä¶";
    const weather = await getWeather(lat, lon);
    document.getElementById('weather').textContent =
      `${Math.round(weather.current_weather.temperature)}¬∞C, ` +
      (weather.current_weather.precipitation > 0 ? "es≈ë v√°rhat√≥" : "nincs csapad√©k");
    let uvNow = null;
    if(weather.hourly && weather.hourly.uv_index && weather.hourly.time){
      let idx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
      if(idx>=0) uvNow = weather.hourly.uv_index[idx];
    }
    document.getElementById('uv').textContent = uvNow !== null ? uvNow.toFixed(1)+" (max 11)" : "Nincs adat";
    let atmNow = {visibility:0,humidity:0,wind:0};
    if(weather.hourly && weather.hourly.visibility && weather.hourly.time){
      let idx = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
      if(idx>=0) {
        atmNow.visibility = Math.round((weather.hourly.visibility[idx]||0)/1000);
        atmNow.humidity = weather.hourly.relative_humidity_2m ? Math.round(weather.hourly.relative_humidity_2m[idx]||0) : 0;
        atmNow.wind = weather.hourly.windspeed_10m ? Math.round(weather.hourly.windspeed_10m[idx]||0) : 0;
      }
    }
    document.getElementById('atm-panel').innerHTML = `L√°t√≥t√°vols√°g: <b>${atmNow.visibility} km</b>, P√°ratartalom: <b>${atmNow.humidity}%</b>, Sz√©l: <b>${atmNow.wind} km/h</b>`;
    document.getElementById('air-quality').textContent = "Bet√∂lt√©s‚Ä¶";
    let airData = await getAirQuality(lat, lon);
    if (airData && airData.components) {
      let pm = airData.components.pm2_5;
      let status = "J√≥";
      if (pm >= 35) status = "Szennyezett";
      else if (pm >= 18) status = "K√∂zepes";
      document.getElementById('air-quality').textContent =
        `"${status}" (PM2.5: ${pm} ¬µg/m¬≥)`;
      document.getElementById('air-components').innerHTML =
        `<span class="badge pm10">PM10: ${airData.components.pm10} ¬µg/m¬≥</span>` +
        `<span class="badge no2">NO‚ÇÇ: ${airData.components.no2} ¬µg/m¬≥</span>` +
        `<span class="badge o3">O‚ÇÉ: ${airData.components.o3} ¬µg/m¬≥</span>` +
        `<span class="badge co">CO: ${airData.components.co} ¬µg/m¬≥</span>`;
    } else {
      document.getElementById('air-quality').textContent =
        "Nincs el√©rhet≈ë adat a leveg≈ëmin≈ës√©gr≈ël!";
      document.getElementById('air-components').textContent = "";
    }
    const pollen = getDemoPollen(cityName || "");
    document.getElementById('pollen-panel').innerHTML =
      `Parlagf≈±: <b>${pollen.ragweed}</b>, F≈±f√©l√©k: <b>${pollen.grass}</b>, Ny√≠rfa: <b>${pollen.birch}</b>`;

    // --- Riaszt√°s logika ---
    let ww = {warnings:[]};
    try {
      ww = await getWeatherWarning(cityName);
    } catch (err) {
      // ha az OMSZ API nem el√©rhet≈ë, "√ºres" riaszt√°st adunk vissza, a program NE √°lljon le
      ww = {warnings:[]};
    }
    const warnPanel = document.getElementById('weather-warning-card');
    const warnDiv = document.getElementById('weather-warning-details');
    if (!ww.warnings.length) {
      warnPanel.className = "eco-card warn-none";
      warnDiv.innerHTML = `<span class="warn-icon">‚úÖ</span> <b>Nincs riaszt√°s.</b>`;
    } else {
      warnPanel.className = warningLevelClass(Math.max(...ww.warnings.map(w=>w.szint)));
      warnDiv.innerHTML = ww.warnings.map(w=>{
        const iconAndText = warningIconAndText(w.jelzes);
        let timeInfo = w.kezdete ? `<span class="warn-time">${formatOszTime(w.kezdete)} - ${formatOszTime(w.vege)}</span>` : '';
        let teendo = szintTeendo[w.szint] || "";
        return `<span class="warn-icon">${iconAndText.icon}</span> <b>${iconAndText.text}</b> (szint: <b>${w.szint}</b>)${timeInfo}<br><b>${teendo}</b>`;
      }).join("<hr style='border:none;border-top:1px solid #eee;margin:6px 0;>");
    }
    if (uvNow && uvNow >= 7)
  showAlertModal("Extr√©m UV!","Nagyon er≈ës UV-sug√°rz√°s, ker√ºld a t≈±z≈ë napot 11-15h k√∂z√∂tt! F√©nyv√©delem sz√ºks√©ges.");

if (weather.current_weather.temperature >= 33)
  showAlertModal("H≈ës√©griaszt√°s","Rendk√≠v√ºl magas h≈ëm√©rs√©klet, figyelj a folyad√©kbevitelre √©s √°rny√©kban tart√≥zkodj!");


// --- Forgalmi inform√°ci√≥ (helyi √©s 60 km-es k√∂rzet) ---
let trafficObj = await getUtinform(cityName);
let localMsg = trafficObj.city && trafficObj.city.length ? trafficObj.city.map(x => x.title + ": " + x.desc).join("<br>") : "Nincs helyi inform√°ci√≥.";
let around60kmMsg = trafficObj.county && trafficObj.county.length ? trafficObj.county.map(x => x.title + ": " + x.desc).join("<br>") : "Nincs esem√©ny a k√∂rzetben.";
trafficObj = { local: localMsg, around60km: around60kmMsg };

// --- Parlagf≈± pollen figyelmeztet√©s panel ---
if (pollen.ragweed === "magas") {
  document.getElementById('ragweed-alert-panel').innerHTML =
    "üåø <b>Magas a parlagf≈± pollen koncentr√°ci√≥.</b> Allergi√°soknak fokozott √≥vatoss√°g!";
  document.getElementById('ragweed-alert-panel').style.background = "#ffe6e6";
  document.getElementById('ragweed-alert-panel').style.color = "#b51616";
  document.getElementById('ragweed-alert-panel').style.display = "block";
} else {
  document.getElementById('ragweed-alert-panel').innerHTML = "";
  document.getElementById('ragweed-alert-panel').style.display = "none";
}


// --- Front inform√°ci√≥ gener√°l√°sa a legpontosabb m√≥don (nyom√°s alapj√°n) ---
let frontBox = "";
let p = "";
let p8h = "";
let idxNow = 0;
let idx8h = 0;
if (weather.hourly && weather.hourly.time && weather.hourly.pressure_msl) {
  idxNow = weather.hourly.time.findIndex(x=>x.startsWith(weather.current_weather.time.slice(0,13)));
  idx8h = idxNow + 8;
  p = weather.hourly.pressure_msl[idxNow] || weather.current_weather.pressure_msl;
  p8h = weather.hourly.pressure_msl[idx8h];
} else if (weather.current_weather && typeof weather.current_weather.pressure_msl === "number") {
  p = weather.current_weather.pressure_msl;
}

let frontType = "";
let symptoms = "";
let idoszak = "";
if (p) {
  // Ha a MOST vagy a 8 √≥r√°val k√©s≈ëbbi √©rt√©k b√°rmelyike frontos, legyen panel!
  if (p < 1003 || (p8h && p8h < 1003)) {
    frontType = "üåÄ Hidegfront";
    symptoms = "Gyakori t√ºnet: fejf√°j√°s, migr√©n, v√©rnyom√°s-ingadoz√°s, √≠z√ºleti panaszok.";
    if (p8h && p8h < 1003)
      idoszak = "<br><span style='font-size:.97em;font-weight:400;'>8 √≥ra m√∫lva hidegfront √©rkezhet.</span>";
  }
  else if (p > 1020 || (p8h && p8h > 1020)) {
    frontType = "üåû Melegfront";
    symptoms = "Gyakori t√ºnet: migr√©n, √°lmoss√°g, b√°gyadts√°g, ingerl√©kenys√©g.";
    if (p8h && p8h > 1020)
      idoszak = "<br><span style='font-size:.97em;font-weight:400;'>8 √≥ra m√∫lva melegfront v√°rhat√≥.</span>";
  }
  else {
    frontType = "Nincs front";
    symptoms = "Front√©rz√©kenyek ma v√°rhat√≥an nyugodtabb napra sz√°m√≠thatnak.";
  }
}

if (frontType && frontType !== "Nincs front") {
  frontBox = `<div style="background:#e4f1fe;padding:8px 10px 8px 15px;margin-bottom:8px;border-radius:11px;font-size:1.02em;font-weight:600;color:#234b69;">
    ${frontType} ${idoszak}<br>
    <span style="font-weight:400">${symptoms}</span>
  </div>`;
} else if (frontType === "Nincs front") {
  frontBox = `<div style="background:#e6fbe4;padding:8px 10px 8px 15px;margin-bottom:8px;border-radius:11px;font-size:1.01em;font-weight:500;color:#198944;">
    ${frontType}<br>
    <span style="font-weight:400">${symptoms}</span>
  </div>`;
}


 // --- AI panel gener√°l√°sa ---
  const aiSug = document.getElementById('ai-suggestion');
  if (aiSug && aiSug.children[1]) {
    aiSug.children[1].innerHTML =
      frontBox +
      `<strong>AI aj√°nlatod m√°ra:</strong><br>` +
      generateAISuggestion(weather, uvNow, airData, atmNow, 
  trafficObj.local + "<br>" + trafficObj.around60km)
  } else if (aiSug) {
    aiSug.children[1].innerHTML =
  frontBox +
  `<strong>AI aj√°nlatod m√°ra:</strong><br>` +
  generateAISuggestion(weather, uvNow, airData, atmNow, 
  trafficObj.local + "<br>" + trafficObj.around60km)

  }
  


// ... (panelek update, t√©rk√©pek, minden egy√©b)
  updateSunTimesPanel(lat, lon);
  updatePressurePanel(weather);
  updatePollenHourPanel(weather);
  updateClothingBlock(weather);
  updateJamPanel(trafficObj.local, trafficObj.around60km);
  initMap(lat, lon);
  liveFollowPosition();
  loadEvents(cityName);
  renderForecast(weather);


  } catch (e) {
  // --- Hibakezel√©s: minden elemre csak akkor √≠rjunk, ha l√©tezik ---
  const aiSug = document.getElementById('ai-suggestion');
if (aiSug && aiSug.children[1] && aiSug.children[1].tagName === 'SPAN') {
  aiSug.children[1].innerHTML =
    frontBox +
    `<strong>AI aj√°nlatod m√°ra:</strong><br>` +
    generateAISuggestion(weather, uvNow, airData, atmNow, trafficObj.local + "<br>" + trafficObj.around60km);
} else if (aiSug) {
  // V√©gs≈ë fallback: √≠rja ki az eg√©sz dobozt, SVG-vel egy√ºtt (ritka, csak els≈ë t√∂lt√©sn√©l fordulhat el≈ë)
  aiSug.innerHTML =
    `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 16v-4M12 8h.01" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span>` +
    frontBox +
    `<strong>AI aj√°nlatod m√°ra:</strong><br>` +
    generateAISuggestion(weather, uvNow, airData, atmNow, trafficObj.local + "<br>" + trafficObj.around60km) +
    `</span>`;
}

  const weatherPanel = document.getElementById('weather');
  if (weatherPanel) weatherPanel.textContent = "Nincs √©l≈ë adat.";
  const cityPanel = document.getElementById('city');
  if (cityPanel) cityPanel.textContent = "";
  const uvPanel = document.getElementById('uv');
  if (uvPanel) uvPanel.textContent = "";
  const atmPanel = document.getElementById('atm-panel');
  if (atmPanel) atmPanel.textContent = "";
  const airQuality = document.getElementById('air-quality');
  if (airQuality) airQuality.textContent = "";
  const airComponents = document.getElementById('air-components');
  if (airComponents) airComponents.textContent = "";
  const pollenPanel = document.getElementById('pollen-panel');
  if (pollenPanel) pollenPanel.textContent = "";
  const weatherWarn = document.getElementById('weather-warning-details');
  if (weatherWarn) weatherWarn.textContent = "";
  const trafficInfo = document.getElementById('traffic-info');
  if (trafficInfo) {
    trafficInfo.textContent = "";
    trafficInfo.innerHTML = "üö¶ <b>Forgalmi inform√°ci√≥:</b> Nincs adat";
  }
}
}

// --- Waze iframe automatikus poz√≠ci√≥ ---
// Ez mindig a te aktu√°lis poz√≠ci√≥dat mutatja a waze t√©rk√©pen!
function updateWazeIframe(lat, lon) {
  const zoom = 11;
  const src = `https://embed.waze.com/iframe?zoom=${zoom}&lat=${lat}&lon=${lon}`;
  document.getElementById('wazeFrame').src = src;
}
getPosition().then(coords => {
  updateWazeIframe(coords.latitude, coords.longitude);
});
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    updateWazeIframe(pos.coords.latitude, pos.coords.longitude);
  });
}


window.onload = loadEcoData;
setInterval(loadEcoData, 60000); // 1 percenk√©nt √∫jra friss√≠t


let recognizing = false;
let recognition;
let targetLang = "en";

// --- Z√°szl√≥ gombok kezel√©se a FORD√çT√ì panelhez ---
document.querySelectorAll('.flagBtn').forEach(btn => {
  btn.onclick = function() {
    document.querySelectorAll('.flagBtn').forEach(b => b.classList.remove('selected'));
    this.classList.add('selected');
    targetLang = this.dataset.lang;
  }
});
document.querySelector('.flagBtn[data-lang="en"]')?.classList.add('selected');

// --- Mikrofon logika ---
const micBtn = document.getElementById('micBtn');
if (micBtn) {
  micBtn.onclick = function() {
    if (!recognition) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.interimResults = false;
      recognition.continuous = false; // csak egy mondat
      recognition.lang = "hu-HU";     // mindig magyar!
      recognition.onresult = function(event) {
        const text = Array.from(event.results).map(r => r[0].transcript).join(' ').trim();
        document.getElementById('speechResult').textContent = text;
        const manualInput = document.getElementById('manualInput');
        if (manualInput) manualInput.value = text; // <-- ide is bem√°solja
      };
      recognition.onerror = function(event) {
        document.getElementById('speechResult').textContent = "Hiba: " + event.error;
        micBtn.classList.remove('active');
        recognizing = false;
      };
      recognition.onend = function() {
        micBtn.classList.remove('active');
        recognizing = false;
      };
    }
    if (!recognizing) {
      recognition.start();
      recognizing = true;
      this.classList.add('active');
      document.getElementById('speechResult').textContent = "Besz√©lj most... (magyar)";
    } else {
      recognition.stop();
      recognizing = false;
      this.classList.remove('active');
    }
  };
}

// --- Ford√≠t√≥ gomb ---
const translateBtn = document.getElementById('translateBtn');
if (translateBtn) {
  translateBtn.onclick = async function() {
    const text = document.getElementById('manualInput')?.value || "";
    document.getElementById('translateResult').textContent = "Ford√≠t√°s...";
    const translation = await translateWithLibre(text, targetLang, "auto");
    document.getElementById('translateResult').textContent = translation;
  };
}

// --- Ford√≠t√°s (LibreTranslate API) ---
async function translateWithLibre(text, targetLang = "en", sourceLang = "auto") {
  if (!text.trim()) return "";
  try {
    const res = await fetch("https://libretranslate.de/translate", {
      method: "POST",
      body: JSON.stringify({
        q: text,
        source: sourceLang,
        target: targetLang,
        format: "text"
      }),
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json();
    return data.translatedText || "[Nincs ford√≠t√°s]";
  } catch (e) {
    return "[Ford√≠t√°si hiba]";
  }
}


</script>
</body>
</html>
